<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Dò Từ Vựng Của Bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            /* Changed background to light purple */
            @apply bg-purple-50 text-gray-800;
        }
        /* Hide sections by default, show only active one */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }
        /* Active navigation link style */
        .active-nav-link {
            @apply bg-gray-700;
        }
        /* Style for multi-select checkboxes */
        .multi-select-option {
            @apply block p-2 rounded-md hover:bg-purple-100 cursor-pointer;
        }
        .multi-select-option input[type="checkbox"] {
            @apply mr-2;
        }
        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            visibility: hidden;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: relative;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #4b5563;
        }
        .modal-close-btn:hover {
            color: #1f2937;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 shadow-lg">
        <div class="container mx-auto text-center">
            <h1 class="text-4xl font-bold mb-2">Trang Web Dò Từ Vựng Của Bạn</h1>
            <p class="text-xl opacity-90">Học, quản lý và kiểm tra từ vựng theo chủ đề!</p>
        </div>
    </header>
    <nav class="bg-gray-800 text-white shadow-md">
        <ul class="container mx-auto flex justify-center py-3">
            <li><a href="#topics-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md active-nav-link">Chủ Đề</a></li>
            <li><a href="#vocabulary-management-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Quản Lý Từ Vựng</a></li>
            <li><a href="#quiz-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Kiểm Tra</a></li>
            <li><a href="#performance-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Hiệu Suất Học Tập</a></li>
        </ul>
    </nav>
    <main class="container mx-auto mt-8 p-6 bg-white rounded-lg shadow-xl flex-grow">
        <div id="generalMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <section id="topics-section" class="section active">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Chủ Đề</h2>
            <div class="bg-purple-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Thêm Chủ Đề Con Mới</h3>
                <form id="addTopicForm" class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="parentCategorySelect" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                        <select id="parentCategorySelect"
                                class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </select>
                    </div>
                    <div class="flex-grow w-full">
                        <label for="newTopicName" class="block text-gray-700 text-sm font-bold mb-2">Tên Chủ Đề Con:</label>
                        <input type="text" id="newTopicName" placeholder="Ví dụ: Level 1, Idioms"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <button type="submit"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Thêm Chủ Đề
                    </button>
                </form>
            </div>
            <h3 class="text-2xl font-medium text-purple-600 mb-4">Các Chủ Đề Hiện Có</h3>
            <div id="categoriesList" class="space-y-8">
                <p class="text-gray-500 text-center col-span-full">Đang tải chủ đề...</p>
            </div>
        </section>

        <section id="vocabulary-management-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Từ Vựng</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </select>
                </div>
                <div>
                    <label for="selectTopicForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con:</label>
                    <select id="selectTopicForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>
                    </select>
                </div>
            </div>
            <div id="vocabContent" class="hidden">
                <div class="bg-green-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-green-700 mb-4">Thêm Từ Vựng Riêng Lẻ</h3>
                    <form id="addSingleVocabForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="englishWord" class="block text-gray-700 text-sm font-bold mb-2">Từ Tiếng Anh:</label>
                            <input type="text" id="englishWord" placeholder="Ví dụ: beautiful"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="vietnameseMeaning" class="block text-gray-700 text-sm font-bold mb-2">Nghĩa Tiếng Việt (phân tách bằng dấu phẩy):</label>
                            <input type="text" id="vietnameseMeaning" placeholder="Ví dụ: đẹp, xinh đẹp"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="exampleSentence" class="block text-gray-700 text-sm font-bold mb-2">Ví Dụ Câu (tùy chọn):</label>
                            <textarea id="exampleSentence" rows="2" placeholder="Ví dụ: She has a beautiful smile."
                                      class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>
                        <div class="md:col-span-2 text-right">
                            <button type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Thêm Từ
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-yellow-700 mb-4">Nhập Từ Vựng Hàng Loạt</h3>
                    <p class="text-gray-600 mb-4">Nhập mỗi từ trên một dòng theo định dạng: <code class="bg-gray-200 p-1 rounded">English Word - Vietnamese Meaning (phân tách bằng dấu phẩy) - Example Sentence (optional)</code></p>
                    <form id="bulkImportVocabForm">
                        <textarea id="bulkVocabInput" rows="8" placeholder="Ví dụ:apple - quả táo, táo tây - I like to eat an apple.book - cuốn sách - Read a good book.run - chạy - He can run fast."
                                  class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent mb-4"></textarea>
                        <div class="text-right">
                            <button type="submit"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Nhập Hàng Loạt
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-2xl font-medium text-purple-600 mb-4">Từ Vựng Trong Chủ Đề Này (<span id="currentVocabCount">0</span> từ)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Nghĩa Tiếng Việt</th>
                                <th class="py-3 px-6 text-left">Ví Dụ</th>
                                <th class="py-3 px-6 text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="currentTopicVocabTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="quiz-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Kiểm Tra Từ Vựng</h2>
            <div class="mb-6 bg-purple-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-medium text-purple-700 mb-4">Chọn Loại Bài Kiểm Tra</h3>
                <div class="flex flex-wrap items-center space-x-4 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="single" checked class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra theo Chủ đề</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="mixed" class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra ngẫu nhiên từ nhiều Chủ đề</span>
                    </label>
                </div>

                <div id="singleTopicQuizOptions">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="selectCategoryForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                            <select id="selectCategoryForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </select>
                        </div>
                        <div>
                            <label for="selectTopicForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Kiểm Tra:</label>
                            <select id="selectTopicForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="mixedTopicQuizOptions" class="hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chọn các Chủ Đề Con để ôn tập:</label>
                    <div id="multiTopicCheckboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 bg-white p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 col-span-full">Chưa có chủ đề nào để chọn.</p>
                    </div>
                </div>

                <div id="quizSettings" class="mt-6">
                    <h3 class="text-2xl font-medium text-purple-700 mb-4">Cài Đặt Bài Kiểm Tra</h3>
                    <div class="mb-4">
                        <label for="quizQuestionCount" class="block text-gray-700 text-sm font-bold mb-2">Số lượng câu hỏi:</label>
                        <input type="number" id="quizQuestionCount" value="5" min="1"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label for="quizTimeLimit" class="block text-gray-700 text-sm font-bold mb-2">Thời gian giới hạn mỗi từ (giây):</label>
                        <input type="number" id="quizTimeLimit" value="30" min="5"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hướng kiểm tra:</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="quizDirection" value="viet-to-eng" checked class="form-radio text-purple-600 h-5 w-5">
                                <span class="ml-2 text-gray-700">Việt - Anh</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="quizDirection" value="eng-to-viet" class="form-radio text-purple-600 h-5 w-5">
                                <span class="ml-2 text-gray-700">Anh - Việt</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="quizDirection" value="random" class="form-radio text-purple-600 h-5 w-5">
                                <span class="ml-2 text-gray-700">Ngẫu nhiên</span>
                            </label>
                        </div>
                    </div>
                    <button id="startQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Bắt Đầu Kiểm Tra
                    </button>
                </div>
            </div>

            <div id="quizArea" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xl font-semibold text-gray-700">
                        Câu hỏi <span id="currentQuestionNumber">1</span>/<span id="totalQuizQuestions">5</span>
                        <span class="ml-4 text-green-600">Đúng: <span id="quizCorrectCount">0</span></span>
                        <span class="ml-2 text-red-600">Sai: <span id="quizIncorrectCount">0</span></span>
                    </span>
                    <span class="text-2xl font-bold text-red-600" id="quizTimer">30</span>
                </div>
                <div class="text-center mb-8">
                    <p class="text-3xl font-bold text-purple-800 mb-4">
                        <span id="quizQuestion"></span>
                    </p>
                    <input type="text" id="englishAnswerInput" placeholder="Nhập đáp án của bạn..."
                           class="shadow appearance-none border rounded-lg w-full max-w-md py-4 px-6 text-gray-700 text-2xl leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center">
                </div>
                <div id="feedbackMessage" class="hidden text-center mt-4 text-lg font-semibold"></div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="submitAnswerBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Kiểm tra
                    </button>
                    <button id="nextQuestionBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md hidden">
                        Câu kế tiếp
                    </button>
                    <button id="endQuizBtn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Kết thúc
                    </button>
                </div>
            </div>

            <div id="quizResults" class="hidden bg-white p-8 rounded-lg shadow-lg mt-8">
                <h3 class="text-3xl font-semibold text-purple-700 mb-6 text-center">Kết Quả Kiểm Tra</h3>
                <div class="grid grid-cols-2 gap-4 text-xl mb-6">
                    <div class="text-center">
                        <p class="text-gray-600">Tổng số câu hỏi:</p>
                        <p class="text-purple-800 font-bold text-4xl" id="resultsTotalQuestions">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600">Điểm:</p>
                        <p class="text-green-600 font-bold text-4xl" id="resultsScore">0%</p>
                    </div>
                </div>
                <div class="text-center mb-6">
                    <p class="text-gray-600">Số câu đúng:</p>
                    <p class="text-green-600 font-bold text-3xl" id="resultsCorrect">0</p>
                </div>
                <div class="text-center mb-8">
                    <p class="text-gray-600">Số câu sai:</p>
                    <p class="text-red-600 font-bold text-3xl" id="resultsIncorrect">0</p>
                </div>

                <h4 class="text-2xl font-medium text-purple-600 mb-4">Các Từ Cần Ôn Tập Lại:</h4>
                <div id="wordsToReview" class="overflow-x-auto mb-6">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Nghĩa Đúng</th>
                                <th class="py-3 px-6 text-left">Câu Trả Lời Của Bạn</th>
                            </tr>
                        </thead>
                        <tbody id="wordsToReviewTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="3" class="py-4 text-center text-gray-500">Chúc mừng! Bạn đã trả lời đúng tất cả.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-center gap-4">
                    <button id="retakeQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Kiểm Tra Lại
                    </button>
                    <button id="newQuizBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Tạo Bài Kiểm Tra Mới
                    </button>
                </div>
            </div>
        </section>

        <section id="performance-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Hiệu Suất Học Tập</h2>
            <p class="text-gray-700">Tính năng này sẽ sớm ra mắt! Tại đây, bạn sẽ có thể theo dõi tiến độ học tập, xem các từ đã học, các từ cần ôn tập, và hiệu suất tổng thể của mình.</p>
            <div id="performanceContent" class="mt-6 bg-purple-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Thống Kê Tổng Quan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="text-lg text-gray-600">Tổng số Chủ đề:</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalTopicsStat">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="text-lg text-gray-600">Tổng số Từ vựng:</p>
                        <p class="text-3xl font-bold text-green-600" id="totalVocabStat">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="text-lg text-gray-600">Bài kiểm tra đã hoàn thành:</p>
                        <p class="text-3xl font-bold text-purple-600" id="completedQuizzesStat">0</p>
                    </div>
                </div>

                <h3 class="text-2xl font-medium text-purple-600 mt-8 mb-4">Hiệu suất theo Chủ đề</h3>
                <div id="topicPerformanceList" class="space-y-4">
                    <p class="text-gray-500 text-center">Chưa có dữ liệu hiệu suất để hiển thị.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-8 shadow-inner">
        <div class="container mx-auto text-center text-gray-400">
            <p>&copy; 2025 Trang Web Dò Từ Vựng Của Bạn. Mọi quyền được bảo lưu.</p>
            <p>Được thiết kế với Tailwind CSS.</p>
        </div>
    </footer>

    <div id="editTopicModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeModal('editTopicModal')">&times;</span>
            <h3 class="text-2xl font-semibold text-purple-700 mb-4">Chỉnh Sửa Chủ Đề</h3>
            <form id="editTopicForm">
                <input type="hidden" id="editTopicId">
                <div class="mb-4">
                    <label for="editParentCategorySelect" class="block text-gray-700 text-sm font-bold mb-2">Mục Lớn:</label>
                    <select id="editParentCategorySelect"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </select>
                </div>
                <div class="mb-4">
                    <label for="editTopicNameInput" class="block text-gray-700 text-sm font-bold mb-2">Tên Chủ Đề Con:</label>
                    <input type="text" id="editTopicNameInput"
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('editTopicModal')"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                        Hủy
                    </button>
                    <button type="submit"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                        Lưu Thay Đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editVocabModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeModal('editVocabModal')">&times;</span>
            <h3 class="text-2xl font-semibold text-green-700 mb-4">Chỉnh Sửa Từ Vựng</h3>
            <form id="editVocabForm">
                <input type="hidden" id="editVocabId">
                <div class="mb-4">
                    <label for="editEnglishWord" class="block text-gray-700 text-sm font-bold mb-2">Từ Tiếng Anh:</label>
                    <input type="text" id="editEnglishWord"
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="editVietnameseMeaning" class="block text-gray-700 text-sm font-bold mb-2">Nghĩa Tiếng Việt (phân tách bằng dấu phẩy):</label>
                    <input type="text" id="editVietnameseMeaning"
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="editExampleSentence" class="block text-gray-700 text-sm font-bold mb-2">Ví Dụ Câu (tùy chọn):</label>
                    <textarea id="editExampleSentence" rows="2"
                              class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('editVocabModal')"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                        Hủy
                    </button>
                    <button type="submit"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                        Lưu Thay Đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data storage (using localStorage for persistence)
        let categories = JSON.parse(localStorage.getItem('categories')) || {
            'Cơ bản': [],
            'Nâng cao': [],
            'Ngữ pháp': [],
            'Thành ngữ': []
        };
        let vocabularies = JSON.parse(localStorage.getItem('vocabularies')) || [];
        let quizResults = JSON.parse(localStorage.getItem('quizResults')) || [];

        // --- Helper Functions ---
        function saveToLocalStorage() {
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('vocabularies', JSON.stringify(vocabularies));
            localStorage.setItem('quizResults', JSON.stringify(quizResults));
        }

        function showMessage(message, type = 'info') {
            const generalMessage = document.getElementById('generalMessage');
            generalMessage.textContent = message;
            generalMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            generalMessage.classList.add('block');

            if (type === 'success') {
                generalMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                generalMessage.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'warning') {
                generalMessage.classList.add('bg-yellow-100', 'text-yellow-800');
            } else { // info
                generalMessage.classList.add('bg-blue-100', 'text-blue-800');
            }

            setTimeout(() => {
                generalMessage.classList.add('hidden');
            }, 5000);
        }

        function populateParentCategories(selectElementId, includeAllOption = false) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return; // Add a check to prevent errors if element doesn't exist yet

            selectElement.innerHTML = ''; // Clear existing options

            if (includeAllOption) {
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = '-- Chọn mục lớn --';
                selectElement.appendChild(allOption);
            }

            for (const categoryName in categories) {
                const option = document.createElement('option');
                option.value = categoryName;
                option.textContent = categoryName;
                selectElement.appendChild(option);
            }
        }

        function populateTopicsForCategory(categoryName, selectElementId, includePlaceholder = false, allowNoTopic = false) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return; // Add a check to prevent errors if element doesn't exist yet

            selectElement.innerHTML = ''; // Clear existing options

            if (includePlaceholder) {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = allowNoTopic ? '-- Chọn chủ đề con (tùy chọn) --' : '-- Chọn chủ đề con --';
                selectElement.appendChild(placeholderOption);
            }

            if (categories[categoryName]) {
                categories[categoryName].forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.name;
                    selectElement.appendChild(option);
                });
            }
        }

        function getTopicById(topicId) {
            for (const categoryName in categories) {
                const topic = categories[categoryName].find(t => t.id === topicId);
                if (topic) return topic;
            }
            return null;
        }

        function getCategoryNameByTopicId(topicId) {
            for (const categoryName in categories) {
                if (categories[categoryName].some(t => t.id === topicId)) {
                    return categoryName;
                }
            }
            return null;
        }

        function displayTopics() {
            const categoriesList = document.getElementById('categoriesList');
            if (!categoriesList) return;

            categoriesList.innerHTML = '';

            let hasAnyTopic = false;
            for (const categoryName in categories) {
                if (categories[categoryName] && categories[categoryName].length > 0) {
                    hasAnyTopic = true;
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-white p-6 rounded-lg shadow-md';
                    categoryDiv.innerHTML = `
                        <h4 class="text-xl font-semibold text-purple-700 mb-4">${categoryName}</h4>
                        <div class="space-y-3" id="topicList-${categoryName.replace(/\s/g, '_')}">
                            ${categories[categoryName].map(topic => `
                                <div class="flex justify-between items-center bg-purple-50 p-3 rounded-md shadow-sm">
                                    <span class="text-gray-800 font-medium">${topic.name}</span>
                                    <div>
                                        <button class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-md mr-2 edit-topic-btn" data-topic-id="${topic.id}">
                                            Chỉnh sửa
                                        </button>
                                        <button class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-md delete-topic-btn" data-topic-id="${topic.id}">
                                            Xóa
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    categoriesList.appendChild(categoryDiv);
                }
            }

            if (!hasAnyTopic) {
                categoriesList.innerHTML = '<p class="text-gray-500 text-center col-span-full">Chưa có chủ đề nào được tạo. Hãy thêm chủ đề mới!</p>';
            }

            attachTopicEventListeners();
        }

        function attachTopicEventListeners() {
            document.querySelectorAll('.edit-topic-btn').forEach(button => {
                button.onclick = (e) => openEditTopicModal(e.target.dataset.topicId);
            });
            document.querySelectorAll('.delete-topic-btn').forEach(button => {
                button.onclick = (e) => deleteTopic(e.target.dataset.topicId);
            });
        }

        function displayVocabularies(topicId) {
            const currentTopicVocabTableBody = document.getElementById('currentTopicVocabTableBody');
            const currentVocabCount = document.getElementById('currentVocabCount');
            if (!currentTopicVocabTableBody || !currentVocabCount) return;

            currentTopicVocabTableBody.innerHTML = '';
            const topicVocabs = vocabularies.filter(vocab => vocab.topicId === topicId);

            currentVocabCount.textContent = topicVocabs.length;

            if (topicVocabs.length === 0) {
                currentTopicVocabTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>';
                return;
            }

            topicVocabs.forEach(vocab => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${vocab.english}</td>
                    <td class="py-3 px-6 text-left">${vocab.vietnamese.join(', ')}</td>
                    <td class="py-3 px-6 text-left">${vocab.example || ''}</td>
                    <td class="py-3 px-6 text-center">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-md mr-2 edit-vocab-btn" data-vocab-id="${vocab.id}">
                            Chỉnh sửa
                        </button>
                        <button class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-md delete-vocab-btn" data-vocab-id="${vocab.id}">
                            Xóa
                        </button>
                    </td>
                `;
                currentTopicVocabTableBody.appendChild(row);
            });
            attachVocabEventListeners();
        }

        function attachVocabEventListeners() {
            document.querySelectorAll('.edit-vocab-btn').forEach(button => {
                button.onclick = (e) => openEditVocabModal(e.target.dataset.vocabId);
            });
            document.querySelectorAll('.delete-vocab-btn').forEach(button => {
                button.onclick = (e) => deleteVocabulary(e.target.dataset.vocabId);
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.remove('show');
        }

        // --- Modals ---
        function openEditTopicModal(topicId) {
            const topic = getTopicById(topicId);
            if (!topic) {
                showMessage('Không tìm thấy chủ đề để chỉnh sửa.', 'error');
                return;
            }

            const categoryName = getCategoryNameByTopicId(topicId);

            document.getElementById('editTopicId').value = topicId;
            document.getElementById('editTopicNameInput').value = topic.name;

            populateParentCategories('editParentCategorySelect', false);
            document.getElementById('editParentCategorySelect').value = categoryName;

            document.getElementById('editTopicModal')?.classList.add('show');
        }

        function openEditVocabModal(vocabId) {
            const vocab = vocabularies.find(v => v.id === vocabId);
            if (!vocab) {
                showMessage('Không tìm thấy từ vựng để chỉnh sửa.', 'error');
                return;
            }

            document.getElementById('editVocabId').value = vocabId;
            document.getElementById('editEnglishWord').value = vocab.english;
            document.getElementById('editVietnameseMeaning').value = vocab.vietnamese.join(', ');
            document.getElementById('editExampleSentence').value = vocab.example || '';

            document.getElementById('editVocabModal')?.classList.add('show');
        }

        // --- Category/Topic Management ---
        document.getElementById('addTopicForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const parentCategory = document.getElementById('parentCategorySelect').value;
            const newTopicName = document.getElementById('newTopicName').value.trim();

            if (!parentCategory) {
                showMessage('Vui lòng chọn một Mục Lớn.', 'warning');
                return;
            }
            if (!newTopicName) {
                showMessage('Vui lòng nhập tên chủ đề con.', 'warning');
                return;
            }

            if (categories[parentCategory].some(topic => topic.name.toLowerCase() === newTopicName.toLowerCase())) {
                showMessage(`Chủ đề "${newTopicName}" đã tồn tại trong mục "${parentCategory}".`, 'warning');
                return;
            }

            const newTopic = {
                id: `topic-${Date.now()}`,
                name: newTopicName
            };
            categories[parentCategory].push(newTopic);
            saveToLocalStorage();
            displayTopics();
            populateSelects();
            document.getElementById('newTopicName').value = '';
            showMessage(`Đã thêm chủ đề "${newTopicName}" vào mục "${parentCategory}".`, 'success');
        });

        document.getElementById('editTopicForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const topicId = document.getElementById('editTopicId').value;
            const newParentCategory = document.getElementById('editParentCategorySelect').value;
            const newTopicName = document.getElementById('editTopicNameInput').value.trim();

            if (!newTopicName) {
                showMessage('Tên chủ đề không được để trống.', 'warning');
                return;
            }

            let oldCategoryName = null;
            let oldTopicIndex = -1;

            for (const catName in categories) {
                const index = categories[catName].findIndex(t => t.id === topicId);
                if (index !== -1) {
                    oldCategoryName = catName;
                    oldTopicIndex = index;
                    break;
                }
            }

            if (oldTopicIndex === -1) {
                showMessage('Không tìm thấy chủ đề để cập nhật.', 'error');
                closeModal('editTopicModal');
                return;
            }

            if (categories[newParentCategory].some(topic => topic.name.toLowerCase() === newTopicName.toLowerCase() && topic.id !== topicId)) {
                showMessage(`Chủ đề "${newTopicName}" đã tồn tại trong mục "${newParentCategory}".`, 'warning');
                return;
            }

            const updatedTopic = { ...categories[oldCategoryName][oldTopicIndex], name: newTopicName };

            if (oldCategoryName !== newParentCategory) {
                categories[oldCategoryName].splice(oldTopicIndex, 1);
                categories[newParentCategory].push(updatedTopic);
            } else {
                categories[oldCategoryName][oldTopicIndex] = updatedTopic;
            }

            saveToLocalStorage();
            displayTopics();
            populateSelects();
            closeModal('editTopicModal');
            showMessage(`Chủ đề "${newTopicName}" đã được cập nhật.`, 'success');
        });

        function deleteTopic(topicId) {
            if (!confirm('Bạn có chắc chắn muốn xóa chủ đề này? Tất cả từ vựng trong chủ đề này cũng sẽ bị xóa!')) {
                return;
            }

            let found = false;
            for (const categoryName in categories) {
                const initialLength = categories[categoryName].length;
                categories[categoryName] = categories[categoryName].filter(topic => topic.id !== topicId);
                if (categories[categoryName].length < initialLength) {
                    found = true;
                    break;
                }
            }

            if (found) {
                vocabularies = vocabularies.filter(vocab => vocab.topicId !== topicId);
                saveToLocalStorage();
                displayTopics();
                populateSelects();
                showMessage('Chủ đề và tất cả từ vựng liên quan đã được xóa.', 'success');
            } else {
                showMessage('Không tìm thấy chủ đề để xóa.', 'error');
            }
        }

        // --- Vocabulary Management ---
        document.getElementById('selectCategoryForVocab')?.addEventListener('change', function() {
            const categoryName = this.value;
            populateTopicsForCategory(categoryName, 'selectTopicForVocab', true);
            document.getElementById('vocabContent')?.classList.add('hidden');
        });

        document.getElementById('selectTopicForVocab')?.addEventListener('change', function() {
            const topicId = this.value;
            const vocabContent = document.getElementById('vocabContent');
            if (vocabContent) { // Ensure vocabContent exists before trying to manipulate
                if (topicId) {
                    vocabContent.classList.remove('hidden');
                    displayVocabularies(topicId);
                } else {
                    vocabContent.classList.add('hidden');
                }
            }
        });

        document.getElementById('addSingleVocabForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const topicId = document.getElementById('selectTopicForVocab').value;
            if (!topicId) {
                showMessage('Vui lòng chọn một chủ đề trước khi thêm từ vựng.', 'warning');
                return;
            }

            const englishWord = document.getElementById('englishWord').value.trim();
            const vietnameseMeaning = document.getElementById('vietnameseMeaning').value.trim().split(',').map(m => m.trim()).filter(m => m !== '');
            const exampleSentence = document.getElementById('exampleSentence').value.trim();

            if (!englishWord || vietnameseMeaning.length === 0) {
                showMessage('Vui lòng nhập Từ Tiếng Anh và Nghĩa Tiếng Việt.', 'warning');
                return;
            }

            if (vocabularies.some(v => v.topicId === topicId && v.english.toLowerCase() === englishWord.toLowerCase())) {
                showMessage(`Từ "${englishWord}" đã tồn tại trong chủ đề này.`, 'warning');
                return;
            }

            const newVocab = {
                id: `vocab-${Date.now()}`,
                topicId: topicId,
                english: englishWord,
                vietnamese: vietnameseMeaning,
                example: exampleSentence,
                mastery: 0
            };
            vocabularies.push(newVocab);
            saveToLocalStorage();
            displayVocabularies(topicId);
            this.reset();
            showMessage(`Đã thêm từ "${englishWord}".`, 'success');
            updatePerformanceStats();
        });

        document.getElementById('bulkImportVocabForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const topicId = document.getElementById('selectTopicForVocab').value;
            if (!topicId) {
                showMessage('Vui lòng chọn một chủ đề trước khi nhập từ vựng hàng loạt.', 'warning');
                return;
            }

            const bulkVocabInput = document.getElementById('bulkVocabInput').value.trim();
            if (!bulkVocabInput) {
                showMessage('Vui lòng nhập dữ liệu từ vựng.', 'warning');
                return;
            }

            const lines = bulkVocabInput.split('\n').filter(line => line.trim() !== '');
            let importedCount = 0;
            let skippedCount = 0;
            const skippedWords = [];

            lines.forEach(line => {
                const parts = line.split(' - ').map(p => p.trim());
                if (parts.length >= 2) {
                    const englishWord = parts[0];
                    const vietnameseMeaning = parts[1].split(',').map(m => m.trim()).filter(m => m !== '');
                    const exampleSentence = parts[2] || '';

                    if (englishWord && vietnameseMeaning.length > 0) {
                        if (vocabularies.some(v => v.topicId === topicId && v.english.toLowerCase() === englishWord.toLowerCase())) {
                            skippedCount++;
                            skippedWords.push(englishWord);
                        } else {
                            const newVocab = {
                                id: `vocab-${Date.now() + importedCount}`,
                                topicId: topicId,
                                english: englishWord,
                                vietnamese: vietnameseMeaning,
                                example: exampleSentence,
                                mastery: 0
                            };
                            vocabularies.push(newVocab);
                            importedCount++;
                        }
                    } else {
                        skippedCount++;
                        skippedWords.push(parts[0] || 'Dòng không hợp lệ');
                    }
                } else {
                    skippedCount++;
                    skippedWords.push(parts[0] || 'Dòng không hợp lệ');
                }
            });

            saveToLocalStorage();
            displayVocabularies(topicId);
            this.reset();
            let message = `Đã nhập thành công ${importedCount} từ.`;
            if (skippedCount > 0) {
                message += ` Bỏ qua ${skippedCount} từ (có thể do trùng lặp hoặc định dạng sai): ${skippedWords.join(', ')}`;
                showMessage(message, 'warning');
            } else {
                showMessage(message, 'success');
            }
            updatePerformanceStats();
        });

        document.getElementById('editVocabForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const vocabId = document.getElementById('editVocabId').value;
            const englishWord = document.getElementById('editEnglishWord').value.trim();
            const vietnameseMeaning = document.getElementById('editVietnameseMeaning').value.trim().split(',').map(m => m.trim()).filter(m => m !== '');
            const exampleSentence = document.getElementById('editExampleSentence').value.trim();

            if (!englishWord || vietnameseMeaning.length === 0) {
                showMessage('Vui lòng nhập Từ Tiếng Anh và Nghĩa Tiếng Việt.', 'warning');
                return;
            }

            const vocabIndex = vocabularies.findIndex(v => v.id === vocabId);
            if (vocabIndex === -1) {
                showMessage('Không tìm thấy từ vựng để cập nhật.', 'error');
                closeModal('editVocabModal');
                return;
            }

            const currentVocab = vocabularies[vocabIndex];

            if (vocabularies.some(v => v.topicId === currentVocab.topicId && v.english.toLowerCase() === englishWord.toLowerCase() && v.id !== vocabId)) {
                showMessage(`Từ "${englishWord}" đã tồn tại trong chủ đề này.`, 'warning');
                return;
            }

            vocabularies[vocabIndex] = {
                ...currentVocab,
                english: englishWord,
                vietnamese: vietnameseMeaning,
                example: exampleSentence
            };
            saveToLocalStorage();
            displayVocabularies(currentVocab.topicId);
            closeModal('editVocabModal');
            showMessage(`Từ "${englishWord}" đã được cập nhật.`, 'success');
        });

        function deleteVocabulary(vocabId) {
            if (!confirm('Bạn có chắc chắn muốn xóa từ vựng này?')) {
                return;
            }

            const initialLength = vocabularies.length;
            const deletedVocab = vocabularies.find(v => v.id === vocabId);
            vocabularies = vocabularies.filter(vocab => vocab.id !== vocabId);

            if (vocabularies.length < initialLength) {
                saveToLocalStorage();
                if (deletedVocab) {
                    const currentTopicId = document.getElementById('selectTopicForVocab')?.value;
                    if (currentTopicId === deletedVocab.topicId) {
                        displayVocabularies(currentTopicId);
                    }
                }
                showMessage('Từ vựng đã được xóa.', 'success');
                updatePerformanceStats();
            } else {
                showMessage('Không tìm thấy từ vựng để xóa.', 'error');
            }
        }

        // --- Quiz Section ---
        let currentQuizVocabs = [];
        let currentQuestionIndex = 0;
        let quizCorrectAnswers = 0;
        let quizIncorrectAnswers = 0;
        let quizTimerInterval;
        let quizTimeLimit;
        let currentQuizQuestionDirection; // Store the actual direction for the current question
        let quizWordsToReview = [];

        document.querySelectorAll('input[name="quizMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('singleTopicQuizOptions')?.classList.toggle('hidden', this.value !== 'single');
                document.getElementById('mixedTopicQuizOptions')?.classList.toggle('hidden', this.value !== 'mixed');
                if (this.value === 'mixed') {
                    populateMultiTopicCheckboxes();
                }
            });
        });

        document.getElementById('selectCategoryForQuiz')?.addEventListener('change', function() {
            const categoryName = this.value;
            populateTopicsForCategory(categoryName, 'selectTopicForQuiz', true);
        });

        function populateMultiTopicCheckboxes() {
            const multiTopicCheckboxes = document.getElementById('multiTopicCheckboxes');
            if (!multiTopicCheckboxes) return;

            multiTopicCheckboxes.innerHTML = '';
            let hasTopics = false;

            for (const categoryName in categories) {
                if (categories[categoryName] && categories[categoryName].length > 0) {
                    hasTopics = true;
                    const categoryHeader = document.createElement('h5');
                    categoryHeader.className = 'col-span-full font-semibold text-gray-800 mt-2 mb-1';
                    categoryHeader.textContent = categoryName;
                    multiTopicCheckboxes.appendChild(categoryHeader);

                    categories[categoryName].forEach(topic => {
                        const div = document.createElement('label');
                        div.className = 'multi-select-option';
                        div.innerHTML = `
                            <input type="checkbox" name="selectedQuizTopics" value="${topic.id}">
                            ${topic.name}
                        `;
                        multiTopicCheckboxes.appendChild(div);
                    });
                }
            }
            if (!hasTopics) {
                multiTopicCheckboxes.innerHTML = '<p class="text-gray-500 col-span-full">Chưa có chủ đề nào để chọn.</p>';
            }
        }

        document.getElementById('startQuizBtn')?.addEventListener('click', startQuiz);

        function startQuiz() {
            const quizMode = document.querySelector('input[name="quizMode"]:checked')?.value;
            const questionCountInput = document.getElementById('quizQuestionCount');
            const quizTimeLimitInput = document.getElementById('quizTimeLimit');

            const questionCount = parseInt(questionCountInput?.value || '0');
            quizTimeLimit = parseInt(quizTimeLimitInput?.value || '30');
            const quizDirectionSetting = document.querySelector('input[name="quizDirection"]:checked')?.value;

            if (questionCount <= 0) {
                showMessage('Số lượng câu hỏi phải lớn hơn 0.', 'warning');
                return;
            }
            if (quizTimeLimit < 5) {
                showMessage('Thời gian giới hạn phải ít nhất 5 giây.', 'warning');
                return;
            }


            let selectedTopicIds = [];

            if (quizMode === 'single') {
                const singleTopicId = document.getElementById('selectTopicForQuiz')?.value;
                if (!singleTopicId) {
                    showMessage('Vui lòng chọn một chủ đề để kiểm tra.', 'warning');
                    return;
                }
                selectedTopicIds.push(singleTopicId);
            } else { // mixed mode
                document.querySelectorAll('input[name="selectedQuizTopics"]:checked').forEach(checkbox => {
                    selectedTopicIds.push(checkbox.value);
                });
                if (selectedTopicIds.length === 0) {
                    showMessage('Vui lòng chọn ít nhất một chủ đề để kiểm tra ngẫu nhiên.', 'warning');
                    return;
                }
            }

            const availableVocabs = vocabularies.filter(vocab => selectedTopicIds.includes(vocab.topicId));

            if (availableVocabs.length === 0) {
                showMessage('Không có từ vựng nào trong (các) chủ đề đã chọn để kiểm tra.', 'warning');
                return;
            }
            if (availableVocabs.length < questionCount) {
                showMessage(`Không đủ từ vựng (${availableVocabs.length}) để tạo bài kiểm tra với ${questionCount} câu hỏi. Vui lòng giảm số lượng câu hỏi hoặc thêm từ vựng.`, 'warning');
                return;
            }

            currentQuizVocabs = shuffleArray(availableVocabs).slice(0, questionCount);

            currentQuestionIndex = 0;
            quizCorrectAnswers = 0;
            quizIncorrectAnswers = 0;
            quizWordsToReview = [];
            currentQuizQuestionDirection = quizDirectionSetting; // This is the user's overall setting

            document.getElementById('quizSettings')?.classList.add('hidden');
            document.getElementById('quizArea')?.classList.remove('hidden');
            document.getElementById('quizResults')?.classList.add('hidden');

            document.getElementById('totalQuizQuestions').textContent = currentQuizVocabs.length;
            document.getElementById('quizCorrectCount').textContent = quizCorrectAnswers;
            document.getElementById('quizIncorrectCount').textContent = quizIncorrectAnswers;

            loadNextQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadNextQuestion() {
            clearInterval(quizTimerInterval);
            document.getElementById('feedbackMessage')?.classList.add('hidden');
            document.getElementById('submitAnswerBtn')?.classList.remove('hidden');
            document.getElementById('nextQuestionBtn')?.classList.add('hidden');
            document.getElementById('englishAnswerInput').value = '';
            document.getElementById('englishAnswerInput').focus();
            document.getElementById('englishAnswerInput').classList.remove('border-green-500', 'border-red-500');

            if (currentQuestionIndex < currentQuizVocabs.length) {
                const currentVocab = currentQuizVocabs[currentQuestionIndex];
                document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;

                let questionText = '';
                let actualDirectionForThisQuestion = currentQuizQuestionDirection; // Use the global setting first

                if (currentQuizQuestionDirection === 'random') {
                    actualDirectionForThisQuestion = Math.random() < 0.5 ? 'viet-to-eng' : 'eng-to-viet';
                }

                if (actualDirectionForThisQuestion === 'viet-to-eng') {
                    questionText = currentVocab.vietnamese.join(', ');
                } else { // eng-to-viet
                    questionText = currentVocab.english;
                }
                document.getElementById('quizQuestion').textContent = questionText;
                // Store the *actual* direction for this specific question to use in checkAnswer
                currentVocab._actualQuizDirection = actualDirectionForThisQuestion;
                startQuizTimer();
            } else {
                endQuiz();
            }
        }

        function startQuizTimer() {
            let timeLeft = quizTimeLimit;
            const quizTimerDisplay = document.getElementById('quizTimer');
            if (!quizTimerDisplay) return;

            quizTimerDisplay.textContent = timeLeft;

            quizTimerInterval = setInterval(() => {
                timeLeft--;
                quizTimerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(quizTimerInterval);
                    checkAnswer(true); // Auto-submit when time runs out
                }
            }, 1000);
        }

        document.getElementById('submitAnswerBtn')?.addEventListener('click', () => checkAnswer(false));
        document.getElementById('englishAnswerInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (!document.getElementById('submitAnswerBtn')?.classList.contains('hidden')) {
                    checkAnswer(false);
                } else if (!document.getElementById('nextQuestionBtn')?.classList.contains('hidden')) {
                    loadNextQuestion();
                }
            }
        });

        function checkAnswer(timeOut = false) {
            clearInterval(quizTimerInterval);
            document.getElementById('submitAnswerBtn')?.classList.add('hidden');
            document.getElementById('nextQuestionBtn')?.classList.remove('hidden');

            const currentVocab = currentQuizVocabs[currentQuestionIndex];
            const userAnswer = document.getElementById('englishAnswerInput').value.trim();
            const feedbackMessage = document.getElementById('feedbackMessage');
            const englishAnswerInput = document.getElementById('englishAnswerInput');

            if (!feedbackMessage || !englishAnswerInput) return;

            feedbackMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
            englishAnswerInput.classList.remove('border-green-500', 'border-red-500');

            let isCorrect = false;
            let correctAnswerDisplayed = '';

            // Use the actual direction stored for this question
            const actualDirection = currentVocab._actualQuizDirection;

            if (actualDirection === 'viet-to-eng') {
                const correctEnglish = currentVocab.english.toLowerCase();
                isCorrect = (userAnswer.toLowerCase() === correctEnglish);
                correctAnswerDisplayed = currentVocab.english;
            } else { // eng-to-viet
                const userMeanings = userAnswer.toLowerCase().split(',').map(m => m.trim()).filter(m => m !== '');
                const correctMeanings = currentVocab.vietnamese.map(m => m.toLowerCase());

                // Check if user's answer contains at least one of the correct meanings
                isCorrect = userMeanings.some(userM => correctMeanings.includes(userM));
                correctAnswerDisplayed = currentVocab.vietnamese.join(', ');
            }


            if (isCorrect) {
                quizCorrectAnswers++;
                feedbackMessage.textContent = 'Chính xác!';
                feedbackMessage.classList.add('text-green-600');
                englishAnswerInput.classList.add('border-green-500');
            } else {
                quizIncorrectAnswers++;
                let message = 'Sai rồi.';
                if (timeOut) {
                    message = 'Hết giờ! Đáp án đúng là:';
                } else {
                    message = 'Sai rồi! Đáp án đúng là:';
                }
                feedbackMessage.innerHTML = `${message} <span class="font-bold">${correctAnswerDisplayed}</span>.`;
                feedbackMessage.classList.add('text-red-600');
                englishAnswerInput.classList.add('border-red-500');

                quizWordsToReview.push({
                    english: currentVocab.english,
                    correctMeaning: currentVocab.vietnamese.join(', '),
                    userAnswer: userAnswer || '<Không trả lời>'
                });
            }

            document.getElementById('quizCorrectCount').textContent = quizCorrectAnswers;
            document.getElementById('quizIncorrectCount').textContent = quizIncorrectAnswers;
        }

        document.getElementById('nextQuestionBtn')?.addEventListener('click', function() {
            currentQuestionIndex++;
            loadNextQuestion();
        });

        document.getElementById('endQuizBtn')?.addEventListener('click', endQuiz);

        function endQuiz() {
            clearInterval(quizTimerInterval);
            document.getElementById('quizArea')?.classList.add('hidden');
            document.getElementById('quizResults')?.classList.remove('hidden');
            document.getElementById('quizSettings')?.classList.remove('hidden');

            const totalQuestions = currentQuizVocabs.length;
            const score = totalQuestions > 0 ? ((quizCorrectAnswers / totalQuestions) * 100).toFixed(0) : 0;

            document.getElementById('resultsTotalQuestions').textContent = totalQuestions;
            document.getElementById('resultsScore').textContent = `${score}%`;
            document.getElementById('resultsCorrect').textContent = quizCorrectAnswers;
            document.getElementById('resultsIncorrect').textContent = quizIncorrectAnswers;

            quizResults.push({
                timestamp: new Date().toISOString(),
                totalQuestions: totalQuestions,
                correct: quizCorrectAnswers,
                incorrect: quizIncorrectAnswers,
                score: parseFloat(score),
                wordsToReview: quizWordsToReview.map(w => ({english: w.english, userAnswer: w.userAnswer}))
            });
            saveToLocalStorage();
            updatePerformanceStats();

            displayWordsToReview();
        }

        function displayWordsToReview() {
            const wordsToReviewTableBody = document.getElementById('wordsToReviewTableBody');
            if (!wordsToReviewTableBody) return;

            wordsToReviewTableBody.innerHTML = '';

            if (quizWordsToReview.length === 0) {
                wordsToReviewTableBody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">Chúc mừng! Bạn đã trả lời đúng tất cả.</td></tr>';
                return;
            }

            quizWordsToReview.forEach(word => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${word.english}</td>
                    <td class="py-3 px-6 text-left text-green-600 font-medium">${word.correctMeaning}</td>
                    <td class="py-3 px-6 text-left text-red-600">${word.userAnswer}</td>
                `;
                wordsToReviewTableBody.appendChild(row);
            });
        }

        document.getElementById('retakeQuizBtn')?.addEventListener('click', function() {
            currentQuestionIndex = 0;
            quizCorrectAnswers = 0;
            quizIncorrectAnswers = 0;
            quizWordsToReview = [];

            document.getElementById('quizResults')?.classList.add('hidden');
            document.getElementById('quizArea')?.classList.remove('hidden');

            document.getElementById('totalQuizQuestions').textContent = currentQuizVocabs.length;
            document.getElementById('quizCorrectCount').textContent = quizCorrectAnswers;
            document.getElementById('quizIncorrectCount').textContent = quizIncorrectAnswers;

            loadNextQuestion();
        });

        document.getElementById('newQuizBtn')?.addEventListener('click', function() {
            document.getElementById('quizResults')?.classList.add('hidden');
            document.getElementById('quizArea')?.classList.add('hidden');
            document.getElementById('quizSettings')?.classList.remove('hidden');
            // Re-populate select topics for quiz section
            populateParentCategories('selectCategoryForQuiz', true);
            const currentCategoryQuiz = document.getElementById('selectCategoryForQuiz').value;
            populateTopicsForCategory(currentCategoryQuiz, 'selectTopicForQuiz', true);
            if (document.querySelector('input[name="quizMode"]:checked')?.value === 'mixed') {
                populateMultiTopicCheckboxes();
            }
        });

        // --- Performance Section ---
        function updatePerformanceStats() {
            document.getElementById('totalTopicsStat').textContent = Object.values(categories).flat().length;
            document.getElementById('totalVocabStat').textContent = vocabularies.length;
            document.getElementById('completedQuizzesStat').textContent = quizResults.length;

            displayTopicPerformance();
        }

        function displayTopicPerformance() {
            const topicPerformanceList = document.getElementById('topicPerformanceList');
            if (!topicPerformanceList) return;

            topicPerformanceList.innerHTML = '';

            const allTopics = Object.values(categories).flat();
            if (allTopics.length === 0) {
                topicPerformanceList.innerHTML = '<p class="text-gray-500 text-center">Chưa có chủ đề nào để hiển thị hiệu suất.</p>';
                return;
            }

            allTopics.forEach(topic => {
                const topicVocabs = vocabularies.filter(vocab => vocab.topicId === topic.id);
                // Filter quiz results to include only those where *any* word from the topic was part of the quiz
                const quizAttemptsForTopic = quizResults.filter(result =>
                    result.wordsToReview.some(wordInReview =>
                        topicVocabs.some(topicVocab => topicVocab.english === wordInReview.english)
                    )
                );

                const totalWordsInTopic = topicVocabs.length;
                let averageScore = 0;
                if (quizAttemptsForTopic.length > 0) {
                    const totalScores = quizAttemptsForTopic.reduce((sum, result) => sum + result.score, 0);
                    averageScore = (totalScores / quizAttemptsForTopic.length).toFixed(1);
                }

                const topicDiv = document.createElement('div');
                topicDiv.className = 'bg-white p-4 rounded-lg shadow-md flex justify-between items-center';
                topicDiv.innerHTML = `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">${topic.name}</h4>
                        <p class="text-gray-600 text-sm">Từ vựng: ${totalWordsInTopic}</p>
                        <p class="text-gray-600 text-sm">Số lần kiểm tra: ${quizAttemptsForTopic.length}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-gray-600 text-sm">Điểm trung bình:</p>
                        <p class="text-2xl font-bold ${averageScore >= 70 ? 'text-green-600' : averageScore >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                            ${averageScore}%
                        </p>
                    </div>
                `;
                topicPerformanceList.appendChild(topicDiv);
            });
        }


        // --- Navigation ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.nav-link').forEach(nav => {
                    nav.classList.remove('active-nav-link');
                });

                const targetSectionId = this.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetSectionId);
                if (targetSection) { // Check if element exists
                    targetSection.classList.add('active');
                }
                this.classList.add('active-nav-link');

                // Re-populate selects and display lists when navigating to relevant sections
                if (targetSectionId === 'topics-section') {
                    populateParentCategories('parentCategorySelect', false);
                    displayTopics(); // Call displayTopics *after* populating categories
                } else if (targetSectionId === 'vocabulary-management-section') {
                    populateParentCategories('selectCategoryForVocab', true);
                    const currentCategoryVocab = document.getElementById('selectCategoryForVocab')?.value;
                    if (currentCategoryVocab) { // Only populate topics if a category is selected
                        populateTopicsForCategory(currentCategoryVocab, 'selectTopicForVocab', true);
                    } else { // Clear topics if no category selected
                        document.getElementById('selectTopicForVocab').innerHTML = '<option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>';
                    }
                    document.getElementById('vocabContent')?.classList.add('hidden'); // Always hide initially
                } else if (targetSectionId === 'quiz-section') {
                    populateParentCategories('selectCategoryForQuiz', true);
                    const currentCategoryQuiz = document.getElementById('selectCategoryForQuiz')?.value;
                    if (currentCategoryQuiz) { // Only populate topics if a category is selected
                        populateTopicsForCategory(currentCategoryQuiz, 'selectTopicForQuiz', true);
                    } else { // Clear topics if no category selected
                         document.getElementById('selectTopicForQuiz').innerHTML = '<option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>';
                    }
                    if (document.querySelector('input[name="quizMode"]:checked')?.value === 'mixed') {
                        populateMultiTopicCheckboxes();
                    }
                    document.getElementById('quizArea')?.classList.add('hidden');
                    document.getElementById('quizResults')?.classList.add('hidden');
                    document.getElementById('quizSettings')?.classList.remove('hidden');
                } else if (targetSectionId === 'performance-section') {
                    updatePerformanceStats();
                }
            });
        });

        function populateSelects() {
            // Ensure initial population for all relevant selects
            populateParentCategories('parentCategorySelect', false);
            populateParentCategories('selectCategoryForVocab', true);
            populateParentCategories('selectCategoryForQuiz', true);

            // Trigger change event for vocab management select to populate its topics
            const selectCategoryForVocab = document.getElementById('selectCategoryForVocab');
            if (selectCategoryForVocab && selectCategoryForVocab.value) {
                selectCategoryForVocab.dispatchEvent(new Event('change'));
            } else {
                 document.getElementById('selectTopicForVocab').innerHTML = '<option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>';
            }

            // Trigger change event for quiz select to populate its topics
            const selectCategoryForQuiz = document.getElementById('selectCategoryForQuiz');
            if (selectCategoryForQuiz && selectCategoryForQuiz.value) {
                selectCategoryForQuiz.dispatchEvent(new Event('change'));
            } else {
                 document.getElementById('selectTopicForQuiz').innerHTML = '<option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>';
            }

            populateMultiTopicCheckboxes();
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // First, populate initial categories in the "Add Topic" form
            populateParentCategories('parentCategorySelect', false);

            // Then, display topics for the topics section
            displayTopics();

            // Then, populate all other dynamic selects
            populateSelects();

            // Set up initial active section and navigation link
            const initialSectionId = window.location.hash ? window.location.hash.substring(1) : 'topics-section';
            const initialNavLink = document.querySelector(`a[href="#${initialSectionId}"]`);

            // Ensure the correct section is active on load
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(initialSectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Ensure the correct nav link is active
            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active-nav-link'));
            if (initialNavLink) {
                initialNavLink.classList.add('active-nav-link');
            }

            // Special handling for sections that need initial data display
            if (initialSectionId === 'vocabulary-management-section') {
                const selectedTopic = document.getElementById('selectTopicForVocab')?.value;
                if (selectedTopic) {
                    document.getElementById('vocabContent')?.classList.remove('hidden');
                    displayVocabularies(selectedTopic);
                }
            } else if (initialSectionId === 'performance-section') {
                updatePerformanceStats();
            }
        });
    </script>
</body>
</html>
