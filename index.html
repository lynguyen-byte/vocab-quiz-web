<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Dò Từ Vựng Của Bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            /* Changed background to light purple */
            @apply bg-purple-50 text-gray-800;
        }
        /* Hide sections by default, show only active one */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }
        /* Active navigation link style */
        .active-nav-link {
            @apply bg-gray-700;
        }
        /* Style for multi-select checkboxes */
        .multi-select-option {
            @apply block p-2 rounded-md hover:bg-purple-100 cursor-pointer;
        }
        .multi-select-option input[type="checkbox"] {
            @apply mr-2;
        }
        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: relative; /* For close button */
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #4b5563; /* Tailwind gray-600 */
        }
        .modal-close-btn:hover {
            color: #1f2937; /* Tailwind gray-800 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 shadow-lg">
        <div class="container mx-auto text-center">
            <h1 class="text-4xl font-bold mb-2">Trang Web Dò Từ Vựng Của Bạn</h1>
            <p class="text-xl opacity-90">Học, quản lý và kiểm tra từ vựng theo chủ đề!</p>
        </div>
    </header>
    <nav class="bg-gray-800 text-white shadow-md">
        <ul class="container mx-auto flex justify-center py-3">
            <li><a href="#topics-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md active-nav-link">Chủ Đề</a></li>
            <li><a href="#vocabulary-management-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Quản Lý Từ Vựng</a></li>
            <li><a href="#quiz-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Kiểm Tra</a></li>
            <li><a href="#performance-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Hiệu Suất Học Tập</a></li>
        </ul>
    </nav>
    <main class="container mx-auto mt-8 p-6 bg-white rounded-lg shadow-xl flex-grow">
        <div id="generalMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <section id="topics-section" class="section active">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Chủ Đề</h2>
            <div class="bg-purple-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Thêm Chủ Đề Con Mới</h3>
                <form id="addTopicForm" class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="parentCategorySelect" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                        <select id="parentCategorySelect"
                                class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </select>
                    </div>
                    <div class="flex-grow w-full">
                        <label for="newTopicName" class="block text-gray-700 text-sm font-bold mb-2">Tên Chủ Đề Con:</label>
                        <input type="text" id="newTopicName" placeholder="Ví dụ: Level 1, Idioms"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <button type="submit"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Thêm Chủ Đề
                    </button>
                </form>
            </div>
            <h3 class="text-2xl font-medium text-purple-600 mb-4">Các Chủ Đề Hiện Có</h3>
            <div id="categoriesList" class="space-y-8">
                <p class="text-gray-500 text-center col-span-full">Chưa có chủ đề nào. Hãy thêm chủ đề mới!</p>
            </div>
        </section>

        <section id="vocabulary-management-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Từ Vựng</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </select>
                </div>
                <div>
                    <label for="selectTopicForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con:</label>
                    <select id="selectTopicForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>
                    </select>
                </div>
            </div>
            <div id="vocabContent" class="hidden">
                <div class="bg-green-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-green-700 mb-4">Thêm Từ Vựng Riêng Lẻ</h3>
                    <form id="addSingleVocabForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="englishWord" class="block text-gray-700 text-sm font-bold mb-2">Từ Tiếng Anh:</label>
                            <input type="text" id="englishWord" placeholder="Ví dụ: beautiful"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="vietnameseMeaning" class="block text-gray-700 text-sm font-bold mb-2">Nghĩa Tiếng Việt:</label>
                            <input type="text" id="vietnameseMeaning" placeholder="Ví dụ: đẹp, xinh đẹp"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="exampleSentence" class="block text-gray-700 text-sm font-bold mb-2">Ví Dụ Câu (tùy chọn):</label>
                            <textarea id="exampleSentence" rows="2" placeholder="Ví dụ: She has a beautiful smile."
                                      class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>
                        <div class="md:col-span-2 text-right">
                            <button type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Thêm Từ
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-yellow-700 mb-4">Nhập Từ Vựng Hàng Loạt</h3>
                    <p class="text-gray-600 mb-4">Nhập mỗi từ trên một dòng theo định dạng: <code class="bg-gray-200 p-1 rounded">English Word - Vietnamese Meaning - Example Sentence (optional)</code></p>
                    <form id="bulkImportVocabForm">
                        <textarea id="bulkVocabInput" rows="8" placeholder="Ví dụ:apple - quả táo - I like to eat an apple.book - cuốn sách - Read a good book.run - chạy - He can run fast."
                                  class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent mb-4"></textarea>
                        <div class="text-right">
                            <button type="submit"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Nhập Hàng Loạt
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-2xl font-medium text-purple-600 mb-4">Từ Vựng Trong Chủ Đề Này (<span id="currentVocabCount">0</span> từ)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Nghĩa Tiếng Việt</th>
                                <th class="py-3 px-6 text-left">Ví Dụ</th>
                                <th class="py-3 px-6 text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="currentTopicVocabTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="quiz-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Kiểm Tra Từ Vựng</h2>
            <div class="mb-6 bg-purple-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-medium text-purple-700 mb-4">Chọn Loại Bài Kiểm Tra</h3>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="single" checked class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra theo Chủ đề</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="mixed" class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra ngẫu nhiên từ nhiều Chủ đề</span>
                    </label>
                </div>

                <div id="singleTopicQuizOptions">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="selectCategoryForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                            <select id="selectCategoryForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </select>
                        </div>
                        <div>
                            <label for="selectTopicForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Kiểm Tra:</label>
                            <select id="selectTopicForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="mixedTopicQuizOptions" class="hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chọn các Chủ Đề Con để ôn tập:</label>
                    <div id="multiTopicCheckboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 bg-white p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 col-span-full">Chưa có chủ đề nào để chọn.</p>
                    </div>
                </div>

                <div id="quizSettings" class="mt-6">
                    <h3 class="text-2xl font-medium text-purple-700 mb-4">Cài Đặt Bài Kiểm Tra</h3>
                    <div class="mb-4">
                        <label for="quizQuestionCount" class="block text-gray-700 text-sm font-bold mb-2">Số lượng câu hỏi:</label>
                        <input type="number" id="quizQuestionCount" value="5" min="1"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label for="quizTimeLimit" class="block text-gray-700 text-sm font-bold mb-2">Thời gian giới hạn mỗi từ (giây):</label>
                        <input type="number" id="quizTimeLimit" value="30" min="5"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <button id="startQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Bắt Đầu Kiểm Tra
                    </button>
                </div>
            </div>

            <div id="quizArea" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xl font-semibold text-gray-700">Câu hỏi <span id="currentQuestionNumber">1</span>/<span id="totalQuizQuestions">5</span></span>
                    <span class="text-2xl font-bold text-red-600" id="quizTimer">30</span>
                </div>
                <div class="text-center mb-8">
                    <p class="text-3xl font-bold text-purple-800 mb-4">
                        <span id="vietnameseQuestion"></span>
                    </p>
                    <input type="text" id="englishAnswerInput" placeholder="Nhập từ tiếng Anh..."
                           class="shadow appearance-none border rounded-lg w-full max-w-md py-4 px-6 text-gray-700 text-2xl leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center">
                </div>
                <div id="feedbackMessage" class="hidden text-center mt-4 text-lg font-semibold"></div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="submitAnswerBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Nộp Đáp Án
                    </button>
                    <button id="skipQuestionBtn"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Bỏ Qua
                    </button>
                </div>
            </div>

            <div id="quizResults" class="hidden bg-white p-8 rounded-lg shadow-lg mt-8">
                <h3 class="text-3xl font-bold text-purple-700 mb-6 text-center">Kết Quả Bài Kiểm Tra</h3>
                <p class="text-xl text-center mb-4">Bạn đã trả lời đúng <span id="correctCount" class="font-bold text-green-600">0</span> trên <span id="totalCount" class="font-bold text-purple-600">0</span> câu.</p>
                <div id="detailedResults" class="space-y-4">
                    </div>
                <div class="text-center mt-8">
                    <button id="retakeQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Làm Lại Bài Kiểm Tra
                    </button>
                </div>
            </div>

            <div id="cheatDetectionMessage" class="hidden fixed inset-0 bg-red-800 bg-opacity-90 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-md">
                    <h3 class="text-3xl font-bold text-red-700 mb-4">Phát Hiện Gian Lận!</h3>
                    <p class="text-lg text-gray-700 mb-6">Bạn đã chuyển khỏi tab hoặc cửa sổ, hoặc thay đổi kích thước màn hình trong khi làm bài kiểm tra. Bài kiểm tra này sẽ bị hủy.</p>
                    <button id="closeCheatMessageBtn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Đóng
                    </button>
                </div>
            </div>
        </section>

        <section id="performance-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Hiệu Suất Học Tập</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForPerformance" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForPerformance"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </select>
                </div>
                <div>
                    <label for="selectTopicForPerformance" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Xem Hiệu Suất:</label>
                    <select id="selectTopicForPerformance"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để xem hiệu suất --</option>
                    </select>
                </div>
            </div>
            <div id="performanceContent" class="hidden">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Lịch Sử Bài Kiểm Tra</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Ngày</th>
                                <th class="py-3 px-6 text-left">Điểm</th>
                                <th class="py-3 px-6 text-left">Tổng số câu</th>
                                <th class="py-3 px-6 text-left">Loại bài</th>
                                <th class="py-3 px-6 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="performanceTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="5" class="py-4 text-center text-gray-500">Chưa có lịch sử bài kiểm tra cho chủ đề này.</td></tr>
                        </tbody>
                    </table>
                </div>
                <h3 class="text-2xl font-medium text-purple-600 mb-4 mt-8">Hiệu Suất Từ Vựng</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Số lần đúng</th>
                                <th class="py-3 px-6 text-left">Số lần sai</th>
                                <th class="py-3 px-6 text-left">Tỷ lệ đúng</th>
                            </tr>
                        </thead>
                        <tbody id="vocabPerformanceTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chưa có dữ liệu hiệu suất từ vựng cho chủ đề này.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global variables for managing application data and state
        const APP_DATA_KEY = 'myVocabularyApp'; // Key for storing data in localStorage
        let appData = {
            categories: [] // Array containing main categories (Ken, Nhím), each category has an ID, name, and an array of sub-topics
        };
        let currentCategoryId = null; // ID of the currently selected main category
        let currentTopicId = null; // ID of the currently selected sub-topic

        let currentQuiz = {
            questions: [], // Array of questions in the current quiz
            currentQuestionIndex: 0,
            score: 0,
            timerInterval: null,
            timeRemaining: 0,
            quizActive: false, // Quiz active status
            quizTimeLimit: 30, // Default time limit for each question (used for single topic quiz)
            quizType: 'single', // 'single' or 'mixed'
            selectedMixedTopicIds: [], // For mixed quizzes, stores IDs of topics included
            mixedQuizTopicSettings: {}, // New: stores {topicId: {questionCount: N, timeLimit: M}} for mixed quizzes
            initialWindowWidth: 0, // Store initial window width for cheat detection
            initialWindowHeight: 0 // Store initial window height for cheat detection
        };

        // Global variable to track cheat detection status
        let cheatDetected = false;

        // --- DOM Elements ---
        const generalMessage = document.getElementById('generalMessage');

        // Elements for Topic Management section
        const addTopicForm = document.getElementById('addTopicForm');
        const parentCategorySelect = document.getElementById('parentCategorySelect'); // Select for parent category
        const newTopicNameInput = document.getElementById('newTopicName');
        const categoriesListDiv = document.getElementById('categoriesList'); // Renamed from topicsListDiv

        // Elements for Vocabulary Management section
        const selectCategoryForVocab = document.getElementById('selectCategoryForVocab'); // Select for category
        const selectTopicForVocab = document.getElementById('selectTopicForVocab');
        const vocabContentDiv = document.getElementById('vocabContent');
        const addSingleVocabForm = document.getElementById('addSingleVocabForm');
        const englishWordInput = document.getElementById('englishWord');
        const vietnameseMeaningInput = document.getElementById('vietnameseMeaning');
        const exampleSentenceInput = document.getElementById('exampleSentence');
        const bulkImportVocabForm = document.getElementById('bulkImportVocabForm');
        const bulkVocabInput = document.getElementById('bulkVocabInput');
        const currentTopicVocabTableBody = document.getElementById('currentTopicVocabTableBody');
        const currentVocabCountSpan = document.getElementById('currentVocabCount'); // Added for vocabulary count

        // Elements for Quiz section
        const quizModeRadios = document.querySelectorAll('input[name="quizMode"]');
        const singleTopicQuizOptionsDiv = document.getElementById('singleTopicQuizOptions');
        const mixedTopicQuizOptionsDiv = document.getElementById('mixedTopicQuizOptions');
        const multiTopicCheckboxesDiv = document.getElementById('multiTopicCheckboxes');

        const selectCategoryForQuiz = document.getElementById('selectCategoryForQuiz'); // Select for category
        const selectTopicForQuiz = document.getElementById('selectTopicForQuiz');
        const quizSettingsDiv = document.getElementById('quizSettings');
        const quizQuestionCountInput = document.getElementById('quizQuestionCount');
        const quizTimeLimitInput = document.getElementById('quizTimeLimit');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const quizArea = document.getElementById('quizArea');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const totalQuizQuestionsSpan = document.getElementById('totalQuizQuestions');
        const quizTimerSpan = document.getElementById('quizTimer');
        const vietnameseQuestionSpan = document.getElementById('vietnameseQuestion');
        const englishAnswerInput = document.getElementById('englishAnswerInput');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const skipQuestionBtn = document.getElementById('skipQuestionBtn');
        const feedbackMessageDiv = document.getElementById('feedbackMessage'); // Element for feedback
        const quizResultsDiv = document.getElementById('quizResults');
        const correctCountSpan = document.getElementById('correctCount');
        const totalCountSpan = document.getElementById('totalCount');
        const detailedResultsDiv = document.getElementById('detailedResults');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const cheatDetectionMessage = document.getElementById('cheatDetectionMessage');
        const closeCheatMessageBtn = document.getElementById('closeCheatMessageBtn');

        // Elements for Performance section
        const selectCategoryForPerformance = document.getElementById('selectCategoryForPerformance');
        const selectTopicForPerformance = document.getElementById('selectTopicForPerformance');
        const performanceContentDiv = document.getElementById('performanceContent');
        const performanceTableBody = document.getElementById('performanceTableBody');
        const vocabPerformanceTableBody = document.getElementById('vocabPerformanceTableBody'); // New element for vocabulary performance
        // Navigation elements
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');

        // --- General Utility Functions ---

        /**
         * Displays a temporary message to the user.
         * @param {string} text - The message to display.
         * @param {string} type - 'success' for green, 'error' for red.
         * @param {number} duration - How long the message is visible in milliseconds.
         */
        function showMessage(text, type = 'success', duration = 3000) {
            generalMessage.textContent = text;
            generalMessage.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            generalMessage.classList.remove('hidden');
            setTimeout(() => {
                generalMessage.classList.add('hidden');
            }, duration);
        }

        /**
         * Saves the entire appData object to localStorage.
         */
        function saveAppData() {
            try {
                localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showMessage("Lỗi khi lưu dữ liệu. Có thể bộ nhớ đầy.", "error");
            }
        }

        /**
         * Loads appData from localStorage. Initializes default categories if not found.
         */
        function loadAppData() {
            try {
                const storedData = localStorage.getItem(APP_DATA_KEY);
                if (storedData) {
                    appData = JSON.parse(storedData);
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                showMessage("Lỗi khi tải dữ liệu. Đang tải dữ liệu mặc định.", "error");
                appData = { categories: [] }; // Reset to default if loading fails
            }

            // Ensure default categories exist and have a 'results' array for existing topics
            let kenExists = false;
            let nhimExists = false;
            appData.categories.forEach(cat => {
                if (cat.id === 'ken') kenExists = true;
                if (cat.id === 'nhim') nhimExists = true;
                cat.topics.forEach(topic => {
                    if (!topic.results) {
                        topic.results = []; // Initialize results array for existing topics
                    }
                    // Ensure vocabulary items have performance counters and quizSettings
                    topic.vocabulary.forEach(vocab => {
                        if (typeof vocab.correctAttempts === 'undefined') vocab.correctAttempts = 0;
                        if (typeof vocab.incorrectAttempts === 'undefined') vocab.incorrectAttempts = 0;
                    });
                    if (!topic.quizSettings) {
                        topic.quizSettings = { mixedQuizQuestionCount: 5, timeLimit: 30 }; // Default settings
                    }
                });
            });

            if (!kenExists) {
                appData.categories.push({ id: 'ken', name: 'Ken', topics: [] });
            }
            if (!nhimExists) {
                appData.categories.push({ id: 'nhim', name: 'Nhím', topics: [] });
            }
            saveAppData(); // Save after ensuring all default structures
        }

        /**
         * Shuffles an array randomly.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} - The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // ES6 swap
            }
            return array;
        }

        // --- Navigation Logic ---
        navLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const targetSectionId = this.getAttribute('href');

                // Hide all sections
                sections.forEach(section => section.classList.remove('active'));

                // Show the target section
                document.querySelector(targetSectionId).classList.add('active');

                // Update active nav link style
                navLinks.forEach(nav => nav.classList.remove('active-nav-link'));
                this.classList.add('active-nav-link');

                // Perform actions specific to the navigated section
                if (targetSectionId === '#topics-section') {
                    renderCategories();
                    populateParentCategorySelect();
                } else if (targetSectionId === '#vocabulary-management-section') {
                    populateCategorySelectForVocab();
                    vocabContentDiv.classList.add('hidden'); // Hide vocab content until topic is selected
                } else if (targetSectionId === '#quiz-section') {
                    populateCategorySelectForQuiz();
                    // Ensure quiz area is hidden on navigation
                    quizArea.classList.add('hidden');
                    quizResultsDiv.classList.add('hidden');
                    quizSettingsDiv.classList.remove('hidden'); // Show quiz settings
                    // Re-render multi-topic checkboxes if mixed mode is active
                    if (currentQuiz.quizType === 'mixed') {
                        renderMultiTopicCheckboxes();
                    } else {
                        // Ensure mixed options are hidden when navigating to quiz section
                        mixedTopicQuizOptionsDiv.classList.add('hidden');
                        singleTopicQuizOptionsDiv.classList.remove('hidden');
                    }
                } else if (targetSectionId === '#performance-section') {
                    populateCategorySelectForPerformance();
                    performanceContentDiv.classList.add('hidden'); // Hide content until topic selected
                }
            });
        });

        // --- Topic Management ---

        /**
         * Populates the parent category select dropdown for adding new topics.
         */
        function populateParentCategorySelect() {
            parentCategorySelect.innerHTML = ''; // Clear existing options
            appData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentCategorySelect.appendChild(option);
            });
            // Set currentCategoryId to the first category if available
            if (appData.categories.length > 0) {
                currentCategoryId = appData.categories[0].id;
            } else {
                currentCategoryId = null;
            }
        }

        /**
         * Renders the list of categories and their sub-topics.
         */
        function renderCategories() {
            categoriesListDiv.innerHTML = ''; // Clear existing content

            if (appData.categories.length === 0) {
                categoriesListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Chưa có chủ đề nào. Hãy thêm chủ đề mới!</p>';
                return;
            }

            appData.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-purple-100 p-6 rounded-lg shadow-md';
                categoryDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold text-purple-700 mb-4">${category.name}</h3>
                    <div id="topics-for-${category.id}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${category.topics.length === 0 ? '<p class="text-gray-500 col-span-full">Chưa có chủ đề con nào trong mục này.</p>' : ''}
                    </div>
                `;
                categoriesListDiv.appendChild(categoryDiv);

                const topicsContainer = categoryDiv.querySelector(`#topics-for-${category.id}`);
                category.topics.forEach(topic => {
                    const topicCard = document.createElement('div');
                    topicCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-purple-200 flex justify-between items-center';
                    topicCard.innerHTML = `
                        <span class="text-lg font-medium text-gray-800">${topic.name}</span>
                        <div class="flex space-x-2">
                            <button class="text-red-500 hover:text-red-700 delete-topic-btn" data-category-id="${category.id}" data-topic-id="${topic.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    topicsContainer.appendChild(topicCard);
                });
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-topic-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryId = e.currentTarget.dataset.categoryId;
                    const topicId = e.currentTarget.dataset.topicId;
                    deleteTopic(categoryId, topicId);
                });
            });
        }

        addTopicForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const parentCategoryId = parentCategorySelect.value;
            const newTopicName = newTopicNameInput.value.trim();

            if (!newTopicName) {
                showMessage("Tên chủ đề con không được để trống.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === parentCategoryId);
            if (category) {
                // Generate a simple ID for the new topic
                const newTopicId = `${parentCategoryId}-${Date.now()}`;
                category.topics.push({
                    id: newTopicId,
                    name: newTopicName,
                    vocabulary: [], // Initialize with empty vocabulary array
                    results: [], // Initialize with empty results array
                    quizSettings: { mixedQuizQuestionCount: 5, timeLimit: 30 } // Default mixed quiz settings
                });
                saveAppData();
                renderCategories();
                newTopicNameInput.value = ''; // Clear input
                showMessage(`Đã thêm chủ đề "${newTopicName}" vào mục "${category.name}".`, "success");
            } else {
                showMessage("Không tìm thấy mục lớn đã chọn.", "error");
            }
        });

        /**
         * Deletes a sub-topic from a given category.
         * @param {string} categoryId - The ID of the parent category.
         * @param {string} topicId - The ID of the topic to delete.
         */
        function deleteTopic(categoryId, topicId) {
            const categoryIndex = appData.categories.findIndex(cat => cat.id === categoryId);
            if (categoryIndex !== -1) {
                const topicIndex = appData.categories[categoryIndex].topics.findIndex(topic => topic.id === topicId);
                if (topicIndex !== -1) {
                    const deletedTopicName = appData.categories[categoryIndex].topics[topicIndex].name;
                    appData.categories[categoryIndex].topics.splice(topicIndex, 1);
                    saveAppData();
                    renderCategories();
                    showMessage(`Đã xóa chủ đề "${deletedTopicName}".`, "success");
                    // If the deleted topic was currently selected for vocab or quiz, reset selections
                    if (currentTopicId === topicId) {
                        currentTopicId = null;
                        selectTopicForVocab.value = '';
                        selectTopicForQuiz.value = '';
                        selectTopicForPerformance.value = '';
                        vocabContentDiv.classList.add('hidden');
                        performanceContentDiv.classList.add('hidden');
                    }
                    // Re-populate other selects just in case
                    populateTopicSelectForVocab();
                    populateTopicSelectForQuiz();
                    populateTopicSelectForPerformance();
                    renderMultiTopicCheckboxes(); // Update mixed quiz checkboxes
                }
            }
        }

        // --- Vocabulary Management ---

        /**
         * Populates the category select dropdown for vocabulary management.
         */
        function populateCategorySelectForVocab() {
            selectCategoryForVocab.innerHTML = ''; // Clear existing options
            appData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectCategoryForVocab.appendChild(option);
            });
            // Trigger topic select population if a category is selected
            if (selectCategoryForVocab.value) {
                currentCategoryId = selectCategoryForVocab.value;
                populateTopicSelectForVocab();
            } else {
                selectTopicForVocab.innerHTML = '<option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>';
            }
        }

        /**
         * Populates the topic select dropdown based on the selected category for vocabulary management.
         */
        function populateTopicSelectForVocab() {
            selectTopicForVocab.innerHTML = '<option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>'; // Clear existing options
            const selectedCategory = appData.categories.find(cat => cat.id === selectCategoryForVocab.value);
            if (selectedCategory) {
                currentCategoryId = selectedCategory.id; // Update current category ID
                selectedCategory.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.name;
                    selectTopicForVocab.appendChild(option);
                });
            } else {
                currentCategoryId = null;
            }
            vocabContentDiv.classList.add('hidden'); // Hide vocab content if category changes
            currentTopicId = null; // Reset current topic ID
        }

        selectCategoryForVocab.addEventListener('change', populateTopicSelectForVocab);
        selectTopicForVocab.addEventListener('change', function () {
            currentTopicId = this.value;
            if (currentTopicId) {
                vocabContentDiv.classList.remove('hidden');
                renderCurrentTopicVocab();
            } else {
                vocabContentDiv.classList.add('hidden');
            }
        });

        /**
         * Renders the vocabulary table for the currently selected topic.
         */
        function renderCurrentTopicVocab() {
            currentTopicVocabTableBody.innerHTML = '';
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (!topic || topic.vocabulary.length === 0) {
                currentTopicVocabTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>';
                currentVocabCountSpan.textContent = 0;
                return;
            }

            topic.vocabulary.forEach((vocab, index) => {
                const row = currentTopicVocabTableBody.insertRow();
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${vocab.english}</td>
                    <td class="py-3 px-6 text-left">${vocab.vietnamese}</td>
                    <td class="py-3 px-6 text-left">${vocab.example || ''}</td>
                    <td class="py-3 px-6 text-center">
                        <button class="text-blue-500 hover:text-blue-700 mr-2 edit-vocab-btn" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button class="text-red-500 hover:text-red-700 delete-vocab-btn" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
            });
            currentVocabCountSpan.textContent = topic.vocabulary.length;

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-vocab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    editVocab(index);
                });
            });
            document.querySelectorAll('.delete-vocab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteVocab(index);
                });
            });
        }

        addSingleVocabForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!currentTopicId) {
                showMessage("Vui lòng chọn một chủ đề con để thêm từ vựng.", "error");
                return;
            }

            const englishWord = englishWordInput.value.trim();
            const vietnameseMeaning = vietnameseMeaningInput.value.trim();
            const exampleSentence = exampleSentenceInput.value.trim();

            if (!englishWord || !vietnameseMeaning) {
                showMessage("Từ tiếng Anh và Nghĩa tiếng Việt không được để trống.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic) {
                // Check for duplicate vocabulary
                const isDuplicate = topic.vocabulary.some(vocab =>
                    vocab.english.toLowerCase() === englishWord.toLowerCase()
                );
                if (isDuplicate) {
                    showMessage(`Từ "${englishWord}" đã tồn tại trong chủ đề này.`, "error");
                    return;
                }

                topic.vocabulary.push({
                    english: englishWord,
                    vietnamese: vietnameseMeaning,
                    example: exampleSentence,
                    correctAttempts: 0, // Initialize performance counters
                    incorrectAttempts: 0
                });
                saveAppData();
                renderCurrentTopicVocab();
                addSingleVocabForm.reset();
                showMessage(`Đã thêm từ "${englishWord}" vào chủ đề "${topic.name}".`, "success");
            } else {
                showMessage("Không tìm thấy chủ đề hoặc mục lớn đã chọn.", "error");
            }
        });

        bulkImportVocabForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!currentTopicId) {
                showMessage("Vui lòng chọn một chủ đề con để nhập từ vựng.", "error");
                return;
            }

            const bulkText = bulkVocabInput.value.trim();
            if (!bulkText) {
                showMessage("Vui lòng nhập dữ liệu từ vựng.", "error");
                return;
            }

            const lines = bulkText.split('\n').filter(line => line.trim() !== '');
            const newVocabs = [];
            const failedLines = [];

            lines.forEach(line => {
                const parts = line.split(' - ').map(part => part.trim());
                if (parts.length >= 2) {
                    const englishWord = parts[0];
                    const vietnameseMeaning = parts[1];
                    const exampleSentence = parts[2] || '';

                    if (englishWord && vietnameseMeaning) {
                        newVocabs.push({
                            english: englishWord,
                            vietnamese: vietnameseMeaning,
                            example: exampleSentence,
                            correctAttempts: 0,
                            incorrectAttempts: 0
                        });
                    } else {
                        failedLines.push(line);
                    }
                } else {
                    failedLines.push(line);
                }
            });

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic) {
                let addedCount = 0;
                let skippedDuplicates = 0;
                newVocabs.forEach(newVocab => {
                    const isDuplicate = topic.vocabulary.some(vocab =>
                        vocab.english.toLowerCase() === newVocab.english.toLowerCase()
                    );
                    if (!isDuplicate) {
                        topic.vocabulary.push(newVocab);
                        addedCount++;
                    } else {
                        skippedDuplicates++;
                    }
                });

                if (addedCount > 0) {
                    saveAppData();
                    renderCurrentTopicVocab();
                    bulkVocabInput.value = '';
                    let message = `Đã nhập thành công ${addedCount} từ vào chủ đề "${topic.name}".`;
                    if (skippedDuplicates > 0) {
                        message += ` Bỏ qua ${skippedDuplicates} từ trùng lặp.`;
                    }
                    if (failedLines.length > 0) {
                        message += ` Không thể nhập ${failedLines.length} dòng do định dạng sai.`;
                    }
                    showMessage(message, "success");
                } else if (skippedDuplicates > 0) {
                    showMessage(`Tất cả các từ đã nhập đều trùng lặp.`, "error");
                } else if (failedLines.length > 0) {
                    showMessage(`Không có từ nào được nhập. ${failedLines.length} dòng định dạng sai.`, "error");
                } else {
                    showMessage("Không có từ nào được nhập.", "error");
                }
            } else {
                showMessage("Không tìm thấy chủ đề hoặc mục lớn đã chọn.", "error");
            }
        });

        /**
         * Edits a vocabulary item.
         * @param {number} index - The index of the vocabulary item in the array.
         */
        function editVocab(index) {
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (!topic || !topic.vocabulary[index]) {
                showMessage("Không tìm thấy từ vựng để chỉnh sửa.", "error");
                return;
            }

            const vocab = topic.vocabulary[index];
            const newEnglish = prompt("Nhập từ tiếng Anh mới:", vocab.english);
            if (newEnglish === null) return; // User cancelled

            const newVietnamese = prompt("Nhập nghĩa tiếng Việt mới:", vocab.vietnamese);
            if (newVietnamese === null) return; // User cancelled

            const newExample = prompt("Nhập ví dụ câu mới (tùy chọn):", vocab.example || '');
            if (newExample === null) return; // User cancelled

            if (!newEnglish.trim() || !newVietnamese.trim()) {
                showMessage("Từ tiếng Anh và Nghĩa tiếng Việt không được để trống.", "error");
                return;
            }

            // Check for duplicate after edit (excluding itself)
            const isDuplicate = topic.vocabulary.some((v, i) =>
                i !== index && v.english.toLowerCase() === newEnglish.trim().toLowerCase()
            );
            if (isDuplicate) {
                showMessage(`Từ "${newEnglish.trim()}" đã tồn tại trong chủ đề này.`, "error");
                return;
            }

            vocab.english = newEnglish.trim();
            vocab.vietnamese = newVietnamese.trim();
            vocab.example = newExample.trim();
            saveAppData();
            renderCurrentTopicVocab();
            showMessage("Đã cập nhật từ vựng.", "success");
        }

        /**
         * Deletes a vocabulary item.
         * @param {number} index - The index of the vocabulary item in the array.
         */
        function deleteVocab(index) {
            if (!confirm("Bạn có chắc muốn xóa từ này không?")) {
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic && topic.vocabulary[index]) {
                const deletedWord = topic.vocabulary[index].english;
                topic.vocabulary.splice(index, 1);
                saveAppData();
                renderCurrentTopicVocab();
                showMessage(`Đã xóa từ "${deletedWord}".`, "success");
            } else {
                showMessage("Không tìm thấy từ vựng để xóa.", "error");
            }
        }

        // --- Quiz Section ---

        /**
         * Populates the category select dropdown for quiz options.
         */
        function populateCategorySelectForQuiz() {
            selectCategoryForQuiz.innerHTML = ''; // Clear existing options
            appData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectCategoryForQuiz.appendChild(option);
            });
            // Trigger topic select population if a category is selected
            if (selectCategoryForQuiz.value) {
                currentCategoryId = selectCategoryForQuiz.value;
                populateTopicSelectForQuiz();
            } else {
                selectTopicForQuiz.innerHTML = '<option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>';
            }
        }

        /**
         * Populates the topic select dropdown based on the selected category for quiz options.
         */
        function populateTopicSelectForQuiz() {
            selectTopicForQuiz.innerHTML = '<option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>'; // Clear existing options
            const selectedCategory = appData.categories.find(cat => cat.id === selectCategoryForQuiz.value);
            if (selectedCategory) {
                currentCategoryId = selectedCategory.id; // Update current category ID
                selectedCategory.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.name;
                    selectTopicForQuiz.appendChild(option);
                });
            } else {
                currentCategoryId = null;
            }
            currentTopicId = null; // Reset current topic ID for quiz
        }

        selectCategoryForQuiz.addEventListener('change', populateTopicSelectForQuiz);
        selectTopicForQuiz.addEventListener('change', function () {
            currentTopicId = this.value;
        });

        // Event listener for quiz mode radios
        quizModeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                currentQuiz.quizType = event.target.value;
                if (currentQuiz.quizType === 'single') {
                    singleTopicQuizOptionsDiv.classList.remove('hidden');
                    mixedTopicQuizOptionsDiv.classList.add('hidden');
                    // Reset global quiz settings for single topic if needed
                    quizQuestionCountInput.value = 5;
                    quizTimeLimitInput.value = 30;
                    selectCategoryForQuiz.disabled = false;
                    selectTopicForQuiz.disabled = false;
                } else {
                    singleTopicQuizOptionsDiv.classList.add('hidden');
                    mixedTopicQuizOptionsDiv.classList.remove('hidden');
                    renderMultiTopicCheckboxes(); // Render checkboxes for mixed quiz
                    selectCategoryForQuiz.disabled = true; // Disable single topic selections
                    selectTopicForQuiz.disabled = true;
                }
            });
        });

        /**
         * Renders checkboxes and settings for multiple topics in the mixed quiz options.
         */
        function renderMultiTopicCheckboxes() {
            multiTopicCheckboxesDiv.innerHTML = ''; // Clear previous checkboxes

            const allSubTopics = [];
            appData.categories.forEach(category => {
                category.topics.forEach(topic => {
                    if (topic.vocabulary && topic.vocabulary.length > 0) { // Only show topics with vocabulary
                        allSubTopics.push({
                            categoryId: category.id,
                            categoryName: category.name,
                            topicId: topic.id,
                            topicName: topic.name,
                            vocabCount: topic.vocabulary.length,
                            quizSettings: topic.quizSettings || { mixedQuizQuestionCount: 5, timeLimit: 30 }
                        });
                    }
                });
            });

            if (allSubTopics.length === 0) {
                multiTopicCheckboxesDiv.innerHTML = '<p class="text-gray-500 col-span-full">Chưa có chủ đề nào có từ vựng để chọn.</p>';
                return;
            }

            allSubTopics.forEach(topic => {
                const div = document.createElement('div');
                div.className = 'multi-select-option border border-gray-200 rounded-md p-3';

                const checkboxId = `mixed-topic-${topic.topicId}`;
                div.innerHTML = `
                    <label for="${checkboxId}" class="inline-flex items-center w-full cursor-pointer">
                        <input type="checkbox" id="${checkboxId}" value="${topic.topicId}" data-category-id="${topic.categoryId}" class="form-checkbox text-purple-600 h-5 w-5 topic-checkbox">
                        <span class="ml-2 text-gray-800 font-medium">${topic.categoryName} - ${topic.topicName} (${topic.vocabCount} từ)</span>
                    </label>
                    <div class="mt-2 text-gray-700 text-sm pl-7">
                        <label for="qqc-${topic.topicId}" class="block mb-1">Số câu hỏi:</label>
                        <input type="number" id="qqc-${topic.topicId}" value="${topic.quizSettings.mixedQuizQuestionCount}" min="1" max="${topic.vocabCount}"
                               class="w-full p-1 border rounded-md text-gray-700 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-purple-400 quiz-question-count-input" disabled>
                        <label for="qtl-${topic.topicId}" class="block mt-2 mb-1">Thời gian/câu (giây):</label>
                        <input type="number" id="qtl-${topic.topicId}" value="${topic.quizSettings.timeLimit}" min="5"
                               class="w-full p-1 border rounded-md text-gray-700 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-purple-400 quiz-time-limit-input" disabled>
                    </div>
                `;
                multiTopicCheckboxesDiv.appendChild(div);

                // Add event listeners to enable/disable inputs based on checkbox
                const checkbox = div.querySelector('.topic-checkbox');
                const questionCountInput = div.querySelector('.quiz-question-count-input');
                const timeLimitInput = div.querySelector('.quiz-time-limit-input');

                checkbox.addEventListener('change', (event) => {
                    const isChecked = event.target.checked;
                    questionCountInput.disabled = !isChecked;
                    timeLimitInput.disabled = !isChecked;

                    // Update max value for question count input based on vocab count
                    if (isChecked) {
                        questionCountInput.max = topic.vocabCount;
                        if (parseInt(questionCountInput.value) > topic.vocabCount) {
                            questionCountInput.value = topic.vocabCount;
                        }
                    } else {
                        // When unchecked, reset to default or previous value if desired, or just keep disabled
                        questionCountInput.value = topic.quizSettings.mixedQuizQuestionCount;
                        timeLimitInput.value = topic.quizSettings.timeLimit;
                    }
                    // No need to saveAppData here directly, save will happen on input change or start quiz
                });

                // Add event listeners for inputs to save changes immediately
                questionCountInput.addEventListener('change', (event) => {
                    const topicId = topic.topicId;
                    const categoryId = topic.categoryId;
                    let value = parseInt(event.target.value);
                    const max = parseInt(event.target.max);

                    if (isNaN(value) || value < 1) {
                        value = 1;
                        showMessage("Số câu hỏi phải lớn hơn hoặc bằng 1.", "error", 2000);
                    } else if (value > max) {
                        value = max;
                        showMessage(`Số câu hỏi không thể vượt quá số lượng từ vựng (${max}).`, "error", 2000);
                    }
                    event.target.value = value; // Update input value

                    const category = appData.categories.find(cat => cat.id === categoryId);
                    if (category) {
                        const subTopic = category.topics.find(t => t.id === topicId);
                        if (subTopic) {
                            subTopic.quizSettings.mixedQuizQuestionCount = value;
                            saveAppData();
                        }
                    }
                });

                timeLimitInput.addEventListener('change', (event) => {
                    const topicId = topic.topicId;
                    const categoryId = topic.categoryId;
                    let value = parseInt(event.target.value);

                    if (isNaN(value) || value < 5) {
                        value = 5;
                        showMessage("Thời gian giới hạn phải ít nhất 5 giây.", "error", 2000);
                    }
                    event.target.value = value; // Update input value

                    const category = appData.categories.find(cat => cat.id === categoryId);
                    if (category) {
                        const subTopic = category.topics.find(t => t.id === topicId);
                        if (subTopic) {
                            subTopic.quizSettings.timeLimit = value;
                            saveAppData();
                        }
                    }
                });

                // Set initial checked state based on currentQuiz.selectedMixedTopicIds (if re-rendering)
                // And enable/disable inputs accordingly
                if (currentQuiz.selectedMixedTopicIds.includes(topic.topicId)) {
                    checkbox.checked = true;
                    questionCountInput.disabled = false;
                    timeLimitInput.disabled = false;
                }
            });
        }

        startQuizBtn.addEventListener('click', startQuiz);
        retakeQuizBtn.addEventListener('click', () => {
            quizResultsDiv.classList.add('hidden');
            quizSettingsDiv.classList.remove('hidden');
            // Reset to default quiz type if retaking after a mixed quiz
            if (currentQuiz.quizType === 'mixed') {
                document.querySelector('input[name="quizMode"][value="mixed"]').checked = true;
                renderMultiTopicCheckboxes();
                singleTopicQuizOptionsDiv.classList.add('hidden');
                mixedTopicQuizOptionsDiv.classList.remove('hidden');
            } else {
                 document.querySelector('input[name="quizMode"][value="single"]').checked = true;
                 singleTopicQuizOptionsDiv.classList.remove('hidden');
                 mixedTopicQuizOptionsDiv.classList.add('hidden');
            }
        });


        async function startQuiz() {
            if (currentQuiz.quizActive) {
                showMessage("Bài kiểm tra đang diễn ra.", "error");
                return;
            }

            // Reset quiz state
            currentQuiz.questions = [];
            currentQuiz.currentQuestionIndex = 0;
            currentQuiz.score = 0;
            currentQuiz.mixedQuizTopicSettings = {}; // Clear previous settings
            clearInterval(currentQuiz.timerInterval);
            feedbackMessageDiv.classList.add('hidden');
            detailedResultsDiv.innerHTML = '';
            quizResultsDiv.classList.add('hidden');
            cheatDetected = false; // Reset cheat detection status

            const questionCountInputVal = parseInt(quizQuestionCountInput.value);
            const timeLimitInputVal = parseInt(quizTimeLimitInput.value);

            if (currentQuiz.quizType === 'single') {
                if (!currentTopicId) {
                    showMessage("Vui lòng chọn một chủ đề con để kiểm tra.", "error");
                    return;
                }
                const category = appData.categories.find(cat => cat.id === currentCategoryId);
                const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

                if (!topic || topic.vocabulary.length === 0) {
                    showMessage("Chủ đề này chưa có từ vựng hoặc không tồn tại.", "error");
                    return;
                }

                if (questionCountInputVal < 1 || isNaN(questionCountInputVal)) {
                    showMessage("Số lượng câu hỏi phải lớn hơn hoặc bằng 1.", "error");
                    return;
                }
                if (timeLimitInputVal < 5 || isNaN(timeLimitInputVal)) {
                    showMessage("Thời gian giới hạn mỗi câu phải ít nhất 5 giây.", "error");
                    return;
                }

                const availableVocab = [...topic.vocabulary];
                const numQuestions = Math.min(questionCountInputVal, availableVocab.length);

                // Randomly select questions without repetition
                while (currentQuiz.questions.length < numQuestions && availableVocab.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableVocab.length);
                    currentQuiz.questions.push(availableVocab[randomIndex]);
                    availableVocab.splice(randomIndex, 1); // Remove selected vocab to avoid repetition
                }
                currentQuiz.quizTimeLimit = timeLimitInputVal; // Set general time limit for single quiz

            } else { // Mixed quiz
                currentQuiz.selectedMixedTopicIds = [];
                const selectedCheckboxes = multiTopicCheckboxesDiv.querySelectorAll('.topic-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showMessage("Vui lòng chọn ít nhất một chủ đề để kiểm tra hỗn hợp.", "error");
                    return;
                }

                let allSelectedVocab = [];
                let totalQuestionsFromMixed = 0;

                selectedCheckboxes.forEach(checkbox => {
                    const topicId = checkbox.value;
                    const categoryId = checkbox.dataset.categoryId; // Get category ID from data attribute

                    const questionCountInput = document.getElementById(`qqc-${topicId}`);
                    const timeLimitInput = document.getElementById(`qtl-${topicId}`);

                    const topicQuestionCount = parseInt(questionCountInput.value);
                    const topicTimeLimit = parseInt(timeLimitInput.value);

                    if (isNaN(topicQuestionCount) || topicQuestionCount < 1) {
                        showMessage(`Số câu hỏi cho chủ đề "${checkbox.nextElementSibling.textContent.split('(')[0].trim()}" phải lớn hơn hoặc bằng 1.`, "error");
                        return; // Skip this topic if settings are invalid
                    }
                    if (isNaN(topicTimeLimit) || topicTimeLimit < 5) {
                        showMessage(`Thời gian giới hạn cho chủ đề "${checkbox.nextElementSibling.textContent.split('(')[0].trim()}" phải ít nhất 5 giây.`, "error");
                        return; // Skip this topic if settings are invalid
                    }


                    currentQuiz.selectedMixedTopicIds.push(topicId);
                    currentQuiz.mixedQuizTopicSettings[topicId] = {
                        questionCount: topicQuestionCount,
                        timeLimit: topicTimeLimit
                    };

                    const category = appData.categories.find(cat => cat.id === categoryId);
                    const topic = category ? category.topics.find(t => t.id === topicId) : null;

                    if (topic && topic.vocabulary.length > 0) {
                        const availableVocabForTopic = [...topic.vocabulary];
                        const numToSelect = Math.min(topicQuestionCount, availableVocabForTopic.length);
                        totalQuestionsFromMixed += numToSelect;

                        for (let i = 0; i < numToSelect; i++) {
                            const randomIndex = Math.floor(Math.random() * availableVocabForTopic.length);
                            // Add categoryId and topicId to the vocab item for later tracking and time limit retrieval
                            allSelectedVocab.push({
                                ...availableVocabForTopic[randomIndex],
                                _categoryId: categoryId,
                                _topicId: topicId // Add topicId to each vocab question
                            });
                            availableVocabForTopic.splice(randomIndex, 1);
                        }
                    }
                });

                if (totalQuestionsFromMixed === 0) {
                    showMessage("Không có đủ từ vựng để tạo bài kiểm tra với cài đặt này hoặc các cài đặt không hợp lệ.", "error");
                    return;
                }

                // Shuffle all selected vocabulary for a truly mixed quiz
                currentQuiz.questions = shuffleArray(allSelectedVocab);
                // For mixed quiz, quizTimeLimit will be set per question, not globally
                currentQuiz.quizTimeLimit = 0; // Reset as it's not a global limit for mixed quiz
            }

            if (currentQuiz.questions.length === 0) {
                showMessage("Không có đủ từ vựng để tạo bài kiểm tra với cài đặt này.", "error");
                return;
            }

            totalQuizQuestionsSpan.textContent = currentQuiz.questions.length;
            quizSettingsDiv.classList.add('hidden');
            quizArea.classList.remove('hidden');
            currentQuiz.quizActive = true;

            // Store initial window dimensions for cheat detection
            currentQuiz.initialWindowWidth = window.innerWidth;
            currentQuiz.initialWindowHeight = window.innerHeight;

            loadQuestion();
        }

        function loadQuestion() {
            clearInterval(currentQuiz.timerInterval);
            feedbackMessageDiv.classList.add('hidden');
            englishAnswerInput.value = '';
            englishAnswerInput.focus();

            if (currentQuiz.currentQuestionIndex < currentQuiz.questions.length) {
                const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
                currentQuestionNumberSpan.textContent = currentQuiz.currentQuestionIndex + 1;
                vietnameseQuestionSpan.textContent = question.vietnamese;

                // Set time limit based on quiz type
                if (currentQuiz.quizType === 'mixed' && question._topicId && currentQuiz.mixedQuizTopicSettings[question._topicId]) {
                    currentQuiz.timeRemaining = currentQuiz.mixedQuizTopicSettings[question._topicId].timeLimit;
                } else {
                    currentQuiz.timeRemaining = currentQuiz.quizTimeLimit;
                }
                quizTimerSpan.textContent = currentQuiz.timeRemaining;

                currentQuiz.timerInterval = setInterval(() => {
                    currentQuiz.timeRemaining--;
                    quizTimerSpan.textContent = currentQuiz.timeRemaining;
                    if (currentQuiz.timeRemaining <= 0) {
                        clearInterval(currentQuiz.timerInterval);
                        processAnswer(false, true); // Automatically submit as incorrect if time runs out
                    }
                }, 1000);
            } else {
                endQuiz();
            }
        }

        submitAnswerBtn.addEventListener('click', () => {
            if (!currentQuiz.quizActive) return;
            const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            const userAnswer = englishAnswerInput.value.trim().toLowerCase();
            const correctAnswer = currentQuestion.english.toLowerCase();

            processAnswer(userAnswer === correctAnswer);
        });

        englishAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (!currentQuiz.quizActive) return;
                const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
                const userAnswer = englishAnswerInput.value.trim().toLowerCase();
                const correctAnswer = currentQuestion.english.toLowerCase();

                processAnswer(userAnswer === correctAnswer);
            }
        });

        skipQuestionBtn.addEventListener('click', () => {
            if (!currentQuiz.quizActive) return;
            processAnswer(false, true); // Mark as skipped
        });

        function processAnswer(isCorrect, isSkipped = false) {
            clearInterval(currentQuiz.timerInterval); // Stop the timer

            const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            const userAnswer = englishAnswerInput.value.trim().toLowerCase();
            const correctAnswer = currentQuestion.english.toLowerCase();

            let resultClass = '';
            let resultText = '';

            // Find the actual vocab item in appData to update performance counters
            let vocabToUpdate = null;
            if (currentQuiz.quizType === 'single' && currentCategoryId && currentTopicId) {
                const category = appData.categories.find(cat => cat.id === currentCategoryId);
                const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
                vocabToUpdate = topic ? topic.vocabulary.find(v => v.english === currentQuestion.english) : null;
            } else if (currentQuiz.quizType === 'mixed' && currentQuestion._categoryId && currentQuestion._topicId) {
                const category = appData.categories.find(cat => cat.id === currentQuestion._categoryId);
                const topic = category ? category.topics.find(t => t.id === currentQuestion._topicId) : null;
                vocabToUpdate = topic ? topic.vocabulary.find(v => v.english === currentQuestion.english) : null;
            }

            if (isSkipped) {
                resultText = `<span class="font-bold text-gray-500">${currentQuestion.vietnamese}</span>: Bỏ qua. Đáp án đúng là <span class="font-bold text-blue-600">${currentQuestion.english}</span>`;
                resultClass = 'bg-gray-100 text-gray-800';
            } else if (isCorrect) {
                currentQuiz.score++;
                resultText = `<span class="font-bold text-green-600">${currentQuestion.vietnamese}</span>: Đúng! (<span class="font-bold">${currentQuestion.english}</span>)`;
                resultClass = 'bg-green-100 text-green-700';
                if (vocabToUpdate) vocabToUpdate.correctAttempts = (vocabToUpdate.correctAttempts || 0) + 1; // Update performance
            } else {
                resultText = `<span class="font-bold text-red-600">${currentQuestion.vietnamese}</span>: Sai. Đáp án của bạn: "${userAnswer}". Đáp án đúng: <span class="font-bold text-blue-600">${currentQuestion.english}</span>`;
                resultClass = 'bg-red-100 text-red-700';
                if (vocabToUpdate) vocabToUpdate.incorrectAttempts = (vocabToUpdate.incorrectAttempts || 0) + 1; // Update performance
            }

            const resultDiv = document.createElement('div');
            resultDiv.className = `p-3 rounded-md ${resultClass}`;
            resultDiv.innerHTML = resultText;
            detailedResultsDiv.appendChild(resultDiv);

            saveAppData(); // Save updated performance data

            currentQuiz.currentQuestionIndex++;
            if (currentQuiz.currentQuestionIndex < currentQuiz.questions.length) {
                // Show feedback message for a short period before loading next question
                feedbackMessageDiv.innerHTML = `
                    ${isCorrect ? '<span class="text-green-600">Đúng!</span>' : isSkipped ? '<span class="text-gray-600">Đã bỏ qua.</span>' : '<span class="text-red-600">Sai rồi!</span>'}
                    ${isCorrect ? '' : `Đáp án đúng: <span class="font-bold text-blue-600">${currentQuestion.english}</span>`}
                    ${currentQuestion.example ? `<br><span class="text-gray-500 italic">Ví dụ: ${currentQuestion.example}</span>` : ''}
                `;
                feedbackMessageDiv.classList.remove('hidden');
                setTimeout(() => {
                    loadQuestion();
                }, 1500); // Wait 1.5 seconds before next question
            } else {
                endQuiz();
            }
        }

        function endQuiz() {
            clearInterval(currentQuiz.timerInterval);
            currentQuiz.quizActive = false;
            quizArea.classList.add('hidden');
            quizResultsDiv.classList.remove('hidden');

            correctCountSpan.textContent = currentQuiz.score;
            totalCountSpan.textContent = currentQuiz.questions.length;

            const quizResult = {
                date: new Date().toISOString(),
                score: currentQuiz.score,
                total: currentQuiz.questions.length,
                type: currentQuiz.quizType,
                questions: currentQuiz.questions.map(q => ({
                    english: q.english,
                    vietnamese: q.vietnamese,
                    example: q.example,
                    _categoryId: q._categoryId, // Store category for mixed quiz questions
                    _topicId: q._topicId // Store topic for mixed quiz questions
                })) // Store all questions for detailed review
            };

            if (currentQuiz.quizType === 'single') {
                const category = appData.categories.find(cat => cat.id === currentCategoryId);
                const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
                if (topic) {
                    topic.results.push({
                        ...quizResult,
                        topicId: topic.id,
                        topicName: topic.name
                    });
                }
            } else { // Mixed quiz
                // To simplify, we'll save the mixed quiz result to the first category/topic's results array
                // For a more robust solution, you might have a dedicated global 'mixedQuizResults' array
                // or distribute the result object to each included topic's results array.
                // For this example, we'll attach selectedTopics and mixedQuizSettings to the result object
                // and push it to the *first* topic of the *first* category. This is a simplification.
                if (appData.categories.length > 0 && appData.categories[0].topics.length > 0) {
                    appData.categories[0].topics[0].results.push({
                        ...quizResult,
                        selectedTopics: currentQuiz.selectedMixedTopicIds,
                        mixedQuizSettings: currentQuiz.mixedQuizTopicSettings // Stores settings for each selected topic
                    });
                }
            }
            saveAppData(); // Save updated appData

            // Re-render performance table if currently on performance section and selected topic is relevant
            if (document.getElementById('performance-section').classList.contains('active')) {
                renderPerformanceTable();
                renderVocabPerformanceTable();
            }
        }

        // --- Cheat Detection ---
        closeCheatMessageBtn.addEventListener('click', () => {
            cheatDetectionMessage.classList.add('hidden');
            // Allow restarting quiz if cheat detected and message closed
            quizArea.classList.add('hidden');
            quizSettingsDiv.classList.remove('hidden');
            currentQuiz.quizActive = false; // Ensure quiz is not active
            clearInterval(currentQuiz.timerInterval); // Clear any lingering timer
        });

        function handleCheatDetection() {
            if (!currentQuiz.quizActive || cheatDetected) return;

            // Check if window is hidden or changed tab
            if (document.hidden || !document.hasFocus()) {
                cheatDetected = true;
            }

            // Check for window resize significantly
            const currentWindowWidth = window.innerWidth;
            const currentWindowHeight = window.innerHeight;
            const widthThreshold = 0.10; // 10% change
            const heightThreshold = 0.10; // 10% change

            const widthDiff = Math.abs(currentWindowWidth - currentQuiz.initialWindowWidth) / currentQuiz.initialWindowWidth;
            const heightDiff = Math.abs(currentWindowHeight - currentQuiz.initialWindowHeight) / currentQuiz.initialWindowHeight;

            if (widthDiff > widthThreshold || heightDiff > heightThreshold) {
                cheatDetected = true;
            }

            if (cheatDetected) {
                clearInterval(currentQuiz.timerInterval);
                currentQuiz.quizActive = false; // Deactivate quiz
                cheatDetectionMessage.classList.remove('hidden'); // Show cheat message
                quizArea.classList.add('hidden'); // Hide quiz area
            }
        }

        // Listen for visibility changes (tab switching)
        document.addEventListener('visibilitychange', handleCheatDetection);
        // Listen for focus changes (window minimizing/maximizing)
        window.addEventListener('focus', () => {
            if (currentQuiz.quizActive && cheatDetected) {
                handleCheatDetection(); // Re-check if focus returns and cheat was already detected
            }
        });
        window.addEventListener('blur', handleCheatDetection);
        // Listen for resize changes
        window.addEventListener('resize', handleCheatDetection);

        // --- Performance Section ---

        /**
         * Populates the category select dropdown for performance section.
         */
        function populateCategorySelectForPerformance() {
            selectCategoryForPerformance.innerHTML = ''; // Clear existing options
            appData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectCategoryForPerformance.appendChild(option);
            });
            if (selectCategoryForPerformance.value) {
                currentCategoryId = selectCategoryForPerformance.value;
                populateTopicSelectForPerformance();
            } else {
                selectTopicForPerformance.innerHTML = '<option value="">-- Chọn chủ đề con để xem hiệu suất --</option>';
            }
        }

        /**
         * Populates the topic select dropdown based on the selected category for performance section.
         */
        function populateTopicSelectForPerformance() {
            selectTopicForPerformance.innerHTML = '<option value="">-- Chọn chủ đề con để xem hiệu suất --</option>'; // Clear existing options
            const selectedCategory = appData.categories.find(cat => cat.id === selectCategoryForPerformance.value);
            if (selectedCategory) {
                currentCategoryId = selectedCategory.id;
                selectedCategory.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.name;
                    selectTopicForPerformance.appendChild(option);
                });
            } else {
                currentCategoryId = null;
            }
            currentTopicId = null; // Reset current topic ID for performance
        }

        selectCategoryForPerformance.addEventListener('change', populateTopicSelectForPerformance);
        selectTopicForPerformance.addEventListener('change', function () {
            currentTopicId = this.value;
            if (currentTopicId) {
                performanceContentDiv.classList.remove('hidden');
                renderPerformanceTable();
                renderVocabPerformanceTable();
            } else {
                performanceContentDiv.classList.add('hidden');
            }
        });

        /**
         * Renders the quiz history table for the selected topic.
         */
        function renderPerformanceTable() {
            performanceTableBody.innerHTML = '';
            const selectedCategory = appData.categories.find(cat => cat.id === selectCategoryForPerformance.value);
            const selectedTopic = selectedCategory ? selectedCategory.topics.find(t => t.id === selectTopicForPerformance.value) : null;

            if (!selectedTopic) {
                performanceTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Vui lòng chọn một chủ đề con để xem lịch sử bài kiểm tra.</td></tr>';
                return;
            }

            if (selectedTopic.results.length === 0) {
                performanceTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Chưa có lịch sử bài kiểm tra cho chủ đề này.</td></tr>';
                return;
            }

            selectedTopic.results.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first

            selectedTopic.results.forEach(result => {
                const row = performanceTableBody.insertRow();
                const date = new Date(result.date).toLocaleString('vi-VN', {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const scoreText = `${result.score} / ${result.total}`;
                let typeText = result.type === 'single' ? 'Đơn chủ đề' : 'Hỗn hợp';
                let detailButtonHtml = '';

                if (result.type === 'mixed') {
                    typeText += ` (${result.selectedTopics ? result.selectedTopics.length : 0} chủ đề)`;
                    detailButtonHtml = `<button class="view-mixed-quiz-details text-blue-500 hover:text-blue-700 font-semibold text-sm" data-result='${JSON.stringify(result)}'>Xem chi tiết</button>`;
                }

                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${date}</td>
                    <td class="py-3 px-6 text-left">${scoreText}</td>
                    <td class="py-3 px-6 text-left">${result.total}</td>
                    <td class="py-3 px-6 text-left">${typeText}</td>
                    <td class="py-3 px-6 text-center">${detailButtonHtml}</td>
                `;
            });

            // Add event listeners for "Xem chi tiết" buttons
            document.querySelectorAll('.view-mixed-quiz-details').forEach(button => {
                button.addEventListener('click', (e) => {
                    const resultData = JSON.parse(e.currentTarget.dataset.result);
                    showMixedQuizDetailsModal(resultData);
                });
            });
        }

        /**
         * Renders the vocabulary performance table for the selected topic.
         */
        function renderVocabPerformanceTable() {
            vocabPerformanceTableBody.innerHTML = '';
            const selectedCategory = appData.categories.find(cat => cat.id === selectCategoryForPerformance.value);
            const selectedTopic = selectedCategory ? selectedCategory.topics.find(t => t.id === selectTopicForPerformance.value) : null;

            if (!selectedTopic) {
                vocabPerformanceTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Vui lòng chọn một chủ đề con để xem hiệu suất từ vựng.</td></tr>';
                return;
            }

            if (selectedTopic.vocabulary.length === 0) {
                vocabPerformanceTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>';
                return;
            }

            // Sort vocabulary by performance (e.g., lowest correct rate first)
            const sortedVocab = [...selectedTopic.vocabulary].sort((a, b) => {
                const totalA = a.correctAttempts + a.incorrectAttempts;
                const totalB = b.correctAttempts + b.incorrectAttempts;

                if (totalA === 0 && totalB === 0) return 0;
                if (totalA === 0) return -1; // Words not attempted come first
                if (totalB === 0) return 1;

                const ratioA = a.correctAttempts / totalA;
                const ratioB = b.correctAttempts / totalB;
                return ratioA - ratioB; // Ascending order of correct ratio
            });

            sortedVocab.forEach(vocab => {
                const totalAttempts = vocab.correctAttempts + vocab.incorrectAttempts;
                const correctRate = totalAttempts > 0 ? ((vocab.correctAttempts / totalAttempts) * 100).toFixed(2) : 'N/A';

                const row = vocabPerformanceTableBody.insertRow();
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${vocab.english}</td>
                    <td class="py-3 px-6 text-left">${vocab.correctAttempts}</td>
                    <td class="py-3 px-6 text-left">${vocab.incorrectAttempts}</td>
                    <td class="py-3 px-6 text-left">${correctRate}%</td>
                `;
            });
        }

        /**
         * Shows a modal with details of a mixed quiz.
         * @param {object} resultData - The quiz result object.
         */
        function showMixedQuizDetailsModal(resultData) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close-btn">&times;</span>
                    <h3 class="text-2xl font-bold text-purple-700 mb-4">Chi Tiết Bài Kiểm Tra Hỗn Hợp</h3>
                    <p class="text-lg mb-2">Ngày: ${new Date(resultData.date).toLocaleString('vi-VN')}</p>
                    <p class="text-lg mb-4">Điểm: ${resultData.score} / ${resultData.total}</p>
                    <h4 class="text-xl font-semibold text-purple-600 mb-2">Các Chủ Đề Đã Chọn:</h4>
                    <ul class="list-disc list-inside space-y-1 max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-md">
                        ${resultData.selectedTopics.map(topicId => {
                            const category = appData.categories.find(cat => cat.topics.some(t => t.id === topicId));
                            const topic = category ? category.topics.find(t => t.id === topicId) : null;
                            const settings = resultData.mixedQuizSettings[topicId];
                            if (topic) {
                                return `<li>${category.name} - ${topic.name} (${settings ? settings.questionCount : 'N/A'} câu, ${settings ? settings.timeLimit : 'N/A'} giây/câu)</li>`;
                            }
                            return '';
                        }).join('')}
                    </ul>
                    <h4 class="text-xl font-semibold text-purple-600 mt-4 mb-2">Các Câu Hỏi Trong Bài:</h4>
                    <ul class="list-disc list-inside space-y-1 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md">
                        ${resultData.questions.map(q => `<li>${q.english} - ${q.vietnamese}</li>`).join('')}
                    </ul>
                </div>
            `;
            document.body.appendChild(modalOverlay);

            // Animate in
            setTimeout(() => {
                modalOverlay.classList.add('show');
            }, 10); // Small delay to allow reflow

            const closeBtn = modalOverlay.querySelector('.modal-close-btn');
            closeBtn.addEventListener('click', () => {
                modalOverlay.classList.remove('show');
                setTimeout(() => {
                    modalOverlay.remove();
                }, 300); // Wait for transition to finish
            });

            // Close when clicking outside
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('show');
                    setTimeout(() => {
                        modalOverlay.remove();
                    }, 300);
                }
            });
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppData();
            // Initialize the first section based on active class in HTML or default
            const initialActiveSection = document.querySelector('.section.active');
            if (initialActiveSection) {
                const navLinkForActiveSection = document.querySelector(`.nav-link[href="#${initialActiveSection.id}"]`);
                if (navLinkForActiveSection) {
                    navLinkForActiveSection.classList.add('active-nav-link');
                }
                // Manually trigger rendering for the initially active section
                if (initialActiveSection.id === 'topics-section') {
                    renderCategories();
                    populateParentCategorySelect();
                }
            } else {
                // Fallback to topics section if no active section defined
                document.getElementById('topics-section').classList.add('active');
                document.querySelector('.nav-link[href="#topics-section"]').classList.add('active-nav-link');
                renderCategories();
                populateParentCategorySelect();
            }

            // Initial rendering for quiz section if it's the default view on load
            // This is important for mixed quiz checkboxes to show if selected as default quiz type
            if (currentQuiz.quizType === 'mixed') {
                singleTopicQuizOptionsDiv.classList.add('hidden');
                mixedTopicQuizOptionsDiv.classList.remove('hidden');
                renderMultiTopicCheckboxes();
            } else {
                singleTopicQuizOptionsDiv.classList.remove('hidden');
                mixedTopicQuizOptionsDiv.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
