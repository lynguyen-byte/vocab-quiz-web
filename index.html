<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Dò Từ Vựng Của Bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            /* Changed background to light purple */
            @apply bg-purple-50 text-gray-800;
        }
        /* Hide sections by default, show only active one */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }
        /* Active navigation link style */
        .active-nav-link {
            @apply bg-gray-700;
        }
        /* Style for multi-select checkboxes */
        .multi-select-option {
            @apply block p-2 rounded-md hover:bg-purple-100 cursor-pointer;
        }
        .multi-select-option input[type="checkbox"] {
            @apply mr-2;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            visibility: hidden; /* Added to hide completely when not shown */
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible; /* Added to make visible */
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: relative; /* For close button */
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #4b5563; /* Tailwind gray-600 */
        }
        .modal-close-btn:hover {
            color: #1f2937; /* Tailwind gray-800 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 shadow-lg">
        <div class="container mx-auto text-center">
            <h1 class="text-4xl font-bold mb-2">Trang Web Dò Từ Vựng Của Bạn</h1>
            <p class="text-xl opacity-90">Học, quản lý và kiểm tra từ vựng theo chủ đề!</p>
        </div>
    </header>
    <nav class="bg-gray-800 text-white shadow-md">
        <ul class="container mx-auto flex justify-center py-3">
            <li><a href="#topics-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md active-nav-link">Chủ Đề</a></li>
            <li><a href="#vocabulary-management-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Quản Lý Từ Vựng</a></li>
            <li><a href="#quiz-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Kiểm Tra</a></li>
            <li><a href="#performance-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Hiệu Suất Học Tập</a></li>
        </ul>
    </nav>
    <main class="container mx-auto mt-8 p-6 bg-white rounded-lg shadow-xl flex-grow">
        <div id="generalMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <section id="topics-section" class="section active">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Chủ Đề</h2>
            <div class="bg-purple-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Thêm Chủ Đề Con Mới</h3>
                <form id="addTopicForm" class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="parentCategorySelect" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                        <select id="parentCategorySelect"
                                class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </select>
                    </div>
                    <div class="flex-grow w-full">
                        <label for="newTopicName" class="block text-gray-700 text-sm font-bold mb-2">Tên Chủ Đề Con:</label>
                        <input type="text" id="newTopicName" placeholder="Ví dụ: Level 1, Idioms"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <button type="submit"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Thêm Chủ Đề
                    </button>
                </form>
            </div>
            <h3 class="text-2xl font-medium text-purple-600 mb-4">Các Chủ Đề Hiện Có</h3>
            <div id="categoriesList" class="space-y-8">
                <p class="text-gray-500 text-center col-span-full">Đang tải chủ đề...</p>
            </div>
        </section>

        <section id="vocabulary-management-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Từ Vựng</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </select>
                </div>
                <div>
                    <label for="selectTopicForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con:</label>
                    <select id="selectTopicForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>
                    </select>
                </div>
            </div>
            <div id="vocabContent" class="hidden">
                <div class="bg-green-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-green-700 mb-4">Thêm Từ Vựng Riêng Lẻ</h3>
                    <form id="addSingleVocabForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="englishWord" class="block text-gray-700 text-sm font-bold mb-2">Từ Tiếng Anh:</label>
                            <input type="text" id="englishWord" placeholder="Ví dụ: beautiful"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="vietnameseMeaning" class="block text-gray-700 text-sm font-bold mb-2">Nghĩa Tiếng Việt (phân tách bằng dấu phẩy):</label>
                            <input type="text" id="vietnameseMeaning" placeholder="Ví dụ: đẹp, xinh đẹp"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="exampleSentence" class="block text-gray-700 text-sm font-bold mb-2">Ví Dụ Câu (tùy chọn):</label>
                            <textarea id="exampleSentence" rows="2" placeholder="Ví dụ: She has a beautiful smile."
                                      class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>
                        <div class="md:col-span-2 text-right">
                            <button type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Thêm Từ
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-yellow-700 mb-4">Nhập Từ Vựng Hàng Loạt</h3>
                    <p class="text-gray-600 mb-4">Nhập mỗi từ trên một dòng theo định dạng: <code class="bg-gray-200 p-1 rounded">English Word - Vietnamese Meaning (phân tách bằng dấu phẩy) - Example Sentence (optional)</code></p>
                    <form id="bulkImportVocabForm">
                        <textarea id="bulkVocabInput" rows="8" placeholder="Ví dụ:
apple - quả táo, táo tây - I like to eat an apple.
book - cuốn sách - Read a good book.
run - chạy - He can run fast."
                                  class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent mb-4"></textarea>
                        <div class="text-right">
                            <button type="submit"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Nhập Hàng Loạt
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-2xl font-medium text-purple-600 mb-4">Từ Vựng Trong Chủ Đề Này (<span id="currentVocabCount">0</span> từ)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Nghĩa Tiếng Việt</th>
                                <th class="py-3 px-6 text-left">Ví Dụ</th>
                                <th class="py-3 px-6 text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="currentTopicVocabTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="quiz-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Kiểm Tra Từ Vựng</h2>
            <div class="mb-6 bg-purple-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-medium text-purple-700 mb-4">Chọn Loại Bài Kiểm Tra</h3>
                <div class="flex flex-wrap items-center space-x-4 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="single" checked class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra theo Chủ đề</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="mixed" class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra ngẫu nhiên từ nhiều Chủ đề</span>
                    </label>
                </div>

                <div id="singleTopicQuizOptions">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="selectCategoryForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                            <select id="selectCategoryForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </select>
                        </div>
                        <div>
                            <label for="selectTopicForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Kiểm Tra:</label>
                            <select id="selectTopicForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="mixedTopicQuizOptions" class="hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chọn các Chủ Đề Con để ôn tập:</label>
                    <div id="multiTopicCheckboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 bg-white p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 col-span-full">Chưa có chủ đề nào để chọn.</p>
                    </div>
                </div>

                <div id="quizSettings" class="mt-6">
                    <h3 class="text-2xl font-medium text-purple-700 mb-4">Cài Đặt Bài Kiểm Tra</h3>
                    <div class="mb-4">
                        <label for="quizQuestionCount" class="block text-gray-700 text-sm font-bold mb-2">Số lượng câu hỏi:</label>
                        <input type="number" id="quizQuestionCount" value="5" min="1"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label for="quizTimeLimit" class="block text-gray-700 text-sm font-bold mb-2">Thời gian giới hạn mỗi từ (giây):</label>
                        <input type="number" id="quizTimeLimit" value="30" min="5"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hướng kiểm tra:</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="quizDirection" value="viet-to-eng" checked class="form-radio text-purple-600 h-5 w-5">
                                <span class="ml-2 text-gray-700">Việt - Anh</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="quizDirection" value="eng-to-viet" class="form-radio text-purple-600 h-5 w-5">
                                <span class="ml-2 text-gray-700">Anh - Việt</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="quizDirection" value="random" class="form-radio text-purple-600 h-5 w-5">
                                <span class="ml-2 text-gray-700">Ngẫu nhiên</span>
                            </label>
                        </div>
                    </div>
                    <button id="startQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Bắt Đầu Kiểm Tra
                    </button>
                </div>
            </div>

            <div id="quizArea" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xl font-semibold text-gray-700">
                        Câu hỏi <span id="currentQuestionNumber">1</span>/<span id="totalQuizQuestions">5</span>
                        <span class="ml-4 text-green-600">Đúng: <span id="quizCorrectCount">0</span></span>
                        <span class="ml-2 text-red-600">Sai: <span id="quizIncorrectCount">0</span></span>
                    </span>
                    <span class="text-2xl font-bold text-red-600" id="quizTimer">30</span>
                </div>
                <div class="text-center mb-8">
                    <p class="text-3xl font-bold text-purple-800 mb-4">
                        <span id="quizQuestion"></span>
                    </p>
                    <input type="text" id="englishAnswerInput" placeholder="Nhập đáp án của bạn..."
                           class="shadow appearance-none border rounded-lg w-full max-w-md py-4 px-6 text-gray-700 text-2xl leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center">
                </div>
                <div id="feedbackMessage" class="hidden text-center mt-4 text-lg font-semibold"></div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="submitAnswerBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Nộp Đáp Án
                    </button>
                    <button id="skipQuestionBtn"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Bỏ Qua
                    </button>
                </div>
            </div>

            <div id="quizResults" class="hidden bg-white p-8 rounded-lg shadow-lg mt-8">
                <h3 class="text-3xl font-bold text-purple-700 mb-6 text-center">Kết Quả Bài Kiểm Tra</h3>
                <p class="text-xl text-center mb-4">Bạn đã trả lời đúng <span id="correctCount" class="font-bold text-green-600">0</span> trên <span id="totalCount" class="font-bold text-purple-600">0</span> câu.</p>
                <div id="detailedResults" class="space-y-4">
                    </div>
                <div class="text-center mt-8">
                    <button id="retakeQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Làm Lại Bài Kiểm Tra
                    </button>
                </div>
            </div>

            <div id="cheatDetectionMessage" class="hidden fixed inset-0 bg-red-800 bg-opacity-90 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-md">
                    <h3 class="text-3xl font-bold text-red-700 mb-4">Phát Hiện Gian Lận!</h3>
                    <p class="text-lg text-gray-700 mb-6">Bạn đã chuyển khỏi tab hoặc cửa sổ trong khi làm bài kiểm tra. Bài kiểm tra này sẽ bị hủy.</p>
                    <button id="closeCheatMessageBtn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Đóng
                    </button>
                </div>
            </div>
        </section>

        <section id="performance-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Hiệu Suất Học Tập</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForPerformance" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForPerformance"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </select>
                </div>
                <div>
                    <label for="selectTopicForPerformance" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Xem Hiệu Suất:</label>
                    <select id="selectTopicForPerformance"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để xem hiệu suất --</option>
                    </select>
                </div>
            </div>
            <div id="performanceContent" class="hidden">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Lịch Sử Bài Kiểm Tra</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Ngày</th>
                                <th class="py-3 px-6 text-left">Điểm</th>
                                <th class="py-3 px-6 text-left">Tổng số câu</th>
                                <th class="py-3 px-6 text-left">Loại bài</th>
                                <th class="py-3 px-6 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="performanceTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="5" class="py-4 text-center text-gray-500">Chưa có lịch sử bài kiểm tra cho chủ đề này.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-2xl font-medium text-purple-600 mb-4">Hiệu Suất Từ Vựng Cá Nhân</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Nghĩa Tiếng Việt</th>
                                <th class="py-3 px-6 text-center">Số lần Đúng</th>
                                <th class="py-3 px-6 text-center">Số lần Sai</th>
                            </tr>
                        </thead>
                        <tbody id="individualVocabPerformanceBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chưa có dữ liệu hiệu suất từ vựng cá nhân cho chủ đề này.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="quizDetailsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeQuizDetailsModal">&times;</span>
            <h3 class="text-2xl font-bold text-purple-700 mb-4 text-center">Chi Tiết Bài Kiểm Tra</h3>
            <p class="text-lg mb-4"><span class="font-semibold">Ngày:</span> <span id="modalQuizDate"></span></p>
            <p class="text-lg mb-4"><span class="font-semibold">Điểm:</span> <span id="modalQuizScore"></span>/<span id="modalQuizTotal"></span></p>
            <p class="text-lg mb-6"><span class="font-semibold">Loại bài:</span> <span id="modalQuizType"></span></p>
            <div id="modalDetailedResults" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                </div>
        </div>
    </div>

    <script>
        // Global variables for managing application data and state
        const APP_DATA_KEY = 'myVocabularyApp'; // Key for storing data in localStorage
        let appData = {
            categories: [] // Array containing main categories (Ken, Nhím), each category has an ID, name, and an array of sub-topics
        };
        let currentCategoryId = null; // ID of the currently selected main category
        let currentTopicId = null; // ID of the currently selected sub-topic

        let currentQuiz = {
            questions: [], // Array of questions in the current quiz
            currentQuestionIndex: 0,
            score: 0,
            correctCount: 0,
            incorrectCount: 0,
            timerInterval: null,
            timeRemaining: 0,
            quizActive: false, // Quiz active status
            quizTimeLimit: 30, // Default time limit for each question
            quizType: 'single', // 'single' or 'mixed'
            selectedMixedTopicIds: [], // For mixed quizzes, stores IDs of topics included
            quizDirection: 'viet-to-eng' // Mặc định là Việt -> Anh, thêm 'eng-to-viet' hoặc 'random'
        };

        // --- DOM Elements ---
        const generalMessage = document.getElementById('generalMessage');

        // Elements for Topic Management section
        const addTopicForm = document.getElementById('addTopicForm');
        const parentCategorySelect = document.getElementById('parentCategorySelect');
        const newTopicNameInput = document.getElementById('newTopicName');
        const categoriesListDiv = document.getElementById('categoriesList');

        // Elements for Vocabulary Management section
        const selectCategoryForVocab = document.getElementById('selectCategoryForVocab');
        const selectTopicForVocab = document.getElementById('selectTopicForVocab');
        const vocabContentDiv = document.getElementById('vocabContent');
        const addSingleVocabForm = document.getElementById('addSingleVocabForm');
        const englishWordInput = document.getElementById('englishWord');
        const vietnameseMeaningInput = document.getElementById('vietnameseMeaning');
        const exampleSentenceInput = document.getElementById('exampleSentence');
        const bulkImportVocabForm = document.getElementById('bulkImportVocabForm');
        const bulkVocabInput = document.getElementById('bulkVocabInput');
        const currentTopicVocabTableBody = document.getElementById('currentTopicVocabTableBody');
        const currentVocabCountSpan = document.getElementById('currentVocabCount');

        // Elements for Quiz section
        const quizModeRadios = document.querySelectorAll('input[name="quizMode"]');
        const singleTopicQuizOptionsDiv = document.getElementById('singleTopicQuizOptions');
        const mixedTopicQuizOptionsDiv = document.getElementById('mixedTopicQuizOptions');
        const multiTopicCheckboxesDiv = document.getElementById('multiTopicCheckboxes');

        const selectCategoryForQuiz = document.getElementById('selectCategoryForQuiz');
        const selectTopicForQuiz = document.getElementById('selectTopicForQuiz');
        const quizSettingsDiv = document.getElementById('quizSettings');
        const quizQuestionCountInput = document.getElementById('quizQuestionCount');
        const quizTimeLimitInput = document.getElementById('quizTimeLimit');
        const quizDirectionRadios = document.querySelectorAll('input[name="quizDirection"]');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const quizArea = document.getElementById('quizArea');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const totalQuizQuestionsSpan = document.getElementById('totalQuizQuestions');
        const quizCorrectCountSpan = document.getElementById('quizCorrectCount');
        const quizIncorrectCountSpan = document.getElementById('quizIncorrectCount');
        const quizTimerSpan = document.getElementById('quizTimer');
        const quizQuestionSpan = document.getElementById('quizQuestion');
        const englishAnswerInput = document.getElementById('englishAnswerInput');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const skipQuestionBtn = document.getElementById('skipQuestionBtn');
        const feedbackMessageDiv = document.getElementById('feedbackMessage');
        const quizResultsDiv = document.getElementById('quizResults');
        const correctCountSpan = document.getElementById('correctCount');
        const totalCountSpan = document.getElementById('totalCount');
        const detailedResultsDiv = document.getElementById('detailedResults');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const cheatDetectionMessage = document.getElementById('cheatDetectionMessage');
        const closeCheatMessageBtn = document.getElementById('closeCheatMessageBtn');

        // Elements for Performance section
        const selectCategoryForPerformance = document.getElementById('selectCategoryForPerformance');
        const selectTopicForPerformance = document.getElementById('selectTopicForPerformance');
        const performanceContentDiv = document.getElementById('performanceContent');
        const performanceTableBody = document.getElementById('performanceTableBody');
        const individualVocabPerformanceBody = document.getElementById('individualVocabPerformanceBody');

        // Quiz Details Modal
        const quizDetailsModal = document.getElementById('quizDetailsModal');
        const closeQuizDetailsModalBtn = document.getElementById('closeQuizDetailsModal');
        const modalQuizDate = document.getElementById('modalQuizDate');
        const modalQuizScore = document.getElementById('modalQuizScore');
        const modalQuizTotal = document.getElementById('modalQuizTotal');
        const modalQuizType = document.getElementById('modalQuizType');
        const modalDetailedResults = document.getElementById('modalDetailedResults');


        // Navigation elements
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');

        // --- General Utility Functions ---

        /**
         * Displays a temporary message to the user.
         * @param {string} text - The message to display.
         * @param {string} type - 'success' for green, 'error' for red.
         * @param {number} duration - How long the message is visible in milliseconds.
         */
        function showMessage(text, type = 'success', duration = 3000) {
            generalMessage.textContent = text;
            generalMessage.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            generalMessage.classList.remove('hidden');
            setTimeout(() => {
                generalMessage.classList.add('hidden');
            }, duration);
        }

        /**
         * Generates a simple unique ID.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        }

        /**
         * Saves the entire appData object to localStorage.
         */
        function saveAppData() {
            try {
                localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showMessage("Lỗi khi lưu dữ liệu. Có thể bộ nhớ đầy.", "error");
            }
        }

        /**
         * Loads appData from localStorage. Initializes default categories if not found.
         */
        function loadAppData() {
            try {
                const storedData = localStorage.getItem(APP_DATA_KEY);
                if (storedData) {
                    appData = JSON.parse(storedData);
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                showMessage("Lỗi khi tải dữ liệu. Đang tải dữ liệu mặc định.", "error");
                appData = { categories: [] }; // Reset to default if loading fails
            }

            // Ensure default categories exist and have required properties
            let kenExists = false;
            let nhimExists = false;
            appData.categories.forEach(cat => {
                if (cat.id === 'ken') kenExists = true;
                if (cat.id === 'nhim') nhimExists = true;
                cat.topics.forEach(topic => {
                    if (!topic.results) {
                        topic.results = []; // Initialize results array for existing topics if not present
                    }
                    if (!topic.vocabulary) {
                        topic.vocabulary = []; // Ensure vocabulary array exists
                    }
                    topic.vocabulary.forEach(vocab => {
                        if (vocab.correctAttempts === undefined) vocab.correctAttempts = 0;
                        if (vocab.incorrectAttempts === undefined) vocab.incorrectAttempts = 0;
                        if (!vocab.id) vocab.id = generateUniqueId(); // Assign ID if missing
                    });
                });
            });

            // Add default categories if they don't exist
            if (!kenExists) {
                appData.categories.unshift({ id: 'ken', name: 'Ken', topics: [] });
            }
            if (!nhimExists) {
                appData.categories.unshift({ id: 'nhim', name: 'Nhím', topics: [] });
            }
            saveAppData(); // Save updated appData with default categories if they were added
        }

        /**
         * Populates all category select dropdowns.
         */
        function populateCategorySelects() {
            const selects = [parentCategorySelect, selectCategoryForVocab, selectCategoryForQuiz, selectCategoryForPerformance];
            selects.forEach(selectElement => {
                selectElement.innerHTML = ''; // Clear existing options
                if (selectElement.id === 'parentCategorySelect') {
                     // No default "select category" option for parentCategorySelect
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = `-- Chọn mục lớn --`;
                    selectElement.appendChild(defaultOption);
                }

                appData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    selectElement.appendChild(option);
                });
            });

            // Set initial selected category for relevant sections if categories exist
            if (appData.categories.length > 0) {
                currentCategoryId = appData.categories[0].id;
                parentCategorySelect.value = currentCategoryId; // Set default for adding new topics
                selectCategoryForVocab.value = currentCategoryId;
                selectCategoryForQuiz.value = currentCategoryId;
                selectCategoryForPerformance.value = currentCategoryId;
                // Trigger change to populate topic selects immediately
                populateTopicSelects(currentCategoryId, selectTopicForVocab, 'Chọn chủ đề con để quản lý từ vựng');
                populateTopicSelects(currentCategoryId, selectTopicForQuiz, 'Chọn chủ đề con để bắt đầu kiểm tra');
                populateTopicSelects(currentCategoryId, selectTopicForPerformance, 'Chọn chủ đề con để xem hiệu suất');
            } else {
                currentCategoryId = null; // No categories available
                // Disable topic selects if no categories
                selectTopicForVocab.disabled = true;
                selectTopicForQuiz.disabled = true;
                selectTopicForPerformance.disabled = true;
            }
        }

        /**
         * Populates the topic select dropdown for a given category.
         * @param {string} categoryId - The ID of the parent category.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         * @param {string} placeholderText - The default placeholder text for the first option.
         */
        function populateTopicSelects(categoryId, selectElement, placeholderText) {
            selectElement.innerHTML = `<option value="">-- ${placeholderText} --</option>`;
            selectElement.disabled = false; // Enable by default
            const category = appData.categories.find(cat => cat.id === categoryId);
            if (category) {
                category.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.name;
                    selectElement.appendChild(option);
                });
            } else {
                selectElement.disabled = true; // Disable if no category is selected or found
            }
            currentTopicId = null; // Reset current topic ID when category changes
            vocabContentDiv.classList.add('hidden'); // Hide vocab content
            performanceContentDiv.classList.add('hidden'); // Hide performance content
        }

        /**
         * Renders the list of categories and topics in the Topic Management section.
         */
        function renderCategoriesAndTopics() {
            categoriesListDiv.innerHTML = ''; // Clear existing content
            if (appData.categories.length === 0) {
                categoriesListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Chưa có chủ đề nào. Hãy thêm chủ đề mới!</p>';
                return;
            }

            appData.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-gray-100 p-6 rounded-lg shadow-md';
                categoryDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${category.name}</h3>
                    <div class="space-y-3" id="topics-for-category-${category.id}">
                        ${category.topics.length === 0 ? '<p class="text-gray-500">Chưa có chủ đề con nào trong mục này.</p>' : ''}
                    </div>
                `;
                categoriesListDiv.appendChild(categoryDiv);

                const topicsContainer = categoryDiv.querySelector(`#topics-for-category-${category.id}`);
                category.topics.forEach(topic => {
                    const topicItem = document.createElement('div');
                    topicItem.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
                    topicItem.innerHTML = `
                        <span class="text-gray-700 font-medium">${topic.name} (${topic.vocabulary.length} từ)</span>
                        <div>
                            <button data-topic-id="${topic.id}" data-category-id="${category.id}" class="edit-topic-btn bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded-md mr-2">Sửa</button>
                            <button data-topic-id="${topic.id}" data-category-id="${category.id}" class="delete-topic-btn bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded-md">Xóa</button>
                        </div>
                    `;
                    topicsContainer.appendChild(topicItem);
                });
            });

            // Add event listeners for edit/delete buttons
            document.querySelectorAll('.edit-topic-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const topicId = e.target.dataset.topicId;
                    const categoryId = e.target.dataset.categoryId;
                    editTopic(categoryId, topicId);
                });
            });
            document.querySelectorAll('.delete-topic-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const topicId = e.target.dataset.topicId;
                    const categoryId = e.target.dataset.categoryId;
                    deleteTopic(categoryId, topicId);
                });
            });
        }

        /**
         * Handles editing a topic.
         * @param {string} categoryId
         * @param {string} topicId
         */
        function editTopic(categoryId, topicId) {
            const category = appData.categories.find(cat => cat.id === categoryId);
            if (!category) return;
            const topic = category.topics.find(t => t.id === topicId);
            if (!topic) return;

            const newName = prompt(`Sửa tên chủ đề "${topic.name}":`, topic.name);
            if (newName !== null) { // User didn't click cancel
                const trimmedName = newName.trim();
                if (trimmedName === '') {
                    showMessage("Tên chủ đề không được để trống.", "error");
                    return;
                }
                if (trimmedName === topic.name) {
                    showMessage("Tên chủ đề không đổi.", "error");
                    return;
                }

                // Check for duplicate topic name within the same category
                if (category.topics.some(t => t.name.toLowerCase() === trimmedName.toLowerCase() && t.id !== topicId)) {
                    showMessage("Tên chủ đề đã tồn tại trong mục này!", "error");
                    return;
                }
                topic.name = trimmedName;
                saveAppData();
                renderCategoriesAndTopics();
                populateTopicSelects(selectCategoryForVocab.value, selectTopicForVocab, 'Chọn chủ đề con để quản lý từ vựng');
                populateTopicSelects(selectCategoryForQuiz.value, selectTopicForQuiz, 'Chọn chủ đề con để bắt đầu kiểm tra');
                populateTopicSelects(selectCategoryForPerformance.value, selectTopicForPerformance, 'Chọn chủ đề con để xem hiệu suất');
                populateMultiTopicCheckboxes(); // Update multi-select quiz options
                showMessage("Đã cập nhật tên chủ đề thành công!", "success");
            }
        }

        /**
         * Handles deleting a topic.
         * @param {string} categoryId
         * @param {string} topicId
         */
        function deleteTopic(categoryId, topicId) {
            if (!confirm("Bạn có chắc chắn muốn xóa chủ đề này? Tất cả từ vựng và lịch sử kiểm tra trong chủ đề này sẽ bị xóa.")) {
                return;
            }

            const category = appData.categories.find(cat => cat.id === categoryId);
            if (!category) return;

            category.topics = category.topics.filter(topic => topic.id !== topicId);
            saveAppData();
            renderCategoriesAndTopics();
            populateTopicSelects(selectCategoryForVocab.value, selectTopicForVocab, 'Chọn chủ đề con để quản lý từ vựng');
            populateTopicSelects(selectCategoryForQuiz.value, selectTopicForQuiz, 'Chọn chủ đề con để bắt đầu kiểm tra');
            populateTopicSelects(selectCategoryForPerformance.value, selectTopicForPerformance, 'Chọn chủ đề con để xem hiệu suất');
            populateMultiTopicCheckboxes(); // Update multi-select quiz options

            if (currentTopicId === topicId) { // If the deleted topic was currently selected
                currentTopicId = null;
                vocabContentDiv.classList.add('hidden');
                performanceContentDiv.classList.add('hidden');
            }
            showMessage("Đã xóa chủ đề thành công!", "success");
        }

        /**
         * Renders the vocabulary table for the currently selected topic.
         */
        function renderVocabularyTable() {
            currentTopicVocabTableBody.innerHTML = '';
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (!topic || topic.vocabulary.length === 0) {
                currentTopicVocabTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>';
                currentVocabCountSpan.textContent = 0;
                return;
            }

            topic.vocabulary.forEach(vocab => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${vocab.english}</td>
                    <td class="py-3 px-6 text-left">${vocab.vietnamese.join(', ')}</td>
                    <td class="py-3 px-6 text-left">${vocab.example || 'N/A'}</td>
                    <td class="py-3 px-6 text-center">
                        <button data-vocab-id="${vocab.id}" class="edit-vocab-btn bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded-md mr-2">Sửa</button>
                        <button data-vocab-id="${vocab.id}" class="delete-vocab-btn bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded-md">Xóa</button>
                    </td>
                `;
                currentTopicVocabTableBody.appendChild(row);
            });
            currentVocabCountSpan.textContent = topic.vocabulary.length;

            // Add event listeners for edit/delete vocab buttons
            document.querySelectorAll('.edit-vocab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const vocabId = e.target.dataset.vocabId;
                    editVocabulary(vocabId);
                });
            });
            document.querySelectorAll('.delete-vocab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const vocabId = e.target.dataset.vocabId;
                    deleteVocabulary(vocabId);
                });
            });
        }

        /**
         * Handles editing a vocabulary item.
         * @param {string} vocabId
         */
        function editVocabulary(vocabId) {
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
            if (!topic) return;

            const vocab = topic.vocabulary.find(v => v.id === vocabId);
            if (!vocab) return;

            const newEnglish = prompt("Sửa từ Tiếng Anh:", vocab.english);
            if (newEnglish === null) return;
            const newVietnamese = prompt("Sửa nghĩa Tiếng Việt (phân tách bằng dấu phẩy):", vocab.vietnamese.join(', '));
            if (newVietnamese === null) return;
            const newExample = prompt("Sửa ví dụ câu (tùy chọn):", vocab.example || '');
            if (newExample === null) return;

            const trimmedEnglish = newEnglish.trim();
            const trimmedVietnamese = newVietnamese.trim();

            if (trimmedEnglish === '' || trimmedVietnamese === '') {
                showMessage("Từ Tiếng Anh và Nghĩa Tiếng Việt không được để trống.", "error");
                return;
            }

            // Check for duplicate English word in the same topic
            if (topic.vocabulary.some(v => v.english.toLowerCase() === trimmedEnglish.toLowerCase() && v.id !== vocabId)) {
                showMessage("Từ Tiếng Anh này đã tồn tại trong chủ đề.", "error");
                return;
            }

            vocab.english = trimmedEnglish;
            vocab.vietnamese = trimmedVietnamese.split(',').map(s => s.trim()).filter(s => s !== '');
            vocab.example = newExample.trim();

            saveAppData();
            renderVocabularyTable();
            showMessage("Đã cập nhật từ vựng thành công!", "success");
        }

        /**
         * Handles deleting a vocabulary item.
         * @param {string} vocabId
         */
        function deleteVocabulary(vocabId) {
            if (!confirm("Bạn có chắc chắn muốn xóa từ vựng này không?")) {
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
            if (!topic) return;

            topic.vocabulary = topic.vocabulary.filter(vocab => vocab.id !== vocabId);
            saveAppData();
            renderVocabularyTable();
            renderCategoriesAndTopics(); // Update topic count in topic management section
            showMessage("Đã xóa từ vựng thành công!", "success");
        }

        /**
         * Populates multi-topic checkboxes for mixed quiz mode.
         */
        function populateMultiTopicCheckboxes() {
            multiTopicCheckboxesDiv.innerHTML = '';
            let hasTopics = false;
            appData.categories.forEach(category => {
                category.topics.forEach(topic => {
                    if (topic.vocabulary.length > 0) { // Only include topics with vocabulary
                        hasTopics = true;
                        const label = document.createElement('label');
                        label.className = 'multi-select-option';
                        label.innerHTML = `
                            <input type="checkbox" name="selectedTopicsForMixedQuiz" value="${topic.id}" data-category-id="${category.id}" class="form-checkbox text-purple-600 h-4 w-4">
                            ${topic.name} (${category.name})
                        `;
                        multiTopicCheckboxesDiv.appendChild(label);
                    }
                });
            });

            if (!hasTopics) {
                multiTopicCheckboxesDiv.innerHTML = '<p class="text-gray-500 col-span-full">Không có chủ đề nào có từ vựng để chọn.</p>';
            }
        }

        /**
         * Starts the quiz.
         */
        function startQuiz() {
            currentQuiz.quizActive = true;
            currentQuiz.score = 0;
            currentQuiz.correctCount = 0;
            currentQuiz.incorrectCount = 0;
            currentQuiz.currentQuestionIndex = 0;
            currentQuiz.questions = [];
            feedbackMessageDiv.classList.add('hidden');
            englishAnswerInput.value = '';
            englishAnswerInput.classList.remove('border-green-500', 'border-red-500');

            const quizDirection = document.querySelector('input[name="quizDirection"]:checked').value;
            currentQuiz.quizDirection = quizDirection;

            let allAvailableVocab = [];
            if (currentQuiz.quizType === 'single') {
                const selectedCategoryId = selectCategoryForQuiz.value;
                const selectedTopicId = selectTopicForQuiz.value;

                if (!selectedCategoryId || !selectedTopicId) {
                    showMessage("Vui lòng chọn một mục lớn và một chủ đề con để bắt đầu kiểm tra.", "error");
                    return;
                }

                const category = appData.categories.find(cat => cat.id === selectedCategoryId);
                const topic = category ? category.topics.find(t => t.id === selectedTopicId) : null;

                if (!topic || topic.vocabulary.length === 0) {
                    showMessage("Chủ đề này chưa có từ vựng để kiểm tra.", "error");
                    return;
                }
                allAvailableVocab = topic.vocabulary;
            } else { // mixed quiz
                const selectedTopicCheckboxes = document.querySelectorAll('input[name="selectedTopicsForMixedQuiz"]:checked');
                currentQuiz.selectedMixedTopicIds = Array.from(selectedTopicCheckboxes).map(cb => cb.value);

                if (currentQuiz.selectedMixedTopicIds.length === 0) {
                    showMessage("Vui lòng chọn ít nhất một chủ đề con để bắt đầu kiểm tra ngẫu nhiên.", "error");
                    return;
                }

                currentQuiz.selectedMixedTopicIds.forEach(topicId => {
                    appData.categories.forEach(cat => {
                        const topic = cat.topics.find(t => t.id === topicId);
                        if (topic && topic.vocabulary.length > 0) {
                            allAvailableVocab.push(...topic.vocabulary);
                        }
                    });
                });

                if (allAvailableVocab.length === 0) {
                    showMessage("Không có từ vựng trong các chủ đề đã chọn để kiểm tra.", "error");
                    return;
                }
            }

            const numberOfQuestions = parseInt(quizQuestionCountInput.value);
            if (isNaN(numberOfQuestions) || numberOfQuestions <= 0) {
                showMessage("Số lượng câu hỏi phải là một số nguyên dương.", "error");
                return;
            }

            if (numberOfQuestions > allAvailableVocab.length) {
                showMessage(`Bạn chỉ có ${allAvailableVocab.length} từ vựng. Vui lòng chọn số câu hỏi nhỏ hơn hoặc bằng.`, "error");
                return;
            }

            // Shuffle vocabulary and select questions
            const shuffledVocab = [...allAvailableVocab].sort(() => 0.5 - Math.random());
            currentQuiz.questions = shuffledVocab.slice(0, numberOfQuestions).map(vocab => {
                let questionText, correctAnswers, type;
                if (quizDirection === 'viet-to-eng') {
                    questionText = vocab.vietnamese.join(', ');
                    correctAnswers = vocab.english;
                    type = 'viet-to-eng';
                } else if (quizDirection === 'eng-to-viet') {
                    questionText = vocab.english;
                    correctAnswers = vocab.vietnamese;
                    type = 'eng-to-viet';
                } else { // random
                    if (Math.random() < 0.5) { // Viet-Eng
                        questionText = vocab.vietnamese.join(', ');
                        correctAnswers = vocab.english;
                        type = 'viet-to-eng';
                    } else { // Eng-Viet
                        questionText = vocab.english;
                        correctAnswers = vocab.vietnamese;
                        type = 'eng-to-viet';
                    }
                }
                return {
                    id: vocab.id, // Keep track of the original vocab ID
                    question: questionText,
                    correctAnswers: correctAnswers, // string for Eng, array for Viet
                    example: vocab.example,
                    userAnswer: '',
                    isCorrect: false,
                    direction: type
                };
            });

            if (currentQuiz.questions.length === 0) {
                showMessage("Không đủ từ vựng để tạo bài kiểm tra với cài đặt hiện tại.", "error");
                return;
            }

            currentQuiz.quizTimeLimit = parseInt(quizTimeLimitInput.value);
            if (isNaN(currentQuiz.quizTimeLimit) || currentQuiz.quizTimeLimit < 5) {
                showMessage("Thời gian giới hạn phải là một số nguyên dương lớn hơn hoặc bằng 5.", "error");
                return;
            }

            // Hide settings, show quiz area
            quizSettingsDiv.classList.add('hidden');
            quizResultsDiv.classList.add('hidden');
            quizArea.classList.remove('hidden');

            totalQuizQuestionsSpan.textContent = currentQuiz.questions.length;
            renderQuestion();
            startTimer();
        }

        /**
         * Renders the current quiz question.
         */
        function renderQuestion() {
            if (currentQuiz.currentQuestionIndex >= currentQuiz.questions.length) {
                endQuiz();
                return;
            }

            const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            currentQuestionNumberSpan.textContent = currentQuiz.currentQuestionIndex + 1;
            quizQuestionSpan.textContent = question.question;
            englishAnswerInput.value = '';
            englishAnswerInput.focus();
            feedbackMessageDiv.classList.add('hidden');
            englishAnswerInput.classList.remove('border-green-500', 'border-red-500');

            // Reset timer for new question
            clearInterval(currentQuiz.timerInterval);
            currentQuiz.timeRemaining = currentQuiz.quizTimeLimit;
            quizTimerSpan.textContent = currentQuiz.timeRemaining;
            startTimer();
        }

        /**
         * Starts the countdown timer for the current question.
         */
        function startTimer() {
            currentQuiz.timerInterval = setInterval(() => {
                currentQuiz.timeRemaining--;
                quizTimerSpan.textContent = currentQuiz.timeRemaining;
                if (currentQuiz.timeRemaining <= 0) {
                    clearInterval(currentQuiz.timerInterval);
                    processAnswer(false); // Mark as incorrect if time runs out
                }
            }, 1000);
        }

        /**
         * Processes the user's answer or marks question as skipped/incorrect.
         * @param {boolean} submitted - True if answer was submitted, false if skipped/timed out.
         */
        function processAnswer(submitted) {
            clearInterval(currentQuiz.timerInterval); // Stop timer

            const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            let isCorrect = false;
            let userAnswer = englishAnswerInput.value.trim();

            if (!submitted) { // Skipped or Timed out
                userAnswer = "Bỏ qua / Hết giờ";
                isCorrect = false;
            } else {
                if (currentQuestion.direction === 'viet-to-eng') {
                    // For Viet-Eng, correctAnswers is a string (English word)
                    isCorrect = userAnswer.toLowerCase() === currentQuestion.correctAnswers.toLowerCase();
                } else { // eng-to-viet or random (if it became eng-to-viet)
                    // For Eng-Viet, correctAnswers is an array of Vietnamese meanings
                    const correctVietnameseMeanings = currentQuestion.correctAnswers.map(m => m.toLowerCase());
                    const userVietnameseMeanings = userAnswer.split(',').map(s => s.trim().toLowerCase()).filter(s => s !== '');

                    // Check if all user's answers are among the correct ones, and at least one correct answer is provided
                    isCorrect = userVietnameseMeanings.length > 0 &&
                                userVietnameseMeanings.every(ans => correctVietnameseMeanings.includes(ans)) &&
                                correctVietnameseMeanings.some(ans => userVietnameseMeanings.includes(ans));
                }
            }

            currentQuestion.userAnswer = userAnswer;
            currentQuestion.isCorrect = isCorrect;

            // Update individual vocabulary performance
            const category = appData.categories.find(cat => cat.topics.some(t => t.vocabulary.some(v => v.id === currentQuestion.id)));
            if (category) {
                const topic = category.topics.find(t => t.vocabulary.some(v => v.id === currentQuestion.id));
                if (topic) {
                    const vocab = topic.vocabulary.find(v => v.id === currentQuestion.id);
                    if (vocab) {
                        if (isCorrect) {
                            vocab.correctAttempts++;
                        } else {
                            vocab.incorrectAttempts++;
                        }
                    }
                }
            }

            if (isCorrect) {
                currentQuiz.correctCount++;
                quizCorrectCountSpan.textContent = currentQuiz.correctCount;
                feedbackMessageDiv.textContent = "Chính xác!";
                feedbackMessageDiv.className = 'text-center mt-4 text-lg font-semibold text-green-600';
                englishAnswerInput.classList.add('border-green-500');
            } else {
                currentQuiz.incorrectCount++;
                quizIncorrectCountSpan.textContent = currentQuiz.incorrectCount;
                let correctAnswerDisplay;
                if (currentQuestion.direction === 'viet-to-eng') {
                    correctAnswerDisplay = currentQuestion.correctAnswers;
                } else {
                    correctAnswerDisplay = currentQuestion.correctAnswers.join(', ');
                }
                feedbackMessageDiv.textContent = `Sai rồi. Đáp án đúng: ${correctAnswerDisplay}`;
                feedbackMessageDiv.className = 'text-center mt-4 text-lg font-semibold text-red-600';
                englishAnswerInput.classList.add('border-red-500');
            }
            feedbackMessageDiv.classList.remove('hidden');

            // Wait a moment before moving to next question
            setTimeout(() => {
                currentQuiz.currentQuestionIndex++;
                renderQuestion(); // This will also handle ending the quiz
            }, 1500); // Show feedback for 1.5 seconds
        }

        /**
         * Ends the quiz and displays results.
         */
        function endQuiz() {
            currentQuiz.quizActive = false;
            clearInterval(currentQuiz.timerInterval); // Ensure timer is stopped

            quizArea.classList.add('hidden');
            quizResultsDiv.classList.remove('hidden');

            correctCountSpan.textContent = currentQuiz.correctCount;
            totalCountSpan.textContent = currentQuiz.questions.length;

            detailedResultsDiv.innerHTML = '';
            currentQuiz.questions.forEach((q, index) => {
                let statusClass = q.isCorrect ? 'text-green-700' : 'text-red-700';
                let userAnswerText = q.userAnswer || 'Không trả lời';
                let correctAnswerText;

                if (q.direction === 'viet-to-eng') {
                    correctAnswerText = q.correctAnswers; // English word
                } else {
                    correctAnswerText = q.correctAnswers.join(', '); // Vietnamese meanings
                }

                const resultItem = document.createElement('div');
                resultItem.className = `p-3 rounded-md shadow-sm border ${q.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                resultItem.innerHTML = `
                    <p class="font-semibold text-lg ${statusClass}">${index + 1}. ${q.question}</p>
                    <p class="text-gray-600">Đáp án của bạn: <span class="font-medium">${userAnswerText}</span></p>
                    <p class="text-gray-600">Đáp án đúng: <span class="font-medium">${correctAnswerText}</span></p>
                    ${q.example ? `<p class="text-gray-500 text-sm italic">Ví dụ: ${q.example}</p>` : ''}
                `;
                detailedResultsDiv.appendChild(resultItem);
            });

            // Save quiz results to the topic's history
            let quizTopicName = "";
            let quizCategoryName = "";
            if (currentQuiz.quizType === 'single') {
                const category = appData.categories.find(cat => cat.id === selectCategoryForQuiz.value);
                const topic = category ? category.topics.find(t => t.id === selectTopicForQuiz.value) : null;
                if (topic) {
                    topic.results.push({
                        date: new Date().toLocaleString(),
                        score: currentQuiz.correctCount,
                        totalQuestions: currentQuiz.questions.length,
                        type: "single",
                        direction: currentQuiz.quizDirection,
                        details: currentQuiz.questions.map(q => ({
                            id: q.id,
                            question: q.question,
                            userAnswer: q.userAnswer,
                            isCorrect: q.isCorrect,
                            correctAnswers: q.correctAnswers,
                            example: q.example,
                            direction: q.direction
                        }))
                    });
                    quizTopicName = topic.name;
                    quizCategoryName = category.name;
                }
            } else { // mixed quiz
                const resultRecord = {
                    date: new Date().toLocaleString(),
                    score: currentQuiz.correctCount,
                    totalQuestions: currentQuiz.questions.length,
                    type: "mixed",
                    direction: currentQuiz.quizDirection,
                    topicIds: currentQuiz.selectedMixedTopicIds,
                    details: currentQuiz.questions.map(q => ({
                        id: q.id,
                        question: q.question,
                        userAnswer: q.userAnswer,
                        isCorrect: q.isCorrect,
                        correctAnswers: q.correctAnswers,
                        example: q.example,
                        direction: q.direction
                    }))
                };
                // For mixed quizzes, save the result to each involved topic for tracking individual vocab performance
                currentQuiz.selectedMixedTopicIds.forEach(topicId => {
                    appData.categories.forEach(cat => {
                        const topic = cat.topics.find(t => t.id === topicId);
                        if (topic) {
                            topic.results.push(resultRecord); // Push the same result record to all involved topics
                        }
                    });
                });
                quizTopicName = "Nhiều chủ đề";
                quizCategoryName = "Tổng hợp";
            }
            saveAppData();
            showMessage(`Bài kiểm tra ${quizTopicName} (${quizCategoryName}) đã kết thúc!`, "success");
        }

        /**
         * Renders the performance table (quiz history) for the selected topic.
         */
        function renderPerformanceTable() {
            performanceTableBody.innerHTML = '';
            individualVocabPerformanceBody.innerHTML = ''; // Clear individual vocab performance too

            const category = appData.categories.find(cat => cat.id === selectCategoryForPerformance.value);
            const topic = category ? category.topics.find(t => t.id === selectTopicForPerformance.value) : null;

            if (!topic) {
                performanceTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Vui lòng chọn một chủ đề con để xem lịch sử kiểm tra.</td></tr>';
                individualVocabPerformanceBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Vui lòng chọn một chủ đề con để xem hiệu suất từ vựng cá nhân.</td></tr>';
                return;
            }

            // Render Quiz History
            if (topic.results.length === 0) {
                performanceTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Chưa có lịch sử bài kiểm tra cho chủ đề này.</td></tr>';
            } else {
                // Filter out duplicate mixed quiz entries if they were saved multiple times per topic
                const uniqueResults = [];
                const addedMixedQuizDates = new Set(); // To store combined date+type for mixed quizzes

                topic.results.forEach(result => {
                    if (result.type === 'mixed') {
                        // For mixed quizzes, treat date+type+topicIds as unique identifier
                        const uniqueId = result.date + result.type + result.topicIds.sort().join(',');
                        if (!addedMixedQuizDates.has(uniqueId)) {
                            uniqueResults.push(result);
                            addedMixedQuizDates.add(uniqueId);
                        }
                    } else { // Single quiz, always add
                        uniqueResults.push(result);
                    }
                });

                uniqueResults.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

                uniqueResults.forEach((result, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${result.date}</td>
                        <td class="py-3 px-6 text-left">${result.score}</td>
                        <td class="py-3 px-6 text-left">${result.totalQuestions}</td>
                        <td class="py-3 px-6 text-left">${result.type === 'single' ? 'Theo chủ đề' : 'Ngẫu nhiên'} (${result.direction === 'viet-to-eng' ? 'Việt-Anh' : result.direction === 'eng-to-viet' ? 'Anh-Việt' : 'Ngẫu nhiên'})</td>
                        <td class="py-3 px-6 text-center">
                            <button data-quiz-index="${index}" class="view-quiz-details-btn bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1 rounded-md">Xem chi tiết</button>
                        </td>
                    `;
                    performanceTableBody.appendChild(row);
                });

                document.querySelectorAll('.view-quiz-details-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const quizIndex = parseInt(e.target.dataset.quizIndex);
                        showQuizDetailsModal(uniqueResults[quizIndex]);
                    });
                });
            }

            // Render Individual Vocabulary Performance
            if (topic.vocabulary.length === 0) {
                individualVocabPerformanceBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>';
            } else {
                let hasPerformanceData = false;
                topic.vocabulary.sort((a, b) => b.correctAttempts + b.incorrectAttempts - (a.correctAttempts + a.incorrectAttempts)) // Sort by total attempts
                                .forEach(vocab => {
                    if (vocab.correctAttempts > 0 || vocab.incorrectAttempts > 0) {
                        hasPerformanceData = true;
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        row.innerHTML = `
                            <td class="py-3 px-6 text-left">${vocab.english}</td>
                            <td class="py-3 px-6 text-left">${vocab.vietnamese.join(', ')}</td>
                            <td class="py-3 px-6 text-center text-green-600 font-bold">${vocab.correctAttempts}</td>
                            <td class="py-3 px-6 text-center text-red-600 font-bold">${vocab.incorrectAttempts}</td>
                        `;
                        individualVocabPerformanceBody.appendChild(row);
                    }
                });
                if (!hasPerformanceData) {
                    individualVocabPerformanceBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chưa có dữ liệu hiệu suất từ vựng cá nhân cho chủ đề này.</td></tr>';
                }
            }
        }

        /**
         * Shows the quiz details modal.
         * @param {object} quizResult - The quiz result object to display.
         */
        function showQuizDetailsModal(quizResult) {
            modalQuizDate.textContent = quizResult.date;
            modalQuizScore.textContent = quizResult.score;
            modalQuizTotal.textContent = quizResult.totalQuestions;
            modalQuizType.textContent = `${quizResult.type === 'single' ? 'Theo chủ đề' : 'Ngẫu nhiên'} (${quizResult.direction === 'viet-to-eng' ? 'Việt-Anh' : quizResult.direction === 'eng-to-viet' ? 'Anh-Việt' : 'Ngẫu nhiên'})`;

            modalDetailedResults.innerHTML = '';
            quizResult.details.forEach((detail, index) => {
                const statusClass = detail.isCorrect ? 'text-green-700' : 'text-red-700';
                const userAnswerText = detail.userAnswer || 'Không trả lời';
                let correctAnswerText;

                if (detail.direction === 'viet-to-eng') {
                    correctAnswerText = detail.correctAnswers; // English word
                } else {
                    correctAnswerText = detail.correctAnswers.join(', '); // Vietnamese meanings
                }

                const detailItem = document.createElement('div');
                detailItem.className = `p-3 rounded-md shadow-sm border ${detail.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                detailItem.innerHTML = `
                    <p class="font-semibold text-lg ${statusClass}">${index + 1}. ${detail.question}</p>
                    <p class="text-gray-600">Đáp án của bạn: <span class="font-medium">${userAnswerText}</span></p>
                    <p class="text-gray-600">Đáp án đúng: <span class="font-medium">${correctAnswerText}</span></p>
                    ${detail.example ? `<p class="text-gray-500 text-sm italic">Ví dụ: ${detail.example}</p>` : ''}
                `;
                modalDetailedResults.appendChild(detailItem);
            });

            quizDetailsModal.classList.add('show');
        }

        /**
         * Closes the quiz details modal.
         */
        function closeQuizDetailsModal() {
            quizDetailsModal.classList.remove('show');
        }


        // --- Event Listeners ---

        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.target.getAttribute('href');

                // Remove active class from all links and sections
                navLinks.forEach(nav => nav.classList.remove('active-nav-link'));
                sections.forEach(sec => sec.classList.remove('active'));

                // Add active class to clicked link and target section
                e.target.classList.add('active-nav-link');
                document.querySelector(targetId).classList.add('active');

                // Re-render relevant sections on navigation to ensure fresh data
                if (targetId === '#topics-section') {
                    renderCategoriesAndTopics();
                    populateCategorySelects(); // Re-populate to ensure parent select is accurate
                } else if (targetId === '#vocabulary-management-section') {
                    populateCategorySelects();
                    // Need to trigger topic select population for vocab section if a category is pre-selected
                    if (selectCategoryForVocab.value) {
                         populateTopicSelects(selectCategoryForVocab.value, selectTopicForVocab, 'Chọn chủ đề con để quản lý từ vựng');
                         // If there's already a currentTopicId and it's valid, show content
                         const category = appData.categories.find(cat => cat.id === selectCategoryForVocab.value);
                         const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
                         if (topic) {
                            selectTopicForVocab.value = currentTopicId;
                            vocabContentDiv.classList.remove('hidden');
                            renderVocabularyTable();
                         }
                    }
                } else if (targetId === '#quiz-section') {
                    populateCategorySelects();
                    if (selectCategoryForQuiz.value) {
                        populateTopicSelects(selectCategoryForQuiz.value, selectTopicForQuiz, 'Chọn chủ đề con để bắt đầu kiểm tra');
                    }
                    populateMultiTopicCheckboxes();
                    quizArea.classList.add('hidden'); // Ensure quiz area is hidden when navigating to quiz setup
                    quizResultsDiv.classList.add('hidden'); // Ensure results are hidden too
                    quizSettingsDiv.classList.remove('hidden'); // Show settings
                } else if (targetId === '#performance-section') {
                    populateCategorySelects();
                    if (selectCategoryForPerformance.value) {
                         populateTopicSelects(selectCategoryForPerformance.value, selectTopicForPerformance, 'Chọn chủ đề con để xem hiệu suất');
                         // If there's already a currentTopicId and it's valid, show content
                         const category = appData.categories.find(cat => cat.id === selectCategoryForPerformance.value);
                         const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
                         if (topic) {
                            selectTopicForPerformance.value = currentTopicId;
                            performanceContentDiv.classList.remove('hidden');
                            renderPerformanceTable();
                         }
                    }
                }
            });
        });

        // Topic Management
        addTopicForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const parentCatId = parentCategorySelect.value;
            const newTopicName = newTopicNameInput.value.trim();

            if (!parentCatId) {
                showMessage("Vui lòng chọn một mục lớn.", "error");
                return;
            }
            if (newTopicName === '') {
                showMessage("Tên chủ đề con không được để trống.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === parentCatId);
            if (category) {
                // Check for duplicate topic name within the same category
                if (category.topics.some(topic => topic.name.toLowerCase() === newTopicName.toLowerCase())) {
                    showMessage("Chủ đề này đã tồn tại trong mục đã chọn.", "error");
                    return;
                }
                category.topics.push({
                    id: generateUniqueId(),
                    name: newTopicName,
                    vocabulary: [],
                    results: []
                });
                saveAppData();
                newTopicNameInput.value = '';
                renderCategoriesAndTopics();
                populateCategorySelects(); // Re-populate all category/topic selects to reflect changes
                showMessage("Đã thêm chủ đề mới thành công!", "success");
            } else {
                showMessage("Mục lớn không hợp lệ.", "error");
            }
        });

        // Vocabulary Management
        selectCategoryForVocab.addEventListener('change', (e) => {
            currentCategoryId = e.target.value;
            populateTopicSelects(currentCategoryId, selectTopicForVocab, 'Chọn chủ đề con để quản lý từ vựng');
        });

        selectTopicForVocab.addEventListener('change', (e) => {
            currentTopicId = e.target.value;
            if (currentTopicId) {
                vocabContentDiv.classList.remove('hidden');
                renderVocabularyTable();
            } else {
                vocabContentDiv.classList.add('hidden');
            }
        });

        addSingleVocabForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const english = englishWordInput.value.trim();
            const vietnamese = vietnameseMeaningInput.value.trim().split(',').map(s => s.trim()).filter(s => s !== '');
            const example = exampleSentenceInput.value.trim();

            if (!currentTopicId) {
                showMessage("Vui lòng chọn một chủ đề để thêm từ vựng.", "error");
                return;
            }
            if (english === '' || vietnamese.length === 0) {
                showMessage("Từ Tiếng Anh và Nghĩa Tiếng Việt là bắt buộc.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic) {
                // Check for duplicate English word in the same topic
                if (topic.vocabulary.some(vocab => vocab.english.toLowerCase() === english.toLowerCase())) {
                    showMessage("Từ Tiếng Anh này đã tồn tại trong chủ đề.", "error");
                    return;
                }

                topic.vocabulary.push({
                    id: generateUniqueId(),
                    english: english,
                    vietnamese: vietnamese,
                    example: example,
                    correctAttempts: 0,
                    incorrectAttempts: 0
                });
                saveAppData();
                englishWordInput.value = '';
                vietnameseMeaningInput.value = '';
                exampleSentenceInput.value = '';
                renderVocabularyTable();
                renderCategoriesAndTopics(); // Update topic count in topic management section
                showMessage("Đã thêm từ vựng thành công!", "success");
            } else {
                showMessage("Chủ đề không hợp lệ.", "error");
            }
        });

        bulkImportVocabForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const bulkInput = bulkVocabInput.value.trim();

            if (!currentTopicId) {
                showMessage("Vui lòng chọn một chủ đề để nhập từ vựng hàng loạt.", "error");
                return;
            }
            if (bulkInput === '') {
                showMessage("Vui lòng nhập từ vựng để nhập hàng loạt.", "error");
                return;
            }

            const lines = bulkInput.split('\n').filter(line => line.trim() !== '');
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (!topic) {
                showMessage("Chủ đề không hợp lệ.", "error");
                return;
            }

            let importCount = 0;
            let errorMessages = [];

            lines.forEach((line, index) => {
                const parts = line.split(' - ').map(s => s.trim());
                if (parts.length < 2) {
                    errorMessages.push(`Dòng ${index + 1}: Định dạng không hợp lệ. Cần ít nhất "Từ Tiếng Anh - Nghĩa Tiếng Việt".`);
                    return;
                }

                const english = parts[0];
                const vietnamese = parts[1].split(',').map(s => s.trim()).filter(s => s !== '');
                const example = parts[2] || '';

                if (english === '' || vietnamese.length === 0) {
                    errorMessages.push(`Dòng ${index + 1}: Từ Tiếng Anh hoặc Nghĩa Tiếng Việt không được để trống.`);
                    return;
                }

                // Check for duplicate English word in the same topic (case-insensitive)
                if (topic.vocabulary.some(vocab => vocab.english.toLowerCase() === english.toLowerCase())) {
                    errorMessages.push(`Dòng ${index + 1}: Từ Tiếng Anh "${english}" đã tồn tại trong chủ đề. Bỏ qua.`);
                    return;
                }

                topic.vocabulary.push({
                    id: generateUniqueId(),
                    english: english,
                    vietnamese: vietnamese,
                    example: example,
                    correctAttempts: 0,
                    incorrectAttempts: 0
                });
                importCount++;
            });

            if (importCount > 0) {
                saveAppData();
                bulkVocabInput.value = '';
                renderVocabularyTable();
                renderCategoriesAndTopics(); // Update topic count
                showMessage(`Đã nhập thành công ${importCount} từ vựng!`, "success");
            }

            if (errorMessages.length > 0) {
                const errorMessage = `Có lỗi khi nhập hàng loạt:\n${errorMessages.join('\n')}`;
                alert(errorMessage); // Use alert for multi-line error
                showMessage("Có lỗi khi nhập hàng loạt. Vui lòng xem thông báo chi tiết.", "error", 5000);
            }
        });

        // Quiz Section
        quizModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentQuiz.quizType = e.target.value;
                if (currentQuiz.quizType === 'single') {
                    singleTopicQuizOptionsDiv.classList.remove('hidden');
                    mixedTopicQuizOptionsDiv.classList.add('hidden');
                } else {
                    singleTopicQuizOptionsDiv.classList.add('hidden');
                    mixedTopicQuizOptionsDiv.classList.remove('hidden');
                    populateMultiTopicCheckboxes();
                }
            });
        });

        selectCategoryForQuiz.addEventListener('change', (e) => {
            const categoryId = e.target.value;
            populateTopicSelects(categoryId, selectTopicForQuiz, 'Chọn chủ đề con để bắt đầu kiểm tra');
        });

        startQuizBtn.addEventListener('click', startQuiz);
        submitAnswerBtn.addEventListener('click', () => processAnswer(true));
        skipQuestionBtn.addEventListener('click', () => processAnswer(false));
        retakeQuizBtn.addEventListener('click', () => {
            quizResultsDiv.classList.add('hidden');
            quizSettingsDiv.classList.remove('hidden');
            // Reset relevant selects if needed or just keep current selection
        });

        englishAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission
                submitAnswerBtn.click();
            }
        });

        // Cheat Detection
        document.addEventListener('visibilitychange', () => {
            if (currentQuiz.quizActive && document.hidden) {
                clearInterval(currentQuiz.timerInterval);
                currentQuiz.quizActive = false;
                quizArea.classList.add('hidden');
                cheatDetectionMessage.classList.remove('hidden');
            }
        });

        closeCheatMessageBtn.addEventListener('click', () => {
            cheatDetectionMessage.classList.add('hidden');
            // Optionally, return to quiz setup or home
            sections.forEach(sec => sec.classList.remove('active'));
            document.getElementById('quiz-section').classList.add('active');
            navLinks.forEach(nav => nav.classList.remove('active-nav-link'));
            document.querySelector('a[href="#quiz-section"]').classList.add('active-nav-link');
        });

        // Performance Section
        selectCategoryForPerformance.addEventListener('change', (e) => {
            const categoryId = e.target.value;
            populateTopicSelects(categoryId, selectTopicForPerformance, 'Chọn chủ đề con để xem hiệu suất');
        });

        selectTopicForPerformance.addEventListener('change', (e) => {
            currentTopicId = e.target.value;
            if (currentTopicId) {
                performanceContentDiv.classList.remove('hidden');
                renderPerformanceTable();
            } else {
                performanceContentDiv.classList.add('hidden');
            }
        });

        closeQuizDetailsModalBtn.addEventListener('click', closeQuizDetailsModal);
        quizDetailsModal.addEventListener('click', (e) => {
            if (e.target === quizDetailsModal) { // Close when clicking outside content
                closeQuizDetailsModal();
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppData();
            populateCategorySelects();
            renderCategoriesAndTopics(); // Render topics list initially for the first section

            // Initialize select options based on current state after loading
            // For vocabulary section, ensure the topic select is populated if a category is pre-selected
            if (selectCategoryForVocab.value) {
                populateTopicSelects(selectCategoryForVococab.value, selectTopicForVocab, 'Chọn chủ đề con để quản lý từ vựng');
            }
            // For quiz section, ensure the topic select is populated if a category is pre-selected
            if (selectCategoryForQuiz.value) {
                populateTopicSelects(selectCategoryForQuiz.value, selectTopicForQuiz, 'Chọn chủ đề con để bắt đầu kiểm tra');
            }
            populateMultiTopicCheckboxes(); // Initialize multi-select checkboxes

            // For performance section, ensure the topic select is populated if a category is pre-selected
            if (selectCategoryForPerformance.value) {
                populateTopicSelects(selectCategoryForPerformance.value, selectTopicForPerformance, 'Chọn chủ đề con để xem hiệu suất');
            }
        });
    </script>
</body>
</html>
