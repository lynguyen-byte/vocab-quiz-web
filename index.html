<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Dò Từ Vựng Của Bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            /* Changed background to light purple */
            @apply bg-purple-50 text-gray-800;
        }
        /* Hide sections by default, show only active one */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }
        /* Active navigation link style */
        .active-nav-link {
            @apply bg-gray-700;
        }
        /* Style for multi-select checkboxes */
        .multi-select-option {
            @apply block p-2 rounded-md hover:bg-purple-100 cursor-pointer;
        }
        .multi-select-option input[type="checkbox"] {
            @apply mr-2;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: relative; /* For close button */
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #4b5563; /* Tailwind gray-600 */
        }
        .modal-close-btn:hover {
            color: #1f2937; /* Tailwind gray-800 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 shadow-lg">
        <div class="container mx-auto text-center">
            <h1 class="text-4xl font-bold mb-2">Trang Web Dò Từ Vựng Của Bạn</h1>
            <p class="text-xl opacity-90">Học, quản lý và kiểm tra từ vựng theo chủ đề!</p>
        </div>
    </header>
    <nav class="bg-gray-800 text-white shadow-md">
        <ul class="container mx-auto flex justify-center py-3">
            <li><a href="#topics-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md active-nav-link">Chủ Đề</a></li>
            <li><a href="#vocabulary-management-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Quản Lý Từ Vựng</a></li>
            <li><a href="#quiz-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Kiểm Tra</a></li>
            <li><a href="#performance-section" class="nav-link px-6 py-3 block hover:bg-gray-700 transition-colors duration-200 rounded-md">Hiệu Suất Học Tập</a></li>
        </ul>
    </nav>
    <main class="container mx-auto mt-8 p-6 bg-white rounded-lg shadow-xl flex-grow">
        <div id="generalMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <section id="topics-section" class="section active">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Chủ Đề</h2>
            <div class="bg-purple-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Thêm Chủ Đề Con Mới</h3>
                <form id="addTopicForm" class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="parentCategorySelect" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                        <select id="parentCategorySelect"
                                class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </select>
                    </div>
                    <div class="flex-grow w-full">
                        <label for="newTopicName" class="block text-gray-700 text-sm font-bold mb-2">Tên Chủ Đề Con:</label>
                        <input type="text" id="newTopicName" placeholder="Ví dụ: Level 1, Idioms"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <button type="submit"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Thêm Chủ Đề
                    </button>
                </form>
            </div>
            <h3 class="text-2xl font-medium text-purple-600 mb-4">Các Chủ Đề Hiện Có</h3>
            <div id="categoriesList" class="space-y-8">
                <p class="text-gray-500 text-center col-span-full">Chưa có chủ đề nào. Hãy thêm chủ đề mới!</p>
            </div>
        </section>

        <section id="vocabulary-management-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Quản Lý Từ Vựng</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </select>
                </div>
                <div>
                    <label for="selectTopicForVocab" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con:</label>
                    <select id="selectTopicForVocab"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>
                    </select>
                </div>
            </div>
            <div id="vocabContent" class="hidden">
                <div class="bg-green-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-green-700 mb-4">Thêm Từ Vựng Riêng Lẻ</h3>
                    <form id="addSingleVocabForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="englishWord" class="block text-gray-700 text-sm font-bold mb-2">Từ Tiếng Anh:</label>
                            <input type="text" id="englishWord" placeholder="Ví dụ: beautiful"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label for="vietnameseMeaning" class="block text-gray-700 text-sm font-bold mb-2">Nghĩa Tiếng Việt:</label>
                            <input type="text" id="vietnameseMeaning" placeholder="Ví dụ: đẹp, xinh đẹp"
                                   class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="exampleSentence" class="block text-gray-700 text-sm font-bold mb-2">Ví Dụ Câu (tùy chọn):</label>
                            <textarea id="exampleSentence" rows="2" placeholder="Ví dụ: She has a beautiful smile."
                                      class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>
                        <div class="md:col-span-2 text-right">
                            <button type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Thêm Từ
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-8">
                    <h3 class="text-2xl font-medium text-yellow-700 mb-4">Nhập Từ Vựng Hàng Loạt</h3>
                    <p class="text-gray-600 mb-4">Nhập mỗi từ trên một dòng theo định dạng: <code class="bg-gray-200 p-1 rounded">English Word - Vietnamese Meaning - Example Sentence (optional)</code></p>
                    <form id="bulkImportVocabForm">
                        <textarea id="bulkVocabInput" rows="8" placeholder="Ví dụ:
apple - quả táo - I like to eat an apple.
book - cuốn sách - Read a good book.
run - chạy - He can run fast."
                                  class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent mb-4"></textarea>
                        <div class="text-right">
                            <button type="submit"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                Nhập Hàng Loạt
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-2xl font-medium text-purple-600 mb-4">Từ Vựng Trong Chủ Đề Này (<span id="currentVocabCount">0</span> từ)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Nghĩa Tiếng Việt</th>
                                <th class="py-3 px-6 text-left">Ví Dụ</th>
                                <th class="py-3 px-6 text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="currentTopicVocabTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="quiz-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Kiểm Tra Từ Vựng</h2>
            <div class="mb-6 bg-purple-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-medium text-purple-700 mb-4">Chọn Loại Bài Kiểm Tra</h3>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="single" checked class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra theo Chủ đề</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="quizMode" value="mixed" class="form-radio text-purple-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Kiểm tra ngẫu nhiên từ nhiều Chủ đề</span>
                    </label>
                </div>

                <div id="singleTopicQuizOptions">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="selectCategoryForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                            <select id="selectCategoryForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </select>
                        </div>
                        <div>
                            <label for="selectTopicForQuiz" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Kiểm Tra:</label>
                            <select id="selectTopicForQuiz"
                                    class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="mixedTopicQuizOptions" class="hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chọn các Chủ Đề Con để ôn tập:</label>
                    <div id="multiTopicCheckboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 bg-white p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                        <p class="text-gray-500 col-span-full">Chưa có chủ đề nào để chọn.</p>
                    </div>
                </div>

                <div id="quizSettings" class="mt-6">
                    <h3 class="text-2xl font-medium text-purple-700 mb-4">Cài Đặt Bài Kiểm Tra</h3>
                    <div class="mb-4">
                        <label for="quizQuestionCount" class="block text-gray-700 text-sm font-bold mb-2">Số lượng câu hỏi:</label>
                        <input type="number" id="quizQuestionCount" value="5" min="1"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label for="quizTimeLimit" class="block text-gray-700 text-sm font-bold mb-2">Thời gian giới hạn mỗi từ (giây):</label>
                        <input type="number" id="quizTimeLimit" value="30" min="5"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <button id="startQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Bắt Đầu Kiểm Tra
                    </button>
                    <button id="generateQuizLinkBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md mt-4">
                        Tạo Link Chia Sẻ
                    </button>
                </div>
            </div>

            <div id="quizArea" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xl font-semibold text-gray-700">Câu hỏi <span id="currentQuestionNumber">1</span>/<span id="totalQuizQuestions">5</span></span>
                    <span class="text-2xl font-bold text-red-600" id="quizTimer">30</span>
                </div>
                <div class="text-center mb-8">
                    <p class="text-3xl font-bold text-purple-800 mb-4">
                        <span id="vietnameseQuestion"></span>
                    </p>
                    <input type="text" id="englishAnswerInput" placeholder="Nhập từ tiếng Anh..."
                           class="shadow appearance-none border rounded-lg w-full max-w-md py-4 px-6 text-gray-700 text-2xl leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center">
                </div>
                <div id="feedbackMessage" class="hidden text-center mt-4 text-lg font-semibold"></div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="submitAnswerBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Nộp Đáp Án
                    </button>
                    <button id="skipQuestionBtn"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Bỏ Qua
                    </button>
                </div>
            </div>

            <div id="quizResults" class="hidden bg-white p-8 rounded-lg shadow-lg mt-8">
                <h3 class="text-3xl font-bold text-purple-700 mb-6 text-center">Kết Quả Bài Kiểm Tra</h3>
                <p class="text-xl text-center mb-4">Bạn đã trả lời đúng <span id="correctCount" class="font-bold text-green-600">0</span> trên <span id="totalCount" class="font-bold text-purple-600">0</span> câu.</p>
                <div id="detailedResults" class="space-y-4">
                    </div>
                <div class="text-center mt-8">
                    <button id="retakeQuizBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 shadow-md">
                        Làm Lại Bài Kiểm Tra
                    </button>
                </div>
            </div>

            <div id="cheatDetectionMessage" class="hidden fixed inset-0 bg-red-800 bg-opacity-90 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-md">
                    <h3 class="text-3xl font-bold text-red-700 mb-4">Phát Hiện Gian Lận!</h3>
                    <p class="text-lg text-gray-700 mb-6">Bạn đã chuyển khỏi tab hoặc cửa sổ, hoặc thay đổi kích thước màn hình trong khi làm bài kiểm tra. Bài kiểm tra này sẽ bị hủy.</p>
                    <button id="closeCheatMessageBtn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Đóng
                    </button>
                </div>
            </div>
        </section>

        <section id="performance-section" class="section">
            <h2 class="text-3xl font-semibold text-purple-700 mb-6 border-b-2 pb-2 border-purple-300">Hiệu Suất Học Tập</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="selectCategoryForPerformance" class="block text-gray-700 text-sm font-bold mb-2">Chọn Mục Lớn:</label>
                    <select id="selectCategoryForPerformance"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </select>
                </div>
                <div>
                    <label for="selectTopicForPerformance" class="block text-gray-700 text-sm font-bold mb-2">Chọn Chủ Đề Con Để Xem Hiệu Suất:</label>
                    <select id="selectTopicForPerformance"
                            class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Chọn chủ đề con để xem hiệu suất --</option>
                    </select>
                </div>
            </div>
            <div id="performanceContent" class="hidden">
                <h3 class="text-2xl font-medium text-purple-600 mb-4">Lịch Sử Bài Kiểm Tra</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Ngày</th>
                                <th class="py-3 px-6 text-left">Điểm</th>
                                <th class="py-3 px-6 text-left">Tổng số câu</th>
                                <th class="py-3 px-6 text-left">Loại bài</th>
                                <th class="py-3 px-6 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="performanceTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="5" class="py-4 text-center text-gray-500">Chưa có lịch sử bài kiểm tra cho chủ đề này.</td></tr>
                        </tbody>
                    </table>
                </div>
                <h3 class="text-2xl font-medium text-purple-600 mb-4 mt-8">Hiệu Suất Từ Vựng</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Từ Tiếng Anh</th>
                                <th class="py-3 px-6 text-left">Số lần đúng</th>
                                <th class="py-3 px-6 text-left">Số lần sai</th>
                                <th class="py-3 px-6 text-left">Tỷ lệ đúng</th>
                            </tr>
                        </thead>
                        <tbody id="vocabPerformanceTableBody" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="4" class="py-4 text-center text-gray-500">Chưa có dữ liệu hiệu suất từ vựng cho chủ đề này.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="shareLinkModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeShareLinkModalBtn">&times;</button>
            <h3 class="text-2xl font-bold text-purple-700 mb-4">Link Bài Kiểm Tra Của Bạn</h3>
            <p class="text-gray-700 mb-4">Sao chép link này và gửi cho bạn bè của bạn:</p>
            <div class="relative mb-4">
                <input type="text" id="generatedShareLink" readonly
                       class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 pr-12 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <button id="copyShareLinkBtn"
                        class="absolute right-0 top-0 h-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-r-lg transition-colors duration-200">
                    Sao chép
                </button>
            </div>
            <p id="copyConfirmation" class="text-sm text-green-600 hidden">Đã sao chép!</p>
        </div>
    </div>


    <script>
        // Global variables for managing application data and state
        const APP_DATA_KEY = 'myVocabularyApp'; // Key for storing data in localStorage
        let appData = {
            categories: [] // Array containing main categories (Ken, Nhím), each category has an ID, name, and an array of sub-topics
        };
        let currentCategoryId = null; // ID of the currently selected main category
        let currentTopicId = null; // ID of the currently selected sub-topic

        let currentQuiz = {
            questions: [], // Array of questions in the current quiz
            currentQuestionIndex: 0,
            score: 0,
            timerInterval: null,
            timeRemaining: 0,
            quizActive: false, // Quiz active status
            quizTimeLimit: 30, // Default time limit for each question
            quizType: 'single', // 'single' or 'mixed'
            selectedMixedTopicIds: [], // For mixed quizzes, stores IDs of topics included
            initialWindowWidth: 0, // Store initial window width for cheat detection
            initialWindowHeight: 0 // Store initial window height for cheat detection
        };

        // Global variable to track cheat detection status
        let cheatDetected = false;

        // --- DOM Elements ---
        const generalMessage = document.getElementById('generalMessage');

        // Elements for Topic Management section
        const addTopicForm = document.getElementById('addTopicForm');
        const parentCategorySelect = document.getElementById('parentCategorySelect'); // Select for parent category
        const newTopicNameInput = document.getElementById('newTopicName');
        const categoriesListDiv = document.getElementById('categoriesList'); // Renamed from topicsListDiv

        // Elements for Vocabulary Management section
        const selectCategoryForVocab = document.getElementById('selectCategoryForVocab'); // Select for category
        const selectTopicForVocab = document.getElementById('selectTopicForVocab');
        const vocabContentDiv = document.getElementById('vocabContent');
        const addSingleVocabForm = document.getElementById('addSingleVocabForm');
        const englishWordInput = document.getElementById('englishWord');
        const vietnameseMeaningInput = document.getElementById('vietnameseMeaning');
        const exampleSentenceInput = document.getElementById('exampleSentence');
        const bulkImportVocabForm = document.getElementById('bulkImportVocabForm');
        const bulkVocabInput = document.getElementById('bulkVocabInput');
        const currentTopicVocabTableBody = document.getElementById('currentTopicVocabTableBody');
        const currentVocabCountSpan = document.getElementById('currentVocabCount'); // Added for vocabulary count

        // Elements for Quiz section
        const quizModeRadios = document.querySelectorAll('input[name="quizMode"]');
        const singleTopicQuizOptionsDiv = document.getElementById('singleTopicQuizOptions');
        const mixedTopicQuizOptionsDiv = document.getElementById('mixedTopicQuizOptions');
        const multiTopicCheckboxesDiv = document.getElementById('multiTopicCheckboxes');

        const selectCategoryForQuiz = document.getElementById('selectCategoryForQuiz'); // Select for category
        const selectTopicForQuiz = document.getElementById('selectTopicForQuiz');
        const quizSettingsDiv = document.getElementById('quizSettings');
        const quizQuestionCountInput = document.getElementById('quizQuestionCount');
        const quizTimeLimitInput = document.getElementById('quizTimeLimit');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const generateQuizLinkBtn = document.getElementById('generateQuizLinkBtn'); // New: Generate Link button
        const quizArea = document.getElementById('quizArea');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const totalQuizQuestionsSpan = document.getElementById('totalQuizQuestions');
        const quizTimerSpan = document.getElementById('quizTimer');
        const vietnameseQuestionSpan = document.getElementById('vietnameseQuestion');
        const englishAnswerInput = document.getElementById('englishAnswerInput');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const skipQuestionBtn = document.getElementById('skipQuestionBtn');
        const feedbackMessageDiv = document.getElementById('feedbackMessage'); // Element for feedback
        const quizResultsDiv = document.getElementById('quizResults');
        const correctCountSpan = document.getElementById('correctCount');
        const totalCountSpan = document.getElementById('totalCount');
        const detailedResultsDiv = document.getElementById('detailedResults');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const cheatDetectionMessage = document.getElementById('cheatDetectionMessage');
        const closeCheatMessageBtn = document.getElementById('closeCheatMessageBtn');

        // Elements for Share Link Modal
        const shareLinkModalOverlay = document.getElementById('shareLinkModalOverlay');
        const closeShareLinkModalBtn = document.getElementById('closeShareLinkModalBtn');
        const generatedShareLinkInput = document.getElementById('generatedShareLink');
        const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
        const copyConfirmation = document.getElementById('copyConfirmation');

        // Elements for Performance section
        const selectCategoryForPerformance = document.getElementById('selectCategoryForPerformance');
        const selectTopicForPerformance = document.getElementById('selectTopicForPerformance');
        const performanceContentDiv = document.getElementById('performanceContent');
        const performanceTableBody = document.getElementById('performanceTableBody');
        const vocabPerformanceTableBody = document.getElementById('vocabPerformanceTableBody'); // New element for vocabulary performance

        // Navigation elements
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');

        // --- General Utility Functions ---

        /**
         * Displays a temporary message to the user.
         * @param {string} text - The message to display.
         * @param {string} type - 'success' for green, 'error' for red.
         * @param {number} duration - How long the message is visible in milliseconds.
         */
        function showMessage(text, type = 'success', duration = 3000) {
            generalMessage.textContent = text;
            generalMessage.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            generalMessage.classList.remove('hidden');
            setTimeout(() => {
                generalMessage.classList.add('hidden');
            }, duration);
        }

        /**
         * Saves the entire appData object to localStorage.
         */
        function saveAppData() {
            try {
                localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showMessage("Lỗi khi lưu dữ liệu. Có thể bộ nhớ đầy.", "error");
            }
        }

        /**
         * Loads appData from localStorage. Initializes default categories if not found.
         */
        function loadAppData() {
            try {
                const storedData = localStorage.getItem(APP_DATA_KEY);
                if (storedData) {
                    appData = JSON.parse(storedData);
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                showMessage("Lỗi khi tải dữ liệu. Đang tải dữ liệu mặc định.", "error");
                appData = { categories: [] }; // Reset to default if loading fails
            }

            // Ensure default categories exist and have a 'results' array for existing topics
            let kenExists = false;
            let nhimExists = false;
            appData.categories.forEach(cat => {
                if (cat.id === 'ken') kenExists = true;
                if (cat.id === 'nhim') nhimExists = true;
                cat.topics.forEach(topic => {
                    if (!topic.results) {
                        topic.results = []; // Initialize results array for existing topics
                    }
                    // Ensure vocabulary items have performance counters
                    topic.vocabulary.forEach(vocab => {
                        if (vocab.correct === undefined) vocab.correct = 0;
                        if (vocab.wrong === undefined) vocab.wrong = 0;
                    });
                });
            });

            if (!kenExists) {
                appData.categories.push({ id: 'ken', name: 'Ken', topics: [] });
            }
            if (!nhimExists) {
                appData.categories.push({ id: 'nhim', name: 'Nhím', topics: [] });
            }

            // Sort categories by name for consistent display
            appData.categories.sort((a, b) => a.name.localeCompare(b.name));
            saveAppData(); // Save updated structure
        }


        /**
         * Generates a unique ID for new topics or vocabulary.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // --- Navigation ---
        /**
         * Switches the active section based on the clicked navigation link.
         * @param {string} sectionId - The ID of the section to activate.
         */
        function switchSection(sectionId) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            navLinks.forEach(link => {
                link.classList.remove('active-nav-link');
                if (link.getAttribute('href') === `#${sectionId}`) {
                    link.classList.add('active-nav-link');
                }
            });

            // Re-render content specific to the section if needed
            if (sectionId === 'topics-section') {
                renderCategoriesList();
                populateCategorySelects();
            } else if (sectionId === 'vocabulary-management-section') {
                populateCategorySelects();
                // Reset selected topic and hide vocab content until a topic is chosen
                selectTopicForVocab.innerHTML = '<option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>';
                vocabContentDiv.classList.add('hidden');
                currentTopicId = null;
                currentCategoryId = null; // Reset category too
            } else if (sectionId === 'quiz-section') {
                populateCategorySelects();
                // Reset selected topic and hide quiz area
                selectTopicForQuiz.innerHTML = '<option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>';
                quizArea.classList.add('hidden');
                quizResultsDiv.classList.add('hidden');
                quizSettingsDiv.classList.remove('hidden'); // Ensure settings are visible
                stopQuizTimer(); // Stop any running timer
                currentQuiz.quizActive = false; // Reset quiz state
                englishAnswerInput.value = ''; // Clear input
                feedbackMessageDiv.classList.add('hidden'); // Hide feedback
                document.querySelector('input[name="quizMode"][value="single"]').checked = true; // Default to single topic quiz
                singleTopicQuizOptionsDiv.classList.remove('hidden');
                mixedTopicQuizOptionsDiv.classList.add('hidden');
            } else if (sectionId === 'performance-section') {
                populateCategorySelects();
                // Reset selected topic and hide performance content
                selectTopicForPerformance.innerHTML = '<option value="">-- Chọn chủ đề con để xem hiệu suất --</option>';
            }
        }

        // Event listeners for navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('href').substring(1);
                switchSection(sectionId);
            });
        });

        // --- Category and Topic Management ---

        /**
         * Populates all category dropdowns in the application.
         */
        function populateCategorySelects() {
            const selects = [
                parentCategorySelect,
                selectCategoryForVocab,
                selectCategoryForQuiz,
                selectCategoryForPerformance
            ];

            selects.forEach(selectElement => {
                selectElement.innerHTML = ''; // Clear existing options
                appData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    selectElement.appendChild(option);
                });
                // If there are categories, select the first one by default
                if (appData.categories.length > 0) {
                    selectElement.value = appData.categories[0].id;
                }
                // Trigger change event to load topics if this is for vocab, quiz or performance section and a category is selected
                if (selectElement.id === 'selectCategoryForVocab' && selectElement.value) {
                    currentCategoryId = selectElement.value;
                    populateTopicSelect(selectTopicForVocab, currentCategoryId);
                } else if (selectElement.id === 'selectCategoryForQuiz' && selectElement.value) {
                    currentCategoryId = selectElement.value;
                    populateTopicSelect(selectTopicForQuiz, currentCategoryId);
                    renderMultiTopicCheckboxes(); // Update mixed topic checkboxes as well
                } else if (selectElement.id === 'selectCategoryForPerformance' && selectElement.value) {
                    currentCategoryId = selectElement.value;
                    populateTopicSelect(selectTopicForPerformance, currentCategoryId);
                }
            });
        }


        /**
         * Populates a given topic select element based on the selected category ID.
         * @param {HTMLSelectElement} topicSelectElement - The select element to populate.
         * @param {string} categoryId - The ID of the category.
         * @param {boolean} addDefaultOption - Whether to add a default "-- Select topic --" option.
         */
        function populateTopicSelect(topicSelectElement, categoryId, addDefaultOption = true) {
            topicSelectElement.innerHTML = '';
            if (addDefaultOption) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Chọn chủ đề con để ${topicSelectElement.id.includes('Vocab') ? 'quản lý từ vựng' : (topicSelectElement.id.includes('Quiz') ? 'bắt đầu kiểm tra' : 'xem hiệu suất')} --`;
                topicSelectElement.appendChild(defaultOption);
            }

            const category = appData.categories.find(cat => cat.id === categoryId);
            if (category) {
                category.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.name;
                    topicSelectElement.appendChild(option);
                });
            }
        }

        /**
         * Renders the list of categories and their sub-topics in the "Quản Lý Chủ Đề" section.
         */
        function renderCategoriesList() {
            categoriesListDiv.innerHTML = '';
            if (appData.categories.length === 0) {
                categoriesListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Chưa có chủ đề nào. Hãy thêm chủ đề mới!</p>';
                return;
            }

            appData.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-white p-6 rounded-lg shadow-md';
                categoryDiv.innerHTML = `
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        ${category.name}
                        ${category.id !== 'ken' && category.id !== 'nhim' ? `<button data-category-id="${category.id}" class="delete-category-btn text-red-500 hover:text-red-700 text-sm font-normal">Xóa Mục Lớn</button>` : ''}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="topics-for-category-${category.id}">
                        ${category.topics.length === 0 ? '<p class="text-gray-500 col-span-full">Chưa có chủ đề con nào trong mục này.</p>' : ''}
                    </div>
                `;
                categoriesListDiv.appendChild(categoryDiv);

                const topicsContainer = categoryDiv.querySelector(`#topics-for-category-${category.id}`);
                category.topics.forEach(topic => {
                    const topicCard = document.createElement('div');
                    topicCard.className = 'bg-purple-100 p-4 rounded-lg shadow-sm flex justify-between items-center';
                    topicCard.innerHTML = `
                        <span class="text-lg text-purple-800 font-medium">${topic.name} (${topic.vocabulary.length} từ)</span>
                        <button data-category-id="${category.id}" data-topic-id="${topic.id}" class="delete-topic-btn text-red-500 hover:text-red-700 text-sm">Xóa</button>
                    `;
                    topicsContainer.appendChild(topicCard);
                });
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-topic-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryId = e.target.dataset.categoryId;
                    const topicId = e.target.dataset.topicId;
                    deleteTopic(categoryId, topicId);
                });
            });

            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryId = e.target.dataset.categoryId;
                    deleteCategory(categoryId);
                });
            });
        }

        /**
         * Adds a new sub-topic to a selected parent category.
         * @param {Event} e - The form submission event.
         */
        addTopicForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const parentCategoryId = parentCategorySelect.value;
            const newTopicName = newTopicNameInput.value.trim();

            if (!parentCategoryId) {
                showMessage("Vui lòng chọn một mục lớn.", "error");
                return;
            }

            if (!newTopicName) {
                showMessage("Vui lòng nhập tên chủ đề con.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === parentCategoryId);
            if (category) {
                // Check for duplicate topic names within the same category (case-insensitive)
                const isDuplicate = category.topics.some(topic => topic.name.toLowerCase() === newTopicName.toLowerCase());
                if (isDuplicate) {
                    showMessage(`Chủ đề con "${newTopicName}" đã tồn tại trong mục "${category.name}".`, "error");
                    return;
                }

                const newTopic = {
                    id: generateUniqueId(),
                    name: newTopicName,
                    vocabulary: [], // Array to store vocabulary items
                    results: [] // Array to store quiz results for this topic
                };
                category.topics.push(newTopic);
                saveAppData();
                renderCategoriesList();
                populateTopicSelect(selectTopicForVocab, parentCategoryId); // Update vocab management topics
                populateTopicSelect(selectTopicForQuiz, parentCategoryId); // Update quiz topics
                renderMultiTopicCheckboxes(); // Update mixed topic checkboxes
                newTopicNameInput.value = '';
                showMessage(`Đã thêm chủ đề "${newTopicName}" vào mục "${category.name}".`);
            } else {
                showMessage("Không tìm thấy mục lớn đã chọn.", "error");
            }
        });

        /**
         * Deletes a specific sub-topic.
         * @param {string} categoryId - The ID of the parent category.
         * @param {string} topicId - The ID of the topic to delete.
         */
        function deleteTopic(categoryId, topicId) {
            if (!confirm("Bạn có chắc chắn muốn xóa chủ đề này và tất cả từ vựng của nó?")) {
                return;
            }

            const category = appData.categories.find(cat => cat.id === categoryId);
            if (category) {
                const initialLength = category.topics.length;
                category.topics = category.topics.filter(topic => topic.id !== topicId);
                if (category.topics.length < initialLength) {
                    saveAppData();
                    renderCategoriesList();
                    populateTopicSelect(selectTopicForVocab, categoryId);
                    populateTopicSelect(selectTopicForQuiz, categoryId);
                    renderMultiTopicCheckboxes();
                    // If the deleted topic was currently selected in vocab management, clear vocab content
                    if (currentTopicId === topicId) {
                        vocabContentDiv.classList.add('hidden');
                        currentTopicId = null;
                        currentCategoryId = null;
                    }
                    showMessage("Chủ đề đã được xóa thành công.");
                } else {
                    showMessage("Không tìm thấy chủ đề để xóa.", "error");
                }
            } else {
                showMessage("Không tìm thấy mục lớn.", "error");
            }
        }

        /**
         * Deletes an entire main category.
         * @param {string} categoryId - The ID of the category to delete.
         */
        function deleteCategory(categoryId) {
            if (!confirm("Bạn có chắc chắn muốn xóa mục lớn này và tất cả các chủ đề con, từ vựng của nó?")) {
                return;
            }

            // Prevent deletion of default categories
            if (categoryId === 'ken' || categoryId === 'nhim') {
                showMessage("Không thể xóa các mục lớn mặc định (Ken, Nhím).", "error");
                return;
            }

            const initialLength = appData.categories.length;
            appData.categories = appData.categories.filter(cat => cat.id !== categoryId);
            if (appData.categories.length < initialLength) {
                saveAppData();
                renderCategoriesList();
                populateCategorySelects(); // Re-populate all category dropdowns
                // If the deleted category was currently selected in vocab/quiz/performance management, reset selection
                if (currentCategoryId === categoryId) {
                    currentCategoryId = null;
                    currentTopicId = null;
                    vocabContentDiv.classList.add('hidden');
                    performanceContentDiv.classList.add('hidden');
                    selectTopicForVocab.innerHTML = '<option value="">-- Chọn chủ đề con để quản lý từ vựng --</option>';
                    selectTopicForQuiz.innerHTML = '<option value="">-- Chọn chủ đề con để bắt đầu kiểm tra --</option>';
                    selectTopicForPerformance.innerHTML = '<option value="">-- Chọn chủ đề con để xem hiệu suất --</option>';
                }
                showMessage("Mục lớn đã được xóa thành công.");
            } else {
                showMessage("Không tìm thấy mục lớn để xóa.", "error");
            }
        }

        // --- Vocabulary Management ---

        selectCategoryForVocab.addEventListener('change', (e) => {
            currentCategoryId = e.target.value;
            populateTopicSelect(selectTopicForVocab, currentCategoryId);
            vocabContentDiv.classList.add('hidden'); // Hide vocab content until a topic is selected
            currentTopicId = null;
        });

        selectTopicForVocab.addEventListener('change', (e) => {
            currentTopicId = e.target.value;
            if (currentTopicId) {
                vocabContentDiv.classList.remove('hidden');
                renderVocabularyTable();
            } else {
                vocabContentDiv.classList.add('hidden');
            }
        });

        /**
         * Renders the vocabulary table for the currently selected topic.
         */
        function renderVocabularyTable() {
            currentTopicVocabTableBody.innerHTML = '';
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic && topic.vocabulary.length > 0) {
                currentVocabCountSpan.textContent = topic.vocabulary.length;
                topic.vocabulary.forEach(vocab => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${vocab.english}</td>
                        <td class="py-3 px-6 text-left">${vocab.vietnamese}</td>
                        <td class="py-3 px-6 text-left">${vocab.example || ''}</td>
                        <td class="py-3 px-6 text-center">
                            <button data-vocab-id="${vocab.id}" class="delete-vocab-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs transition-colors duration-200">Xóa</button>
                        </td>
                    `;
                    currentTopicVocabTableBody.appendChild(row);
                });

                document.querySelectorAll('.delete-vocab-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const vocabId = e.target.dataset.vocabId;
                        deleteVocabulary(vocabId);
                    });
                });
            } else {
                currentVocabCountSpan.textContent = '0';
                currentTopicVocabTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chủ đề này chưa có từ vựng nào.</td></tr>';
            }
        }

        /**
         * Adds a single vocabulary word to the current topic.
         * @param {Event} e - The form submission event.
         */
        addSingleVocabForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const english = englishWordInput.value.trim();
            const vietnamese = vietnameseMeaningInput.value.trim();
            const example = exampleSentenceInput.value.trim();

            if (!currentTopicId) {
                showMessage("Vui lòng chọn một chủ đề con trước khi thêm từ vựng.", "error");
                return;
            }

            if (!english || !vietnamese) {
                showMessage("Từ Tiếng Anh và Nghĩa Tiếng Việt không được để trống.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic) {
                // Check for duplicate English words (case-insensitive)
                const isDuplicate = topic.vocabulary.some(vocab => vocab.english.toLowerCase() === english.toLowerCase());
                if (isDuplicate) {
                    showMessage(`Từ "${english}" đã tồn tại trong chủ đề này.`, "error");
                    return;
                }

                const newVocab = {
                    id: generateUniqueId(),
                    english,
                    vietnamese,
                    example,
                    correct: 0, // Performance tracking
                    wrong: 0    // Performance tracking
                };
                topic.vocabulary.push(newVocab);
                saveAppData();
                renderVocabularyTable();
                englishWordInput.value = '';
                vietnameseMeaningInput.value = '';
                exampleSentenceInput.value = '';
                showMessage(`Đã thêm từ "${english}" vào chủ đề "${topic.name}".`);
            } else {
                showMessage("Không tìm thấy chủ đề đã chọn.", "error");
            }
        });

        /**
         * Imports vocabulary words in bulk.
         * @param {Event} e - The form submission event.
         */
        bulkImportVocabForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const bulkInput = bulkVocabInput.value.trim();

            if (!currentTopicId) {
                showMessage("Vui lòng chọn một chủ đề con trước khi nhập hàng loạt từ vựng.", "error");
                return;
            }

            if (!bulkInput) {
                showMessage("Vui lòng nhập dữ liệu từ vựng để nhập hàng loạt.", "error");
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic) {
                const lines = bulkInput.split('\n').filter(line => line.trim() !== '');
                let addedCount = 0;
                let skippedCount = 0;

                lines.forEach(line => {
                    const parts = line.split(' - ').map(part => part.trim());
                    if (parts.length >= 2) {
                        const english = parts[0];
                        const vietnamese = parts[1];
                        const example = parts[2] || '';

                        // Check for duplicate English words before adding
                        const isDuplicate = topic.vocabulary.some(vocab => vocab.english.toLowerCase() === english.toLowerCase());
                        if (isDuplicate) {
                            skippedCount++;
                        } else {
                            topic.vocabulary.push({
                                id: generateUniqueId(),
                                english,
                                vietnamese,
                                example,
                                correct: 0,
                                wrong: 0
                            });
                            addedCount++;
                        }
                    } else {
                        skippedCount++; // Line format is incorrect
                    }
                });

                saveAppData();
                renderVocabularyTable();
                bulkVocabInput.value = '';
                let message = `Đã nhập thành công ${addedCount} từ vào chủ đề "${topic.name}".`;
                if (skippedCount > 0) {
                    message += ` Bỏ qua ${skippedCount} từ (trùng lặp hoặc sai định dạng).`;
                    showMessage(message, addedCount > 0 ? 'success' : 'error');
                } else {
                    showMessage(message);
                }
            } else {
                showMessage("Không tìm thấy chủ đề đã chọn.", "error");
            }
        });

        /**
         * Deletes a specific vocabulary word from the current topic.
         * @param {string} vocabId - The ID of the vocabulary word to delete.
         */
        function deleteVocabulary(vocabId) {
            if (!confirm("Bạn có chắc chắn muốn xóa từ vựng này?")) {
                return;
            }

            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic) {
                const initialLength = topic.vocabulary.length;
                topic.vocabulary = topic.vocabulary.filter(vocab => vocab.id !== vocabId);
                if (topic.vocabulary.length < initialLength) {
                    saveAppData();
                    renderVocabularyTable();
                    showMessage("Từ vựng đã được xóa thành công.");
                } else {
                    showMessage("Không tìm thấy từ vựng để xóa.", "error");
                }
            } else {
                showMessage("Không tìm thấy chủ đề đã chọn.", "error");
            }
        }

        // --- Quiz Section ---

        // Event listener for quiz mode change
        quizModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentQuiz.quizType = e.target.value;
                if (currentQuiz.quizType === 'single') {
                    singleTopicQuizOptionsDiv.classList.remove('hidden');
                    mixedTopicQuizOptionsDiv.classList.add('hidden');
                } else {
                    singleTopicQuizOptionsDiv.classList.add('hidden');
                    mixedTopicQuizOptionsDiv.classList.remove('hidden');
                    renderMultiTopicCheckboxes();
                }
            });
        });

        selectCategoryForQuiz.addEventListener('change', (e) => {
            currentCategoryId = e.target.value;
            populateTopicSelect(selectTopicForQuiz, currentCategoryId);
            renderMultiTopicCheckboxes(); // Update mixed topic checkboxes
        });

        /**
         * Renders the checkboxes for selecting multiple topics in mixed quiz mode.
         */
        function renderMultiTopicCheckboxes() {
            multiTopicCheckboxesDiv.innerHTML = '';
            const allTopics = [];
            appData.categories.forEach(cat => {
                cat.topics.forEach(topic => {
                    allTopics.push({ categoryId: cat.id, categoryName: cat.name, topicId: topic.id, topicName: topic.name, vocabCount: topic.vocabulary.length });
                });
            });

            if (allTopics.length === 0) {
                multiTopicCheckboxesDiv.innerHTML = '<p class="text-gray-500 col-span-full">Chưa có chủ đề nào để chọn.</p>';
                return;
            }

            allTopics.sort((a, b) => a.topicName.localeCompare(b.topicName)); // Sort topics alphabetically

            allTopics.forEach(topic => {
                const div = document.createElement('div');
                div.className = 'multi-select-option flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="topic-checkbox-${topic.topicId}" value="${topic.topicId}"
                           data-category-id="${topic.categoryId}" class="form-checkbox text-purple-600 h-4 w-4">
                    <label for="topic-checkbox-${topic.topicId}" class="ml-2 text-gray-700 cursor-pointer">
                        ${topic.topicName} <span class="text-gray-500 text-sm">(${topic.vocabCount} từ)</span>
                        <span class="text-xs text-gray-500 block">Mục: ${topic.categoryName}</span>
                    </label>
                `;
                multiTopicCheckboxesDiv.appendChild(div);
            });
        }

        startQuizBtn.addEventListener('click', startQuiz);
        submitAnswerBtn.addEventListener('click', submitAnswer);
        skipQuestionBtn.addEventListener('click', skipQuestion);
        retakeQuizBtn.addEventListener('click', startQuiz); // Retake button also calls startQuiz

        englishAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });

        /**
         * Initializes and starts the quiz.
         */
        function startQuiz() {
            if (currentQuiz.quizActive) {
                stopQuizTimer();
            }
            cheatDetected = false;
            cheatDetectionMessage.classList.add('hidden'); // Hide cheat message if it was shown

            let selectedVocabularies = [];

            if (currentQuiz.quizType === 'single') {
                const categoryId = selectCategoryForQuiz.value;
                const topicId = selectTopicForQuiz.value;

                if (!categoryId || !topicId) {
                    showMessage("Vui lòng chọn một mục lớn và một chủ đề con để bắt đầu kiểm tra.", "error");
                    return;
                }

                const category = appData.categories.find(cat => cat.id === categoryId);
                const topic = category ? category.topics.find(t => t.id === topicId) : null;

                if (!topic || topic.vocabulary.length === 0) {
                    showMessage("Chủ đề này không có từ vựng nào để kiểm tra.", "error");
                    return;
                }
                selectedVocabularies = [...topic.vocabulary]; // Copy array
                currentTopicId = topicId; // Set current topic for performance tracking
                currentCategoryId = categoryId; // Set current category for performance tracking
            } else { // Mixed quiz
                const selectedTopicIds = Array.from(multiTopicCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                            .map(checkbox => checkbox.value);

                if (selectedTopicIds.length === 0) {
                    showMessage("Vui lòng chọn ít nhất một chủ đề con để kiểm tra ngẫu nhiên.", "error");
                    return;
                }
                currentQuiz.selectedMixedTopicIds = selectedTopicIds; // Store for quiz results
                currentQuiz.quizActive = true;

                selectedTopicIds.forEach(topicId => {
                    appData.categories.forEach(cat => {
                        const topic = cat.topics.find(t => t.id === topicId);
                        if (topic) {
                            selectedVocabularies.push(...topic.vocabulary);
                        }
                    });
                });

                if (selectedVocabularies.length === 0) {
                    showMessage("Không có từ vựng nào trong các chủ đề đã chọn để kiểm tra.", "error");
                    return;
                }
                // For mixed quiz, we don't set currentCategoryId/currentTopicId for performance tracking at this stage
                // Performance will be tracked per word
            }


            const questionCount = parseInt(quizQuestionCountInput.value);
            currentQuiz.quizTimeLimit = parseInt(quizTimeLimitInput.value);

            if (questionCount <= 0 || isNaN(questionCount)) {
                showMessage("Số lượng câu hỏi phải là một số dương.", "error");
                return;
            }
            if (currentQuiz.quizTimeLimit < 5 || isNaN(currentQuiz.quizTimeLimit)) {
                showMessage("Thời gian giới hạn phải lớn hơn hoặc bằng 5 giây.", "error");
                return;
            }

            // Shuffle vocabulary and select questions
            currentQuiz.questions = shuffleArray(selectedVocabularies)
                                    .slice(0, Math.min(questionCount, selectedVocabularies.length))
                                    .map(vocab => ({
                                        vocabId: vocab.id,
                                        english: vocab.english,
                                        vietnamese: vocab.vietnamese,
                                        correct: false, // Track if answered correctly
                                        timeTaken: 0, // Time taken for this question
                                        skipped: false // Track if skipped
                                    }));

            if (currentQuiz.questions.length === 0) {
                showMessage("Không đủ từ vựng để tạo bài kiểm tra với số lượng câu hỏi yêu cầu.", "error");
                return;
            }

            currentQuiz.currentQuestionIndex = 0;
            currentQuiz.score = 0;
            currentQuiz.quizActive = true;

            quizSettingsDiv.classList.add('hidden');
            quizResultsDiv.classList.add('hidden');
            quizArea.classList.remove('hidden');
            feedbackMessageDiv.classList.add('hidden');
            englishAnswerInput.value = '';
            englishAnswerInput.focus();

            // Set initial window dimensions for cheat detection
            currentQuiz.initialWindowWidth = window.innerWidth;
            currentQuiz.initialWindowHeight = window.innerHeight;

            displayQuestion();
        }

        /**
         * Displays the current quiz question.
         */
        function displayQuestion() {
            if (currentQuiz.currentQuestionIndex < currentQuiz.questions.length) {
                const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
                currentQuestionNumberSpan.textContent = currentQuiz.currentQuestionIndex + 1;
                totalQuizQuestionsSpan.textContent = currentQuiz.questions.length;
                vietnameseQuestionSpan.textContent = question.vietnamese;
                englishAnswerInput.value = '';
                englishAnswerInput.focus();
                feedbackMessageDiv.classList.add('hidden'); // Hide feedback from previous question
                startQuizTimer();
            } else {
                endQuiz();
            }
        }

        /**
         * Starts the timer for the current quiz question.
         */
        function startQuizTimer() {
            stopQuizTimer(); // Clear any existing timer
            currentQuiz.timeRemaining = currentQuiz.quizTimeLimit;
            quizTimerSpan.textContent = currentQuiz.timeRemaining;

            currentQuiz.timerInterval = setInterval(() => {
                currentQuiz.timeRemaining--;
                quizTimerSpan.textContent = currentQuiz.timeRemaining;

                if (currentQuiz.timeRemaining <= 0) {
                    clearInterval(currentQuiz.timerInterval);
                    submitAnswer(true); // Automatically submit if time runs out
                }
            }, 1000);
        }

        /**
         * Stops the quiz timer.
         */
        function stopQuizTimer() {
            if (currentQuiz.timerInterval) {
                clearInterval(currentQuiz.timerInterval);
                currentQuiz.timerInterval = null;
            }
        }

        /**
         * Submits the user's answer for the current question.
         * @param {boolean} timedOut - True if the submission is due to a timeout.
         */
        function submitAnswer(timedOut = false) {
            if (!currentQuiz.quizActive || cheatDetected) return;

            stopQuizTimer(); // Stop timer immediately on submission
            const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            const userAnswer = englishAnswerInput.value.trim();
            const correctAnswer = question.english;

            question.timeTaken = currentQuiz.quizTimeLimit - currentQuiz.timeRemaining;
            if (timedOut) {
                question.timeTaken = currentQuiz.quizTimeLimit; // Full time if timed out
            }

            let isCorrect = false;
            if (timedOut) {
                feedbackMessageDiv.textContent = `Hết giờ! Đáp án đúng là: "${correctAnswer}"`;
                feedbackMessageDiv.className = 'text-center mt-4 text-lg font-semibold text-red-600';
            } else if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                feedbackMessageDiv.textContent = 'Chính xác!';
                feedbackMessageDiv.className = 'text-center mt-4 text-lg font-semibold text-green-600';
                currentQuiz.score++;
                isCorrect = true;
            } else {
                feedbackMessageDiv.textContent = `Sai rồi! Đáp án đúng là: "${correctAnswer}"`;
                feedbackMessageDiv.className = 'text-center mt-4 text-lg font-semibold text-red-600';
            }
            feedbackMessageDiv.classList.remove('hidden');

            question.correct = isCorrect; // Record correctness for detailed results and performance tracking

            // Update performance counters for the specific vocabulary word
            updateVocabularyPerformance(question.vocabId, isCorrect);

            // Wait a bit before moving to the next question
            setTimeout(() => {
                currentQuiz.currentQuestionIndex++;
                displayQuestion();
            }, 1500); // Display feedback for 1.5 seconds
        }

        /**
         * Skips the current question.
         */
        function skipQuestion() {
            if (!currentQuiz.quizActive || cheatDetected) return;

            stopQuizTimer();
            const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            question.skipped = true;
            question.correct = false; // Skipped questions are considered incorrect

            feedbackMessageDiv.textContent = `Đã bỏ qua. Đáp án đúng là: "${question.english}"`;
            feedbackMessageDiv.className = 'text-center mt-4 text-lg font-semibold text-gray-600';
            feedbackMessageDiv.classList.remove('hidden');

            // No performance update for skipped words to avoid penalizing them incorrectly
            // updateVocabularyPerformance(question.vocabId, false); // Or handle skips differently

            setTimeout(() => {
                currentQuiz.currentQuestionIndex++;
                displayQuestion();
            }, 1000); // Display feedback for 1 second
        }

        /**
         * Ends the current quiz and displays results.
         */
        function endQuiz() {
            stopQuizTimer();
            currentQuiz.quizActive = false;
            quizArea.classList.add('hidden');
            quizSettingsDiv.classList.add('hidden'); // Hide settings if quiz ends naturally
            quizResultsDiv.classList.remove('hidden');

            correctCountSpan.textContent = currentQuiz.score;
            totalCountSpan.textContent = currentQuiz.questions.length;

            detailedResultsDiv.innerHTML = '';
            currentQuiz.questions.forEach((q, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = `p-3 rounded-md shadow-sm ${q.correct ? 'bg-green-50' : (q.skipped ? 'bg-gray-50' : 'bg-red-50')}`;
                const originalVocab = findVocabularyById(q.vocabId);
                const exampleText = originalVocab && originalVocab.example ? `<span class="text-gray-600 text-sm italic block mt-1">Ví dụ: ${originalVocab.example}</span>` : '';

                resultItem.innerHTML = `
                    <p class="font-medium text-lg">${index + 1}. <span class="${q.correct ? 'text-green-700' : (q.skipped ? 'text-gray-700' : 'text-red-700')}">${q.vietnamese}</span>
                       <span class="text-gray-600"> -> </span>
                       <span class="${q.correct ? 'text-green-700' : (q.skipped ? 'text-gray-700' : 'text-red-700')}">${q.english}</span>
                    </p>
                    ${exampleText}
                    <p class="text-xs text-gray-500 mt-1">Thời gian: ${q.timeTaken} giây</p>
                `;
                detailedResultsDiv.appendChild(resultItem);
            });

            // Save quiz result for performance tracking
            saveQuizResult();
        }

        /**
         * Saves the current quiz result to the relevant topic's results.
         */
        function saveQuizResult() {
            const quizSummary = {
                date: new Date().toISOString(),
                score: currentQuiz.score,
                totalQuestions: currentQuiz.questions.length,
                type: currentQuiz.quizType,
                details: currentQuiz.questions.map(q => ({
                    vocabId: q.vocabId,
                    correct: q.correct,
                    skipped: q.skipped
                }))
            };

            if (currentQuiz.quizType === 'single' && currentCategoryId && currentTopicId) {
                const category = appData.categories.find(cat => cat.id === currentCategoryId);
                const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;
                if (topic) {
                    if (!topic.results) topic.results = []; // Ensure results array exists
                    topic.results.push(quizSummary);
                }
            } else if (currentQuiz.quizType === 'mixed') {
                // For mixed quizzes, store results for each topic involved
                currentQuiz.selectedMixedTopicIds.forEach(topicId => {
                    const category = appData.categories.find(cat => cat.topics.some(t => t.id === topicId));
                    const topic = category ? category.topics.find(t => t.id === topicId) : null;
                    if (topic) {
                        if (!topic.results) topic.results = [];
                        // Create a quiz summary specific to this topic's words in the mixed quiz
                        const topicSpecificQuestions = quizSummary.details.filter(d => {
                            const vocab = findVocabularyById(d.vocabId);
                            return vocab && topic.vocabulary.some(v => v.id === vocab.id);
                        });
                        if (topicSpecificQuestions.length > 0) {
                            topic.results.push({
                                date: quizSummary.date,
                                score: topicSpecificQuestions.filter(q => q.correct).length,
                                totalQuestions: topicSpecificQuestions.length,
                                type: 'mixed-subset', // Indicate it's a subset of a mixed quiz
                                details: topicSpecificQuestions
                            });
                        }
                    }
                });
            }
            saveAppData();
        }

        /**
         * Updates the correct/wrong counts for a specific vocabulary word.
         * @param {string} vocabId - The ID of the vocabulary word.
         * @param {boolean} isCorrect - True if the answer was correct, false otherwise.
         */
        function updateVocabularyPerformance(vocabId, isCorrect) {
            let found = false;
            for (const category of appData.categories) {
                for (const topic of category.topics) {
                    const vocab = topic.vocabulary.find(v => v.id === vocabId);
                    if (vocab) {
                        if (isCorrect) {
                            vocab.correct++;
                        } else {
                            vocab.wrong++;
                        }
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            if (found) {
                saveAppData();
            } else {
                console.warn(`Vocabulary with ID ${vocabId} not found for performance update.`);
            }
        }

        /**
         * Helper function to find a vocabulary object by its ID across all topics.
         * @param {string} vocabId - The ID of the vocabulary word.
         * @returns {object|null} The vocabulary object or null if not found.
         */
        function findVocabularyById(vocabId) {
            for (const category of appData.categories) {
                for (const topic of category.topics) {
                    const vocab = topic.vocabulary.find(v => v.id === vocabId);
                    if (vocab) {
                        return vocab;
                    }
                }
            }
            return null;
        }

        /**
         * Shuffles an array randomly.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Cheat Detection ---

        // Event listeners for cheat detection
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('blur', handleVisibilityChange);
        window.addEventListener('resize', handleResize);

        /**
         * Handles visibility changes (tab switching or window minimization/restoration).
         */
        function handleVisibilityChange() {
            if (currentQuiz.quizActive && document.hidden && !cheatDetected) {
                detectCheat();
            }
        }

        /**
         * Handles window resize events for cheat detection.
         */
        function handleResize() {
            // Give a small tolerance for minor resizes
            if (currentQuiz.quizActive && !cheatDetected && (Math.abs(window.innerWidth - currentQuiz.initialWindowWidth) > 50 || Math.abs(window.innerHeight - currentQuiz.initialWindowHeight) > 50)) {
                detectCheat();
            }
        }

        /**
         * Triggers cheat detection and ends the quiz.
         */
        function detectCheat() {
            if (cheatDetected) return; // Prevent multiple detections

            cheatDetected = true;
            stopQuizTimer();
            currentQuiz.quizActive = false;
            quizArea.classList.add('hidden');
            quizSettingsDiv.classList.add('hidden');
            quizResultsDiv.classList.add('hidden');
            cheatDetectionMessage.classList.remove('hidden');
            console.warn("Cheat detected! Quiz cancelled.");

            // Optionally, you might want to log this or prevent saving results
            // For now, we just prevent normal quiz flow.
        }

        closeCheatMessageBtn.addEventListener('click', () => {
            cheatDetectionMessage.classList.add('hidden');
            cheatDetected = false; // Reset for next quiz attempt
            // Reset UI state as if quiz was never started, or navigate back to quiz settings
            switchSection('quiz-section');
        });

        // --- Performance Section ---

        selectCategoryForPerformance.addEventListener('change', (e) => {
            currentCategoryId = e.target.value;
            populateTopicSelect(selectTopicForPerformance, currentCategoryId);
            performanceContentDiv.classList.add('hidden'); // Hide performance content until a topic is selected
        });

        selectTopicForPerformance.addEventListener('change', (e) => {
            currentTopicId = e.target.value;
            if (currentTopicId) {
                performanceContentDiv.classList.remove('hidden');
                renderPerformanceHistory();
                renderVocabPerformance();
            } else {
                performanceContentDiv.classList.add('hidden');
            }
        });

        /**
         * Renders the quiz history for the selected topic.
         */
        function renderPerformanceHistory() {
            performanceTableBody.innerHTML = '';
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic && topic.results && topic.results.length > 0) {
                // Sort results by date descending
                const sortedResults = [...topic.results].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedResults.forEach((result, index) => {
                    const date = new Date(result.date).toLocaleString('vi-VN', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${date}</td>
                        <td class="py-3 px-6 text-left">${result.score}</td>
                        <td class="py-3 px-6 text-left">${result.totalQuestions}</td>
                        <td class="py-3 px-6 text-left">${result.type === 'single' ? 'Theo chủ đề' : (result.type === 'mixed' ? 'Ngẫu nhiên' : 'Ngẫu nhiên (một phần)')}</td>
                        <td class="py-3 px-6 text-center">
                            <button data-index="${index}" class="view-details-btn bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-xs transition-colors duration-200">Xem Chi Tiết</button>
                        </td>
                    `;
                    performanceTableBody.appendChild(row);
                });

                document.querySelectorAll('.view-details-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        showQuizDetailsModal(sortedResults[index]);
                    });
                });

            } else {
                performanceTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Chưa có lịch sử bài kiểm tra cho chủ đề này.</td></tr>';
            }
        }

        /**
         * Renders the vocabulary performance metrics for the selected topic.
         */
        function renderVocabPerformance() {
            vocabPerformanceTableBody.innerHTML = '';
            const category = appData.categories.find(cat => cat.id === currentCategoryId);
            const topic = category ? category.topics.find(t => t.id === currentTopicId) : null;

            if (topic && topic.vocabulary.length > 0) {
                // Sort vocabulary by correctness ratio (less correct first)
                const sortedVocab = [...topic.vocabulary].sort((a, b) => {
                    const ratioA = (a.correct + a.wrong) > 0 ? a.correct / (a.correct + a.wrong) : 0;
                    const ratioB = (b.correct + b.wrong) > 0 ? b.correct / (b.correct + b.wrong) : 0;
                    // Sort primarily by ratio (ascending), then by wrong count (descending) for tie-breaking
                    if (ratioA !== ratioB) return ratioA - ratioB;
                    return b.wrong - a.wrong;
                });


                sortedVocab.forEach(vocab => {
                    const totalAttempts = vocab.correct + vocab.wrong;
                    const correctRatio = totalAttempts > 0 ? ((vocab.correct / totalAttempts) * 100).toFixed(1) : 'N/A';

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${vocab.english}</td>
                        <td class="py-3 px-6 text-left">${vocab.correct}</td>
                        <td class="py-3 px-6 text-left">${vocab.wrong}</td>
                        <td class="py-3 px-6 text-left">${correctRatio}%</td>
                    `;
                    vocabPerformanceTableBody.appendChild(row);
                });
            } else {
                vocabPerformanceTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Chưa có dữ liệu hiệu suất từ vựng cho chủ đề này.</td></tr>';
            }
        }

        // --- Quiz Details Modal ---
        let quizDetailsModal = null; // Global variable to hold the modal element

        /**
         * Creates and displays the quiz details modal.
         * @param {object} quizResult - The quiz result object to display.
         */
        function showQuizDetailsModal(quizResult) {
            if (quizDetailsModal) {
                quizDetailsModal.remove(); // Remove existing modal if any
            }

            quizDetailsModal = document.createElement('div');
            quizDetailsModal.className = 'modal-overlay';
            quizDetailsModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close-btn">&times;</button>
                    <h3 class="text-2xl font-bold text-purple-700 mb-4">Chi Tiết Bài Kiểm Tra</h3>
                    <p class="mb-2"><strong>Ngày:</strong> ${new Date(quizResult.date).toLocaleString('vi-VN')}</p>
                    <p class="mb-2"><strong>Điểm:</strong> ${quizResult.score} / ${quizResult.totalQuestions}</p>
                    <p class="mb-4"><strong>Loại bài:</strong> ${quizResult.type === 'single' ? 'Theo chủ đề' : (quizResult.type === 'mixed' ? 'Ngẫu nhiên' : 'Ngẫu nhiên (một phần)')}</p>
                    <h4 class="text-xl font-semibold mb-3">Các câu hỏi:</h4>
                    <div class="max-h-80 overflow-y-auto space-y-3 p-2 border rounded-md bg-gray-50" id="modalDetailedResults">
                        </div>
                </div>
            `;
            document.body.appendChild(quizDetailsModal);

            const modalDetailedResultsDiv = quizDetailsModal.querySelector('#modalDetailedResults');
            quizResult.details.forEach((detail, index) => {
                const originalVocab = findVocabularyById(detail.vocabId);
                if (!originalVocab) return; // Skip if vocabulary not found

                const resultItem = document.createElement('div');
                resultItem.className = `p-2 rounded-md ${detail.correct ? 'bg-green-100' : (detail.skipped ? 'bg-gray-100' : 'bg-red-100')}`;
                resultItem.innerHTML = `
                    <p class="font-medium">
                        ${index + 1}. <span class="${detail.correct ? 'text-green-800' : (detail.skipped ? 'text-gray-800' : 'text-red-800')}">${originalVocab.vietnamese}</span>
                        <span class="text-gray-600"> -> </span>
                        <span class="${detail.correct ? 'text-green-800' : (detail.skipped ? 'text-gray-800' : 'text-red-800')}">${originalVocab.english}</span>
                    </p>
                    ${originalVocab.example ? `<p class="text-xs text-gray-500 italic mt-1">Ví dụ: ${originalVocab.example}</p>` : ''}
                    ${detail.skipped ? '<p class="text-xs text-gray-500">Đã bỏ qua</p>' : ''}
                `;
                modalDetailedResultsDiv.appendChild(resultItem);
            });

            // Show the modal with animation
            setTimeout(() => {
                quizDetailsModal.classList.add('show');
            }, 10); // Small delay to allow transition

            quizDetailsModal.querySelector('.modal-close-btn').addEventListener('click', hideQuizDetailsModal);
            quizDetailsModal.addEventListener('click', (e) => {
                if (e.target === quizDetailsModal) { // Clicked outside the content
                    hideQuizDetailsModal();
                }
            });
        }

        /**
         * Hides the quiz details modal.
         */
        function hideQuizDetailsModal() {
            if (quizDetailsModal) {
                quizDetailsModal.classList.remove('show');
                quizDetailsModal.addEventListener('transitionend', () => {
                    quizDetailsModal.remove();
                    quizDetailsModal = null;
                }, { once: true });
            }
        }

        // --- Share Link Logic ---

        /**
         * Generates a shareable URL for the current quiz configuration.
         * Encodes quiz settings into a URL parameter.
         */
        function generateShareableLink() {
            let quizConfig = {
                mode: currentQuiz.quizType,
                questionCount: parseInt(quizQuestionCountInput.value),
                timeLimit: parseInt(quizTimeLimitInput.value)
            };

            if (currentQuiz.quizType === 'single') {
                quizConfig.categoryId = selectCategoryForQuiz.value;
                quizConfig.topicId = selectTopicForQuiz.value;
                if (!quizConfig.categoryId || !quizConfig.topicId) {
                    showMessage("Vui lòng chọn một mục lớn và một chủ đề con để tạo link.", "error");
                    return;
                }
            } else { // mixed
                quizConfig.selectedTopicIds = Array.from(multiTopicCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                               .map(checkbox => checkbox.value);
                if (quizConfig.selectedTopicIds.length === 0) {
                    showMessage("Vui lòng chọn ít nhất một chủ đề con để tạo link cho bài kiểm tra ngẫu nhiên.", "error");
                    return;
                }
            }

            // Compress the JSON string (simple compression for URL, not true gzip)
            // For more robust compression, consider a library like pako.js (deflate/inflate)
            const jsonString = JSON.stringify(quizConfig);
            // encodeURIComponent for URL safety, then btoa for base64
            const compressed = btoa(encodeURIComponent(jsonString).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));

            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?quizConfig=${compressed}#quiz-section`;

            generatedShareLinkInput.value = shareUrl;
            copyConfirmation.classList.add('hidden'); // Hide previous confirmation
            shareLinkModalOverlay.classList.remove('hidden');
        }

        /**
         * Loads quiz configuration from URL parameters, if present.
         * This function is called on DOMContentLoaded.
         */
        async function loadQuizConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedConfig = urlParams.get('quizConfig');

            if (encodedConfig) {
                try {
                    // Decompress and decode the configuration
                    // atob for base64, then decodeURIComponent for URL safety
                    const jsonString = decodeURIComponent(atob(encodedConfig).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const quizConfig = JSON.parse(jsonString);

                    // Apply configurations to the UI
                    // Set quiz mode
                    currentQuiz.quizType = quizConfig.mode;
                    const modeRadio = document.querySelector(`input[name="quizMode"][value="${quizConfig.mode}"]`);
                    if (modeRadio) {
                        modeRadio.checked = true;
                        // Trigger change event manually to update UI
                        modeRadio.dispatchEvent(new Event('change'));
                    }

                    // Set question count and time limit
                    quizQuestionCountInput.value = quizConfig.questionCount;
                    quizTimeLimitInput.value = quizConfig.timeLimit;

                    // Ensure categories and topics are loaded before selecting
                    // A small delay might be needed for DOM updates from populateCategorySelects
                    await new Promise(resolve => setTimeout(resolve, 100)); // Increased delay for stability

                    if (quizConfig.mode === 'single') {
                        selectCategoryForQuiz.value = quizConfig.categoryId;
                        // Trigger change event for category to populate topics
                        selectCategoryForQuiz.dispatchEvent(new Event('change'));
                        await new Promise(resolve => setTimeout(resolve, 100)); // Give time for topic select to populate
                        selectTopicForQuiz.value = quizConfig.topicId;
                    } else { // mixed
                        // Ensure checkboxes are rendered first by dispatching change on category select
                        // (assuming multiTopicCheckboxes are refreshed when any category for quiz is changed)
                        selectCategoryForQuiz.dispatchEvent(new Event('change'));
                        await new Promise(resolve => setTimeout(resolve, 100)); // Give time for checkboxes to render
                        quizConfig.selectedTopicIds.forEach(topicId => {
                            const checkbox = document.getElementById(`topic-checkbox-${topicId}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }

                    // Clean the URL to remove the config parameter after processing
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.delete('quizConfig');
                    history.replaceState({}, document.title, newUrl.toString());

                    // Automatically start the quiz after applying settings
                    showMessage("Bài kiểm tra đã được tải từ link chia sẻ. Đang bắt đầu...", "success", 2000);
                    setTimeout(startQuiz, 2000); // Give user a moment to see message
                    switchSection('quiz-section'); // Ensure quiz section is active
                } catch (e) {
                    console.error("Lỗi khi tải cấu hình quiz từ URL:", e);
                    showMessage("Lỗi khi tải bài kiểm tra từ link. Vui lòng kiểm tra lại link.", "error");
                }
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppData();
            renderCategoriesList(); // Initial render of topics
            populateCategorySelects(); // Populate all category dropdowns
            switchSection('topics-section'); // Start with the topics section active
            loadQuizConfigFromUrl(); // New: Load quiz config from URL if present
        });

        // Event listeners for the new share link modal
        generateQuizLinkBtn.addEventListener('click', generateShareableLink);
        closeShareLinkModalBtn.addEventListener('click', () => {
            shareLinkModalOverlay.classList.add('hidden');
        });
        shareLinkModalOverlay.addEventListener('click', (e) => {
            if (e.target === shareLinkModalOverlay) { // Clicked outside the content
                shareLinkModalOverlay.classList.add('hidden');
            }
        });
        copyShareLinkBtn.addEventListener('click', () => {
            generatedShareLinkInput.select();
            generatedShareLinkInput.setSelectionRange(0, 99999); // For mobile devices

            navigator.clipboard.writeText(generatedShareLinkInput.value).then(() => {
                copyConfirmation.classList.remove('hidden');
                setTimeout(() => {
                    copyConfirmation.classList.add('hidden');
                }, 2000);
            }).catch(err => {
                console.error('Không thể sao chép link:', err);
                showMessage('Không thể sao chép link. Vui lòng sao chép thủ công.', 'error');
            });
        });

    </script>
</body>
</html>